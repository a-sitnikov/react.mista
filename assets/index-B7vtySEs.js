import{e as Qe,d as J,f as Ze,o as et,i as O,s as F,c as Q,a as Z,b as tt,p as st,g as nt,h as rt,j as ot,F as it,R as at,P as ct,k as lt,l as dt,m as ut,u as ht,n as mt,r as h,q as pt,t as ie,v as t,I as ae,D as xt,w as M,x as fe,y as ee,z as H,A as Ie,N as se,L,B as X,C as R,U as Te,E as gt,H as Le,$ as ft,G as jt,J as vt,K as yt,M as z,O as me,Q as bt,S as wt,T as Me,V as Nt,W as kt,X as W,Y as Tt,Z as Ct,_ as ne,a0 as St,a1 as $t,a2 as Pt,a3 as It,a4 as Lt,a5 as Mt}from"./vendor-DZCeNcII.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const A=(e,s=0)=>{if(!e)return s;if(typeof e=="number")return e;const n=parseInt(e,10);return isNaN(n)?s:n},_t=(e,s)=>e.reduce((n,r)=>{const o=s(r);return n[o]||(n[o]=[]),n[o].push(r),n},{}),Et=e=>{try{return JSON.parse(e)}catch{}try{return e=e.replace(/\\</g,"<").replace(/\\>/g,">").replace(/\\&/g,"&").replace(/\\'/g,"'").replace(/\\"/g,"").replace(/ "/g,' \\"').replace(/""/g,'\\""').replace(/\t/g,"\\t").replace(/"(\.| |\?)/g,'\\"$1'),JSON.parse(e)}catch(s){return console.error(s.message),console.log(e),{}}},_e=e=>e?e==="last20"?"last20":A(e,1):1,je=e=>e===-1||e===void 0?-1:Math.min(Math.ceil(e/100),10)||1,ce=e=>e?e.map(s=>typeof s=="string"?s:s.type==="br"?"<br>":s.type.displayName==="Connect(LinkToPost)"||s.type.displayName==="Connect(t)"?s.props.number:(console.log(s),s)):[""],Rt=e=>new DOMParser().parseFromString(e,"text/html").firstChild.innerText;function Dt(e){return J(e).isSame(new Date,"day")}const Ot=e=>e===2147483648e3?"":Dt(e)?J(e).format("HH:mm"):J(e).format("DD.MM.YY"),Ee=Qe({extend:{theme:{color:["bgHeader","borderOuter","bordeInner","bgColor","bgHover","link","linkHover"]}}}),te=(e,s)=>{if(!s)return"";let n=new URLSearchParams;for(let o in s){const i=s[o];i!==void 0&&n.append(o,i)}let r=n.toString();return r.length>0?e+r:""},Re=async(e,s,n)=>{let r=`${C}/${e}${te("?",s)}`,i=await(await Ze(r)).json(),a;if(typeof i=="string")try{a=JSON.parse(i)}catch(c){console.log(c),a=Et(i)}else a=i;return a},le=async(e,s,n)=>{let r=`${C}/${e}${te("?",s)}`;return n||(n={mode:"cors",credentials:"same-origin"}),await(await fetch(r,n)).json()};function Ft(e){const{session:s}=e;return{userId:Number(s?.user_id),userName:s?.user_name,userHash:s?.user_hash,lastError:s?.last_error}}async function De(){const e=await Re(Qt);return Ft(e)}const At=async e=>{await fetch(`${C}/${Gt}`,{method:"POST",body:te("",{user_name:e.username,user_password:e.password}),mode:"no-cors",credentials:"include",headers:{Accept:"text/html,application/xhtml+xml,application/xml","Content-Type":"application/x-www-form-urlencoded"},redirect:"follow"})},Vt=async()=>{const e=`${C}/${Xt}`;await fetch(e,{mode:"no-cors",credentials:"include"})},Ht=async e=>{const s=es.replace(":id",e.topic_id),n={method:"POST",body:te("",e),mode:"no-cors",credentials:"include",headers:{Accept:"text/html,application/xhtml+xml,application/xml","Content-Type":"application/x-www-form-urlencoded"},redirect:"follow"};return await fetch(`${C}/${s}`,n)},Ut=async e=>{await fetch(`${C}/${ts}`,{method:"POST",body:te("",e),mode:"no-cors",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"}})};function Bt(e){return{id:e.id,forum:e.forum,code:e.shortn,name:e.fulln}}const zt=async()=>{const s=(await Re(Zt)).map(Bt);return{items:s,tree:_t(s,n=>n.forum)}};function Yt(e){let s=[];return e.voting&&(s=e.voting.map(n=>({text:n.select,count:n.result}))),{id:parseInt(e.id),title:e.text,forum:e.forum,sectionId:e.section,created:parseInt(e.created)*1e3,authorId:e.user_id,author:e.user_name,updated:parseInt(e.updated)*1e3,lastUser:e.updated_name,count:parseInt(e.answers_count),down:e.down,closed:e.closed,deleted:e.deleted,isVoting:e.is_voting===1,voting:s}}async function de(e){const s=await le(Ae,{id:e});return Yt(s)}function Oe(e){return{id:parseInt(e.id),n:parseInt(e.n),user:e.user,userId:parseInt(e.userId),text:e.text,time:parseInt(e.utime)*1e3,vote:e.vote}}async function Fe(e){return(await le(ve,e)).map(Oe)}async function ue(e,s){const n=s===0?s+1:s;return(await le(ve,{id:e,from:s,to:n})).map(Oe).find(o=>o.n===s)}const Kt=et({id:O(),forum:F(),sect1:F(),sect2:F(),v8:F().nullable().optional(),closed:O(),down:O(),paid:O(),text:F(),message:F(),created:O(),utime:O(),user:F().nullable().optional(),user0:F(),is_voting:O(),answ:O()}).transform(e=>({id:e.id,forum:e.forum,section:e.sect1,sectionCode:e.sect2,author:e.user0,lastUser:e.user,created:e.created*1e3,updated:e.utime*1e3,count:e.answ,text:e.text,closed:e.closed===1,down:e.down===1,pinned:e.utime===2147483648,isVoting:e.is_voting===1})).array();function Wt(e){const s=A(e.page,1),n=A(e.itemsPerPage,20)*s;return{topics:String(n),section_short_name:e.section,forum:e.forum,user_id:e.userId,mytopics:e.myTopics}}async function qt(e){const s=Wt(e),n=A(e?.itemsPerPage,20),r=await le(Jt,s);try{return Kt.parse(r).slice(-n)}catch(o){throw console.log(r),console.log(o),new Error("Ошибка при преобразовании json")}}const q=localStorage.getItem("domain")||"https://forum.mista.ru",C=localStorage.getItem("domain_api")||"https://dev.mista.ru",Jt=localStorage.getItem("urlTopicsList")||"api/topic.php",Ae=localStorage.getItem("urlTopicInfo")||"ajax_gettopic.php",ve=localStorage.getItem("urlTopicMessages")||"api/message.php",Gt=localStorage.getItem("urlLogin")||"users.php?action=do_enter",Xt=localStorage.getItem("urlLogout")||"users.php?action=exit",Qt=localStorage.getItem("urlCookies")||"ajax_cookie.php",Zt=localStorage.getItem("urlSections")||"ajax_getsectionslist.php",es=localStorage.getItem("urlNewMessage")||"topic.php?id=:id&page=1",ts=localStorage.getItem("urlNewTopic")||"index.php";localStorage.getItem("urlAddBookmark");localStorage.getItem("urlSearch");const ss={status:"init",logged:!1},ns=Q("login/check",async()=>await De()),pe=Q("login/login",async(e,{})=>(await At(e),De())),xe=Q("login/logout",async()=>await Vt()),rs=({login:e})=>e?e.status!=="loading":!0,os=()=>(e,s)=>{if(rs(s()))return e(ns())},is=Z({name:"login",initialState:ss,reducers:{},extraReducers:e=>{e.addCase(pe.pending,s=>{s.status="loading",delete s.error}).addCase(pe.fulfilled,(s,{payload:n})=>{s.status="success",s.userId=n.userId,s.userName=n.userName,s.userHash=n.userHash,s.logged=!0,delete s.error}).addCase(pe.rejected,(s,{error:n})=>{s.status="error",s.error=n?.message}).addCase(xe.pending,s=>{s.status="loading",delete s.error}).addCase(xe.fulfilled,s=>{s.status="success",s.logged=!1,delete s.userId,delete s.userName,delete s.userHash,delete s.error}).addCase(xe.rejected,(s,{error:n})=>{s.status="error",s.error=n?.message})}}),{actions:as,reducer:cs}=is,ls={status:"init",section:null,text:"",subject:"",forum:"1C",isVoting:!1},re=Q("newTopic/post",async e=>{let s={message_text:e.text,topic_text:e.subject,target_section:String(e.section),target_forum:e.forum.toLowerCase(),action:"new",rnd:Math.round(Math.random()*1e10),voting:e.isVoting?1:0};if(e.votingItems)for(let n=0;n<e.votingItems.length;n++)s[`section${n+1}`]=e.votingItems[n];await Ut(s)}),ds=({newTopic:e})=>!(!e||e.status==="loading"),us=e=>(s,n)=>{const r=n();if(ds(r))return s(re(e))},Ce=e=>{e.status="init",e.text="",e.subject="",e.forum="",e.isVoting=!1},hs=Z({name:"newTopic",initialState:ls,reducers:{clear:Ce,changeSubject:(e,{payload:s})=>{e.subject=s},changeText:(e,{payload:s})=>{e.text=s},changeSection:(e,{payload:s})=>{e.section=s,e.forum=s?.forum.toLowerCase()},showVoting:(e,{payload:s})=>{e.isVoting=s},setError:(e,{payload:s})=>{e.error=s}},extraReducers:e=>{e.addCase(re.pending,s=>{s.status="loading",delete s.error}).addCase(re.fulfilled,s=>{Ce(s),delete s.error}).addCase(re.rejected,(s,{error:n})=>{s.status="error",s.error=n?.message})}}),{actions:Ve,reducer:ms}=hs,He={voteColors:["#FF1616","#1A861A","#0023FF","#FF6B18","#9B3A6E","#567655","#233345","#CC0000","#00CCCC","#0000CC"],items:{theme:"lightgray",topicsPerPage:"20",autoRefreshTopicsList:"false",autoRefreshTopicsListInterval:"60",autoRefreshTopic:"true",autoRefreshTopicInterval:"60",showTooltips:"true",tooltipDelay:"500",showTooltipOnPostLink:"true",showYoutubeVideoTitle:"true",replaceCatalogMista:"true",fixBrokenLinks:"true"}},ps=Z({name:"options",initialState:He,reducers:{save:(e,{payload:s})=>{for(let n in s){const r=String(s[n]);e.items[n]=r}}}}),{actions:xs,reducer:gs}=ps,fs={items:[]},js=(e,{payload:s})=>{const n=JSON.stringify(s.keys),r=e.items.findIndex(i=>i.hash===n);let o=0;e.items.length&&(o=e.items[e.items.length-1].zIndex+1),r===-1?e.items.push({keys:s.keys,coords:s.coords,hash:n,zIndex:o}):e.items[e.items.length-1].zIndex=o},vs=Z({name:"tooltips",initialState:fs,reducers:{show:js,close:(e,{payload:s})=>{const n=JSON.stringify(s);e.items=e.items.filter(r=>r.hash!==n)},closeAll:e=>{e.items=[]}}}),{actions:ye,reducer:ys}=vs,bs=(e,s)=>{if(s==="last20")return e===-1?[0,1010]:[Math.max(0,e-19),e];const n=A(s,1)-1;return[n*100,n*100+99]},ws=async({topicId:e,page:s,item0:n})=>{let r;try{r=await de(e)}catch(u){console.error(u),r={id:e,title:"",count:-1}}let[o,i]=bs(r.count,s);o===0&&n&&(o=1);let a=await Fe({id:e,from:o,to:i}),c=n;return o===0?c=a.shift():c=await ue(e,0),r.count===0&&a.length>0&&(r.count=a[a.length-1].n),s==="last20"&&a.length>20&&(a=a.slice(-20)),{info:r,item0:c,list:a}},Ns={status:"init",text:""},oe=Q("newMessage/post",async e=>{let s={message_text:e.text,action:"new",topic_id:e.topicId,rnd:Math.round(Math.random()*1e10)};e.voting_select&&(s.voting_select=e.voting_select),await Ht(s)}),ks=Z({name:"newMessage",initialState:Ns,reducers:{changeText:(e,{payload:s})=>{e.text=s}},extraReducers:e=>{e.addCase(oe.pending,s=>{s.status="loading",delete s.error}).addCase(oe.fulfilled,s=>{s.text="",delete s.error}).addCase(oe.rejected,(s,{error:n})=>{s.status="error",s.error=n?.message})}}),{actions:be,reducer:Ts}=ks,Cs={key:"options",storage:ot},Ss=nt({options:rt(Cs,gs),login:cs,tooltips:ys,newTopic:ms,newMessage:Ts}),Ue=tt({reducer:Ss,middleware:e=>e({serializableCheck:{ignoredActions:[it,at,ct,lt,dt,ut]}}),devTools:!1}),$s=st(Ue),Y=()=>mt(),T=ht,K=e=>{const s=Y();return h.useMemo(()=>pt(e,s),[e,s])},Ps=()=>{const[e,s]=h.useState("Яндекс"),[n,r]=h.useState(""),o=h.useCallback(c=>{r(c.target.value)},[]),i=ie(c=>{c.key==="Enter"&&a()}),a=ie(()=>{let c;switch(e){case"Яндекс":c=`https://www.yandex.ru/search/?text=${n}&site=forum.mista.ru`;break;case"Google":c=`https://www.google.ru/search?q=${n}+site:forum.mista.ru`;break}window.open(c),r("")});return t.jsxs(ae,{size:"sm",children:[t.jsxs(xt,{id:"search-engine",title:"",size:"sm",variant:"light",onSelect:s,children:[t.jsx(M.Item,{eventKey:"Яндекс",children:"Яндекс"}),t.jsx(M.Item,{eventKey:"Google",children:"Google"})]}),t.jsx(fe,{type:"text",placeholder:`${e}: поиск`,className:"search-input input",onKeyDown:i,onChange:o,value:n}),t.jsx(ae.Text,{className:"search-button",onClick:a,children:t.jsx("i",{className:"fa fa-search input",style:{zIndex:1e3}})})]})};var V=(e=>(e.Sections="sections",e.TopicsList="topics-list",e.TopicMessages="topic-messages",e.TopicMessageData="topic-message-data",e.UpdateTopicMessages="update-topic-messages",e))(V||{});const Be=e=>ee({queryKey:[V.Sections],queryFn:zt,placeholderData:{items:[],tree:{}},...e}),ze=({searchParams:e},s)=>{const n=T(r=>r.options.items.topicsPerPage);return ee({queryKey:[V.TopicsList,Object.fromEntries(e)],queryFn:async({queryKey:r})=>{const o=r[1];return qt({itemsPerPage:n,...o})},placeholderData:r=>r??[],...s})},G=({topicId:e},s)=>{const[n]=H(),r=n.get("page");return ee({queryKey:[V.TopicMessages,e,r],queryFn:({client:o})=>{const i=we(o,e);return ws({topicId:e,page:r,item0:i?.item0})},placeholderData:o=>o,...s})},Ye=({topicId:e},s)=>{const[n]=H(),r=n.get("page");return ee({queryKey:[V.UpdateTopicMessages,e],queryFn:async({client:o})=>{const i=we(o,e);if(!i)return!0;const a=await Fe({id:e,from:i.info.count+1,to:1050});return a.length===0||o.setQueryData([V.TopicMessages,e,r],c=>({info:{...c.info,count:a.at(-1).n},item0:c.item0,list:[...c.list,...a]})),!0},initialData:!0,refetchOnMount:!1,...s})},we=(e,s)=>{const n=e.getQueriesData({queryKey:[V.TopicMessages,s]});if(n.length!==0)return n[0][1]},Is=({topicId:e,number:s})=>ee({queryKey:[V.TopicMessageData,e,s],queryFn:async({client:n})=>{const r=we(n,e);if(r){if(s===0)return r.item0;{const i=r.list.find(a=>a.n===s);if(i)return i}}const o=await ue(e,s);if(o===void 0)throw new Error(`Сообщение ${s} не найдено`);return o}}),Ls=()=>{const e=Ie(),[s]=H(),n=s.get("forum"),{refetch:r}=ze({searchParams:s},{enabled:!1}),o=c=>{e.pathname==="/"&&s.size===0&&(c.preventDefault(),r())},i=[{name:"1C",link:"/index.php?forum=1C"},{name:"IT",link:"/index.php?forum=IT"},{name:"JOB",link:"/index.php?forum=JOB"},{name:"LIFE",link:"/index.php?forum=LIFE"},{name:"Настройки",link:"/options.php"}],a=[{name:"Wiki",link:"https://wiki.mista.ru"},{name:"Книга знаний",link:"https://kb.mista.ru"}];return t.jsxs(se,{bg:"dark",variant:"dark",expand:"md",fixed:"top",children:[t.jsx(se.Brand,{as:L,to:"/",onClick:o,children:"React.Mista"}),t.jsx(se.Toggle,{"aria-controls":"basic-navbar-nav"}),t.jsxs(se.Collapse,{children:[t.jsxs(X,{className:"me-auto",children:[i.map((c,u)=>t.jsx(X.Item,{children:t.jsx(X.Link,{to:c.link,active:c.name===n,as:L,children:c.name})},"i"+u)),a.map((c,u)=>t.jsx(X.Item,{children:t.jsx(X.Link,{href:c.link,children:c.name})},"e"+u))]}),t.jsx(R,{className:"d-flex",children:t.jsx(Ps,{})})]})]})},I=()=>t.jsx("span",{className:"mx-1 select-none",children:"|"}),Ms=()=>t.jsxs("footer",{className:"flex navbar-footer",children:[t.jsx("a",{href:`${q}/help/rules.html`,children:"Правила"}),t.jsx(I,{}),t.jsx("a",{href:`${q}/help/about.html`,children:"Описание"}),t.jsx(I,{}),t.jsx("a",{href:`${q}/vital/search`,children:"Поиск"}),t.jsx(I,{}),t.jsx("a",{rel:"nofollow",href:`${q}/vital/sections`,children:"Секции"}),t.jsx(I,{}),t.jsx("a",{rel:"nofollow",href:`${C}/rating.php`,children:"Рейтинг"}),t.jsx(I,{}),t.jsx("a",{href:"http://kb.mista.ru",children:"Книга знаний"}),t.jsx(I,{}),t.jsx("a",{href:"http://wiki.mista.ru",children:"Вики-миста (КЗ2)"}),t.jsx(I,{}),t.jsx("a",{href:`${C}/archive.php`,children:"Архив"}),t.jsx(I,{}),t.jsx("a",{href:`${C}/moders.php`,children:"Модераторы"}),t.jsx(I,{}),t.jsx("a",{href:`${C}/users_gallery.php`,children:"Галерея"}),t.jsx(I,{}),t.jsx("a",{href:`${C}/ban_list.php`,children:"Баны"}),t.jsx(I,{}),t.jsx("span",{children:"18+"})]});function _s(e){const s=new Set("if|если|then|тогда|elsif|иначеесли|else|иначе|endif|конецесли|do|цикл|for|для|to|по|each|каждого|in|из|while|пока|enddo|конеццикла|procedure|процедура|endprocedure|конецпроцедуры|function|функция|endfunction|конецфункции|var|перем|export|экспорт|goto|перейти|and|и|or|или|not|не|val|знач|break|прервать|continue|продолжить|return|возврат|try|попытка|except|исключение|endtry|конецпопытки|raise|вызватьисключение|false|ложь|true|истина|undefined|неопределено|null|new|новый|execute|выполнить|асинх|async|ждать|wait".split("|")),n=new Set("():;.,=+-*<>?[]%/".split("")),r="<span class=",o="</span>",i="bg>",a="num>",c="str>",u="com>",d="sp>",v="pr>",w="key>";let m,x,p,g=!1,l="";function k(b){return b.trim()===""}function y(b,P,B){return b.substring(P-1,P-1+B)}function j(b,P){return b.substring(b.length-P)}function S(b){return s.has(b.toLowerCase().trim())}function f(b,P){b===" "||p===P?m=m+b:(x&&(m=m+o,x=!1),m=m+r+P+b,x=!0,p=P)}function U(b){let P=!1,B=!1,_=1,E=!0,$=1;for($=1;$<=b.length;$++){let N=b.charAt($-1);if(g)N==='"'?(f(y(b,_,$-_+1),c),g=!1,l="",E=!0):l=l+N;else if(P)N==="'"?(f(y(b,_,$-_+1),c),P=!1,l="",E=!0):l=l+N;else if(N===" ")k(l)?m=m+" ":(B?(f(l+" ",c),B=!1):S(l.trim())?f(l+" ",w):isNaN(parseInt(l,10))?f(l+" ",i):f(l+" ",a),l=""),E=!0;else if(n.has(N)){if(k(l)||(B?(f(l,c),B=!1,E=N!=="."):E&&S(l)?(f(l,w),E=N!=="."):(isNaN(parseInt(l,10))?f(l,i):f(l,a),E=N!=="."),l=""),N==="."&&p===a){f(N,a);continue}else if(N==="="&&y(b,$-1,1)==="<")p=void 0;else if(N==="/"&&y(b,$+1,1)==="/"){f(j(b,b.length-$+1),u);return}f(N,d)}else if(N==='"'||N==="|")k(l)?(_=$,g=!0):(f(l+N,c),l=""),E=!0;else if(N==="'")k(l)?(_=$,P=!0):(f(l+N,c),l=""),E=!0;else if(N==="#"||N==="&"&&k(m)){f(j(b,b.length-$+1),v),$=b.length;break}else N==="~"?(l=l+N,B=!0):l=l+N}g||P?f(y(b,_,$-_+1),c):k(l)||(S(l)?f(l,w):isNaN(parseInt(l,10))?f(l,i):f(l,a))}g=!1,l="",x=!1,p=void 0,m="";let D=[];for(let b of e.split(`
`)){if(k(b)){D.push("");continue}m="",U(b),x&&!g?(m+="</span>",x=!1,p="",l=""):g||(p="",l=""),D.push(m)}return D.join(`
`)}const Es=e=>{let s=0,n=e.length;for(;s<n&&(e[s]===`
`||e[s]==="\r");)s++;for(;n>s&&(e[n-1]===`
`||e[n-1]==="\r");)n--;return e.substring(s,n)},Rs=e=>{let s=e.replace(/\n<br>/g,`
`).replace(/<br>\n/g,`
`).replace(/\r<br>/g,`
`).replace(/<br>\r/g,`
`).replace(/<br>/g,`
`).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt");return s=Es(s),_s(s)},Ds=({children:e})=>{const[s,n]=h.useState(!0),[r,o]=h.useMemo(()=>{if(!e)return["",0];let c=ce(e).join("");return c=Rs(c),[c,c.split(`
`).length]},[e]),i=()=>{n(c=>!c)};let a={};return s&&o>7?(a.overflow="hidden",a.height="135px"):(a.overflow="auto",a.height="auto"),t.jsxs("div",{style:{marginTop:"5px"},children:[t.jsx("pre",{className:"code-pre",style:a,dangerouslySetInnerHTML:{__html:r}}),o>7&&t.jsx("div",{className:"expand-button-div",children:t.jsx("span",{className:"expand-button-span",onClick:i,children:s?`Показать: ${o} строк`:"Скрыть"})})]})},ge=({topicId:e,number:s,children:n,className:r})=>{const o=K(ye),[i]=H(),a=A(i.get("id"),-1);let c="";n?c=ce(n).join(""):c=String(s);const[u,d]=h.useState(c);h.useEffect(()=>{let m=!0;if(!c.startsWith("http")){d(c);return}return(async()=>{const{title:p}=await de(e);m&&d(p)})(),()=>{m=!1}},[c,e]);const v=m=>{m.stopPropagation(),w(m)},w=m=>{const x={x:m.pageX,y:m.pageY-50},p={topicId:+e,number:+s};o.show({keys:p,coords:x})};if(e===a||!isNaN(+u))return t.jsx("span",{onClick:v,className:Ee(r,"link"),role:"button",children:u});{const m=je(s);let x="";return m>1&&(x=`&page=${m}`),t.jsxs("span",{children:[t.jsx(L,{to:`/topic.php?id=${e}${x}#${s}`,className:r,children:u})," ","(",t.jsx("span",{onClick:v,className:"link",role:"button",children:s}),")"]})}},Os=({href:e,children:s})=>t.jsx("a",{href:e,className:"registered-user",children:s}),Fs=e=>{let s=e;e.search(/http/)===-1&&(s="http://"+s);try{var n=new URL(s)}catch{return null}return n.hostname.search(/youtube/)!==-1?n.searchParams.get("v"):n.hostname.search(/youtu\.be/)!==-1?n.pathname.substring(1):null},As=async(e,s)=>{let r=`https://www.googleapis.com/youtube/v3/videos?key=${localStorage.getItem("youtubeApiKey")||"AIzaSyCztN2QW4Fxw_1YuAHBTOZdYLbzigPz25g"}&fields=items(snippet(title))&part=snippet&id=${e}`;const i=await(await fetch(r,{signal:s})).json();if(i.items.length===0)return{hrefName:"",title:"",notFound:!0};const a=i.items[0].snippet.title;let c=a,u=50;return a.length>u+5&&(c=c.substring(0,u)+"..."),{hrefName:c,title:a,notFound:!1}},Vs=({href:e})=>{let[s,n]=h.useState(e),[r,o]=h.useState("");return h.useEffect(()=>{const a=new AbortController;return(async()=>{const u=Fs(e);if(u)try{const d=await As(u,a.signal);d.notFound?n(e+" (видео не найдено)"):(n(d.hrefName),o(d.title))}catch(d){console.error("youtube",u,d.message)}})(),()=>a.abort()},[e]),t.jsx("a",{href:e,title:r,children:`youtube: ${s}`})},Hs=(e,s)=>{let n=e.replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\./g,"\\.").replace(/\./g,".").replace(/\*/g,"\\*").replace(/\+/g,"\\+").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/\?/g,"\\?").replace(/\//g,"\\/");try{let r=new RegExp(n+"<\\/a>(\\)|[а-яёА-ЯЁ0-9#\\-\\+\\_\\%\\?=]*)"),o=s.match(r);if(o&&o.length>1)return o[1]===")"&&e.search("\\(")===-1||(e=e+o[1]),e}catch(r){console.error(r)}return e},Us=e=>e.search(/youtube/)!==-1||e.search(/youtu\.be/)!==-1,Bs=e=>e.search(/catalog\.mista/)!==-1,zs=({href:e,children:s,parentText:n,...r})=>{const o=T(d=>d.options.items.showYoutubeVideoTitle==="true"),i=T(d=>d.options.items.replaceCatalogMista==="true"),a=T(d=>d.options.items.fixBrokenLinks==="true");try{var c=new Te(e,!0)}catch(d){return console.error(d.message,e),t.jsx("a",{href:e,children:e})}let u=e;if(u.startsWith("/")&&(c.set("protocol","https"),c.set("hostname","forum.mista.ru"),u=c.href),c.hostname.search(/forum\.mista.ru/)!==-1){if(c.pathname==="/topic.php")return t.jsx(ge,{topicId:c.query.id,number:c.hash.replace("#","")||"0",children:ce(s)});if(c.pathname==="/users.php")return t.jsx(Os,{href:c.href,children:s})}return c.hostname==="a-sitnikov.github.io"&&c.pathname==="/react.mista/"&&Object.keys(c.query).length===0&&(c=new Te(e.replace(/#\//,""),!0),c.pathname==="/react.mista/topic.php")?t.jsx(ge,{topicId:c.query.id,number:c.hash.replace("#","")||"0",children:ce(s)}):o&&Us(c.hostname)?t.jsx(Vs,{href:e}):i&&Bs(c.hostname)?(c.set("hostname","infostart.ru"),t.jsxs("a",{target:r?.target,className:r?.class,rel:r?.rel,href:c.href,children:[c.href," "]})):(a&&n&&(u=Hs(u,n)),t.jsx("a",{target:r?.target,className:r?.class,rel:r?.rel,href:u,children:s}))},Ys=({idx:e,topicId:s,topicDate:n,messageNumber:r})=>{const i=`https://forum.mista.ru/topics/files/${J(n).format("YYYY/MM/DD")}/${s}/${r}`,a=`${i}/${e}_preview.png`,c=`${i}/${e}.png`;return t.jsx(gt,{src:c,children:t.jsx("img",{src:a,alt:"",style:{maxWidth:"100%",cursor:"pointer"}})})},Ks=h.memo(Ys),Ws=(e,s)=>{const n=/(\()(\d+)(\))(?![^<>]*<\/)/gi;return e.replace(n,(r,...o)=>{const i=o[1];return`(<link data-topicid='${s}' data-number='${i}'></link>)`})},qs=e=>e.replace(/\[1[CС]\]/gi,"<code>").replace(/<1[CС]>/gi,"<code>").replace(/\[\/1[CС]\]/gi,"</code>").replace(/<\/1[CС]>/gi,"</code>"),Js=(e,s,n,r)=>{const o=/\[IMG_(\d*)\]/gi;return e.replace(o,(i,...a)=>`<int_img idx='${a[0]}'></int_img>`)},Gs=(e,s,n,r)=>{if(!e)return e;let o=qs(e);return o=Ws(o,s),o=Js(o),o},Xs=Le.Parser(),Qs=Le.ProcessNodeDefinitions(),Zs=()=>!0,en={shouldProcessNode:e=>e?.name==="link",processNode:(e,s,n)=>{const r=e.attribs["data-topicid"],o=e.attribs["data-number"];return t.jsx(ge,{topicId:r,number:o},n)}},tn={shouldProcessNode:e=>e?.name==="code"||e?.name==="pre",processNode:(e,s,n)=>t.jsx(Ds,{children:s},n)},sn=e=>({shouldProcessNode:s=>s?.name==="a",processNode:function(s,n,r){const o=s.attribs.href;return t.jsx(zs,{href:o,parentText:e,children:n},r)}}),nn=(e,s,n)=>({shouldProcessNode:r=>r?.name==="int_img",processNode:function(r,o,i){const a=r.attribs.idx;return t.jsx(Ks,{topicId:e,topicDate:s,messageNumber:n,idx:a},i)}}),rn=({html:e,topicId:s,topicDate:n,messageNumber:r})=>{const o=Gs(e,s),i=[en,tn,sn(o),nn(s,n,r),{shouldProcessNode:()=>!0,processNode:Qs.processDefaultNode}],a=Xs.parseWithInstructions(o,Zs,i);return t.jsx(t.Fragment,{children:a})},on=h.memo(rn),an=h.memo(({colors:e,n:s,text:n})=>t.jsx("div",{style:{marginTop:"5px"},children:t.jsx("b",{children:t.jsx("span",{style:{color:e[s-1]},children:`${s}. ${n}`})})})),cn=({topicId:e,data:s,total:n,n:r,colors:o})=>{const i=`${C}/css/voting${r}.png`,a=n?Math.round(100*s.count/n):0,c={maxWidth:"500px",width:"100%",height:"15px"};return t.jsxs("li",{className:"voting-item",children:[t.jsx("div",{className:"voting-title",children:t.jsx("a",{rel:"nofollow",style:{textDecoration:"none"},href:`#/topic.php?id=${e}&sel=${r}`,children:t.jsx("b",{children:t.jsx("span",{style:{color:o[r-1]},children:`${r}. ${s.text}`})})})}),t.jsx("div",{className:"voting-percentage",children:t.jsx("b",{children:t.jsx("span",{style:{color:o[r-1]},children:`${a}% (${s.count})`})})}),t.jsx("div",{className:"voting-bar",children:t.jsx("div",{style:{width:`${a}%`},children:t.jsx("a",{href:i,children:t.jsx("img",{src:i,style:c,alt:`вариант ${r}`})})})})]})},ln=({items:e,topicId:s,colors:n})=>{let r=Math.max(...e.map(o=>o.count));return t.jsx("ul",{style:{paddingLeft:0},children:e.filter(o=>o.text).map((o,i)=>t.jsx(cn,{data:o,total:r,n:i+1,topicId:s,colors:n},i))})},Ne=({topicId:e,topicDate:s,n,html:r,vote:o,style:i})=>{const{data:a}=G({topicId:e},{enabled:!1,select:x=>x?.info}),c=T(x=>x.options.voteColors);let u=null;o&&a.voting&&e===a.id&&(u=a.voting[o-1].text);const[d,v]=h.useState(u);h.useEffect(()=>{o&&!u&&(async()=>{try{const p=await de(e);v(p.voting[o-1].text)}catch(p){console.error(p.message)}})()},[o,u,e]);const w=n===0&&a?.isVoting&&a?.voting,m=o!==0&&d!==null;return t.jsxs("div",{className:"message",style:i,children:[w&&t.jsx(ln,{items:a.voting,topicId:e,colors:c}),t.jsx("div",{children:t.jsx(ft,{children:t.jsx(on,{html:r,topicId:e,topicDate:s,messageNumber:n})})}),m&&t.jsx(an,{text:d,n:o,colors:c})]})},dn=({data:e})=>{const[s,n]=h.useState("none"),r=()=>{n("inline")},o=()=>{n("none")};return h.useEffect(()=>{n("none")},[e.n]),window.innerWidth<=768?null:t.jsx("img",{src:`${C}/css/user_icons/${e.userId}_16x16.png`,alt:"user ico",onLoad:r,onError:o,style:{display:s,marginBottom:"4px",marginRight:"1px"}})},ke=({data:e,isAuthor:s,isYou:n,isTooltip:r})=>{const o=K(be),i=()=>{o.changeText(`(${e.n})`);let c=document.getElementById("message_text");c&&window.scrollTo(0,c.offsetTop)};let a=h.useMemo(()=>{if(e)return e.n===0?J(e.time).format("DD.MM.YY - HH:mm"):t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"message-number",children:e.n})," - "+J(e.time).format("DD.MM.YY - HH:mm")]})},[e]);return t.jsxs("div",{className:"user-info",children:[t.jsx(dn,{data:e}),t.jsx("a",{className:Ee("registered-user",s&&"is-author px-1 rounded-xs",n&&"is-you px-1 rounded-xs"),href:`${q}/user/${e.userId}`,children:e.user}),r?t.jsx("span",{className:"text-sm ml-2",children:a}):t.jsxs("div",{className:"message-time",children:[t.jsx("span",{className:"ah",children:a}),t.jsx("button",{className:"button ah px-1",onClick:i,children:a})]})]})},Ke=({children:e,onScroll:s})=>{let n=0;const r=i=>{n=i.nativeEvent.changedTouches[0].clientX},o=i=>{if(!s)return;let a=i.nativeEvent.changedTouches[0].clientX;Math.abs(a-n)>100&&s(-a+n)};return t.jsx("div",{className:"tooltip-text",onTouchStart:r,onTouchEnd:o,children:e})},We=({children:e,closeWindow:s})=>t.jsxs("div",{className:"tooltip-header",children:[e,t.jsxs("div",{className:"relative size-[25px] cursor-pointer font-bold ml-auto hover:bg-bgHover rounded-sm flex justify-center items-center",onClick:s,onTouchEnd:s,children:[t.jsx("i",{className:"fa fa-angle-right","aria-hidden":"true"}),t.jsx("i",{className:"fa fa-angle-left","aria-hidden":"true",style:{marginLeft:"-2px"}})]})]}),un=({tooltip:e,zIndex:s,children:n})=>{const r=K(ye),o=()=>{r.close(e.keys)},{coords:i}=e;let a,c;window.innerWidth<=768?(a="y",c={top:i.y,left:5}):(a="both",c={top:i.y,left:Math.min(i.x,window.innerWidth-670)});let[u,d]=h.Children.toArray(n);return t.jsx(jt,{axis:a,handle:".tooltip-header",defaultClassNameDragging:"cursor-grabbing",children:t.jsxs("div",{className:"absolute z-10 border-outer shadow-sm w-[650px] max-w-[97%] bg-bgColor",style:{...c},children:[t.jsx(We,{closeWindow:o,children:u.props.children}),t.jsx(Ke,{children:d.props.children})]})},s)},hn=({tooltip:e})=>{const{keys:s}=e,{data:n,isPending:r,isError:o,error:i}=Is({topicId:s.topicId,number:s.number});return r?null:t.jsxs(un,{tooltip:e,children:[t.jsx(We,{children:o?t.jsx("b",{children:"Ошибка"}):t.jsx(ke,{data:n,isAuthor:!1,isYou:!1,isTooltip:!0})}),t.jsx(Ke,{children:t.jsx(Ne,{n:n?.n,vote:n?.vote,html:o?i.message:n.text,topicId:s.topicId,topicDate:n?.time,style:{maxHeight:"min(550px, 80vh)",overflowY:"auto"}})})]})},mn=()=>{const e=T(o=>o.tooltips.items),s=K(ye),n=h.useRef(null);return vt(n,()=>{s.closeAll()}),t.jsx("div",{ref:n,children:e.map(o=>t.jsx(hn,{tooltip:o},o.hash))})},pn=[{tabName:"Общие",rows:[["theme"],["topicsPerPage"],["autoRefreshTopicsList","autoRefreshTopicsListInterval"],["autoRefreshTopic","autoRefreshTopicInterval"]]},{tabName:"Тултипы",rows:[["showTooltips","tooltipDelay"],["showTooltipOnPostLink"]]},{tabName:"Ссылки",rows:[["showYoutubeVideoTitle"],["replaceCatalogMista"],["fixBrokenLinks"]]}],xn={theme:{type:"radio",label:"Цветовая палитра:",oneLine:!0,values:[{name:"yellow",descr:"Золотая"},{name:"lightgray",descr:"Серая"},{name:"dark",descr:"Темная"}]},topicsPerPage:{type:"number",label:"Тем на странице (max 99):",min:1,max:99},autoRefreshTopicsList:{type:"checkbox",label:"Автообновление списка тем"},autoRefreshTopicsListInterval:{type:"number",label:"",min:60,max:1e6,postfix:"сек"},autoRefreshTopic:{type:"checkbox",label:"Автообновление темы"},autoRefreshTopicInterval:{type:"number",label:"",min:60,max:1e6,postfix:"сек"},showTooltips:{type:"checkbox",label:"Показывать тултипы, задержка",disabled:!0},tooltipDelay:{type:"number",max:1e6,label:"",postfix:"мс",disabled:!0},showTooltipOnPostLink:{type:"checkbox",label:"Показывать тултип ссыки на другую ветку",disabled:!0},showYoutubeVideoTitle:{type:"checkbox",label:"Показывать наименования роликов youtube"},replaceCatalogMista:{type:"checkbox",label:"Обратно заменять catalog.mista.ru на infostart.ru"},fixBrokenLinks:{type:"checkbox",label:"Чинить поломанные ссылки (с русскими символами)"}},gn=({name:e,label:s,value:n,values:r,oneLine:o,onChange:i})=>{const a=c=>{i(c,e,c.target.value)};return t.jsxs("span",{children:[t.jsxs("span",{style:{marginRight:"5px"},children:[" ",s," "]}),o&&t.jsx("br",{}),r.map((c,u)=>t.jsx(R.Check,{type:"radio",id:c.name,label:c.descr,name:s,checked:c.name===n,value:c.name,inline:o,onChange:a},u))]})},fn=({name:e,value:s,label:n,postfix:r,onChange:o})=>{const i=a=>{o(a,e,a.target.value)};return t.jsxs("label",{htmlFor:e,style:{marginRight:"5px"},children:[t.jsx("span",{style:{marginRight:"5px"},children:n}),t.jsx("input",{type:"string",name:e,value:s,onChange:i,className:"input"}),r!==void 0?t.jsx("span",{style:{marginLeft:"5px"},children:r}):null]})},jn=({name:e,children:s})=>t.jsxs("div",{children:[t.jsx("div",{className:"tab-header",children:e}),t.jsx("div",{className:"tab-content",children:s})]}),vn=()=>{const e=Y(),s=yt(),n=T(v=>v.options),[r,o]=h.useState({items:n.items}),i=()=>{s("/#")},a=()=>{o({...r,items:Object.assign({},He.items)})},c=()=>{e(xs.save(r.items)),i()},u=(v,w,m)=>{let x=Object.assign({},r.items);x[w]=m,o({...r,items:x})};let d=[];for(let v of pn){let w=[];for(let m in v.rows){const x=v.rows[m];let p=[];for(let g of x){const l=xn[g];if(!l)continue;const k=r.items[g];l.type==="radio"?p.push(t.jsx(gn,{name:g,label:l.label,values:l.values,value:k,oneLine:l.oneLine,onChange:u},g)):l.type==="number"?(l.label&&p.push(t.jsx("label",{htmlFor:g,style:{fontWeight:"inherit"},children:l.label},g+"_label")),p.push(t.jsxs("div",{className:"options-number",children:[t.jsx(fe,{type:"number",min:l.min,max:l.max,value:k,disabled:l.disabled,onChange:y=>u(y,g,y.target.value),className:"input",size:"sm"}),l.postfix&&t.jsx("span",{style:{marginLeft:"5px",flex:"0 0 auto"},children:l.postfix},g+"_postfix")]},g))):l.type==="string"?p.push(t.jsx(fn,{name:g,label:l.label,postfix:l.postfix,value:k,onChange:u},g)):l.type==="checkbox"&&p.push(t.jsx(R.Check,{id:g,type:"checkbox",label:l.label,name:g,checked:String(k)==="true",disabled:l.disabled,onChange:y=>u(y,g,String(y.target.checked)),style:{flex:"0 0 auto",margin:"0px",maxWidth:"100%"}},g))}w.push(t.jsx("div",{className:"options-row",children:p},m))}d.push(t.jsx(jn,{name:v.tabName,children:w},v.tabName))}return t.jsxs("div",{className:"options-form",children:[t.jsx("div",{className:"options-header",style:{cursor:"default"},children:t.jsx("b",{children:"Настройки"})}),d,t.jsxs("div",{className:"button-row",children:[t.jsx(z,{id:"applyOptions",size:"sm",variant:"light",style:{margin:"5px"},className:"button",onClick:c,children:"OK"}),t.jsx(z,{id:"cancelOptions",size:"sm",variant:"light",style:{margin:"5px",float:"left"},className:"button",onClick:i,children:"Отмена"}),t.jsx(z,{id:"defaultOptions",size:"sm",variant:"light",style:{margin:"5px",float:"right"},className:"button",onClick:a,children:"Сбросить настройки"})]})]})},he=({text:e})=>e?t.jsx("div",{className:"error",dangerouslySetInnerHTML:{__html:e}}):null,qe=({maxPage:e,last20:s})=>{const[n]=H(),r=_e(n.get("page"));let o=[];const i=new URLSearchParams(n);for(let a=1;a<=e;a++)a===1?i.delete("page"):i.set("page",String(a)),o.push(t.jsx(me.Item,{active:r===a,as:L,to:"?"+i.toString(),children:a},a));return s===!0&&(i.set("page","last20"),o.push(t.jsx(me.Item,{active:r==="last20",as:L,to:"?"+i.toString(),children:"»"},"last20"))),t.jsx(me,{style:{margin:"0px"},children:o})},Se=({item:e,topicId:s})=>{const n=T(i=>i.login),{data:r}=G({topicId:s},{enabled:!1}),o=r?.item0?.user||"";return e?t.jsxs("div",{className:"topic-row",id:String(e.n),children:[t.jsx("div",{className:"cell-userinfo",children:t.jsx(ke,{data:e,isAuthor:e.user===o,isYou:e.user===n.userName})}),t.jsx("div",{className:"cell-message",children:t.jsx(Ne,{html:e.text,topicId:s,topicDate:e.time,n:e.n,vote:e.vote})})]}):null},yn=({topicId:e,isLastPage:s})=>{const{isFetching:n,refetch:r}=Ye({topicId:e},{enabled:!1}),o=()=>{};return t.jsxs("div",{className:"flex w-full justify-between",id:"F",children:[t.jsx(z,{onClick:o,disabled:!1,size:"sm",className:"button",variant:"light",children:"Закладка"}),s&&t.jsx(z,{onClick:()=>r(),disabled:n,size:"sm",className:"button",variant:"light",children:n?"Обновляется":"Обновить ветку"})]})},bn=bt.forwardRef(({children:e,onClick:s},n)=>t.jsx("span",{ref:n,style:{cursor:"pointer"},className:"link",onClick:r=>{r.preventDefault(),s(r)},children:e})),wn=({userId:e,userName:s})=>{const n=K(as),r=i=>{i.preventDefault(),n.doLogout()},o=(i,a)=>{i==="exit"&&r(a)};return t.jsx("div",{style:{float:"left"},children:t.jsxs(M,{id:"dropdown-custom-menu",onSelect:o,children:[t.jsx("span",{children:"Привет, "}),t.jsxs(M.Toggle,{as:bn,children:[s," ▼"]}),t.jsxs(M.Menu,{children:[t.jsx(M.Item,{eventKey:"profile",href:`${C}/user/${e}`,children:"Профиль"}),t.jsx(M.Item,{eventKey:"myTopics",href:`#/index.php?user_id=${e}`,children:"Мои темы"}),t.jsx(M.Divider,{}),t.jsx(M.Item,{eventKey:"options",href:"#/options.php",children:"Настройки"}),t.jsx(M.Divider,{}),t.jsx(M.Item,{eventKey:"exit",children:"Выход"})]})]})})},Nn=()=>{Y();const[e,s]=h.useState(""),[n,r]=h.useState("");return t.jsxs("div",{className:"flex",children:[t.jsx("div",{className:"text-link cursor-pointer",children:"Вход"}),t.jsx(I,{}),t.jsx("a",{rel:"nofollow",href:"https://forum.mista.ru/user/registration",target:"_blank",children:"Регистрация"})]})},Je=()=>{const e=Y(),s=T(i=>i.login.logged),n=T(i=>i.login.userId),r=T(i=>i.login.userName),o=T(i=>i.login.error);return h.useEffect(()=>{e(os())},[e]),t.jsxs(t.Fragment,{children:[s?t.jsx(wn,{userId:n,userName:r}):t.jsx(Nn,{}),o&&t.jsx(he,{text:o})]})},kn={"1c":"1С:Предприятие",life:"О жизни",it:"Информационные технологии",job:"Работа"},Tn=({topicId:e})=>{const{data:s}=G({topicId:e},{enabled:!1,select:n=>n?.info.forum});return t.jsxs("div",{className:"flex justify-between gap-2",children:[t.jsx(Je,{}),t.jsx(L,{to:`/index.php?forum=${s}`,style:{textDecoration:"none"},className:"text-lg font-semibold shrink-1 text-end max-md:hidden",children:kn[s]})]})},Cn=({isLastPage:e})=>{const[s,n]=T(i=>[i.options.items.autoRefreshTopic,A(i.options.items.autoRefreshTopicInterval,60)*1e3]),[r,o]=h.useState(!1);return h.useEffect(()=>{s==="true"&&e&&setTimeout(()=>o(!0),n)},[s,n,e]),{enableUpdater:r,refreshInterval:n}},Ge=({placeholder:e,showVoting:s,isVoting:n,isFetching:r,text:o,formRef:i,onChange:a,onShowVotingChange:c})=>{const u=h.useRef(),d=x=>{x.preventDefault();const p=`[1C]
`,g=`
[/1C]`,l=u.current,k=l.selectionStart,y=l.selectionEnd,j=l.value,S=j.length,f=j.substring(k,y),U=p+f+g;let D=j.substring(0,k)+U+j.substring(y,S);a&&a(D)},v=h.useCallback(x=>{c&&c(x.currentTarget.checked)},[c]),w=h.useCallback(x=>{a&&a(x.currentTarget.value)},[a]),m=x=>{i&&i.current&&x.key==="Enter"&&x.ctrlKey&&i.current.dispatchEvent(new Event("submit",{cancelable:!0,bubbles:!0}))};return t.jsxs("div",{children:[t.jsx(fe,{as:"textarea","aria-label":"Сообщение",placeholder:e,cols:70,rows:3,value:o,onChange:w,onKeyUp:m,ref:u,className:"text-editor input","data-lpignore":!0}),t.jsxs("div",{className:"flex-row",children:[t.jsxs(wt,{children:[t.jsx(z,{size:"sm",variant:"light",onClick:d,style:{marginRight:"5px"},className:"button",children:"Код 1С"}),t.jsx(z,{size:"sm",variant:"light",disabled:r,type:"submit",className:"button",children:r?"Отправляется":"Отправить"})]}),s&&t.jsx(R.Check,{id:"show_voting",type:"checkbox",checked:n,onChange:v,label:"Голосование",style:{margin:"auto 0px auto auto"}})]})]})},Sn=({topicId:e,onSubmitSuccess:s})=>{const[n,r]=h.useState(),o=Y(),i=K(be),{data:{info:a}}=G({topicId:e}),c=T(p=>p.newMessage),u=p=>{p.preventDefault(),p.stopPropagation();let g={text:c.text,topicId:String(a?.id),onSuccess:d,voting_select:void 0};n&&(g.voting_select=n),o(oe(g))},d=()=>{i.changeText(""),r(void 0),s&&s()},v=p=>{p.preventDefault(),r(void 0)},w=p=>{r(p)},m=h.useCallback(p=>{o(Ve.changeText(p))},[o]);let x;if(a?.isVoting&&a?.voting){let p=[];for(let g=1;g<=a.voting.length;g++){const l=a.voting[g-1];l.text&&p.push(t.jsx(R.Check,{type:"radio",name:"voting",checked:n===g,onChange:()=>w(g),label:`${g}. ${l.text}`},g))}x=t.jsxs(Me,{children:[t.jsx("legend",{children:t.jsxs("small",{children:["Ваш выбор:",t.jsx("span",{id:"voting_clear",style:{marginLeft:"5px",cursor:"pointer"},onClick:v,children:"очистить"})]})}),p,"Обоснуйте свой выбор!"]})}return t.jsxs("form",{style:{marginTop:"5px"},onSubmit:u,children:[t.jsx("div",{className:"bold",children:"Добавить сообщение в тему:"}),t.jsxs("div",{className:"new-message-container",children:[t.jsx("div",{className:"new-message-text",children:t.jsx(Ge,{isFetching:c.status==="loading",text:c.text,placeholder:"Сообщение",onChange:m})}),t.jsx("div",{className:"new-message-voting",children:x})]})]})},$n=({topicId:e})=>{const{data:s}=G({topicId:e},{select:r=>r?.info.title});let n="https://www.yandex.ru/search/?text="+encodeURIComponent(s);return t.jsxs("div",{className:"topic-row",children:[t.jsx("div",{className:"cell-userinfo",children:t.jsxs("div",{className:"topic-tools",children:[t.jsx("a",{title:"API.info",href:`${C}/${Ae}?id=${e}`,className:"agh",style:{display:"block",lineHeight:"1em"},children:"i"}),t.jsx("a",{title:"API.messages",href:`${C}/${ve}?id=${e}&from=0&to=20`,className:"agh",style:{display:"block",lineHeight:"1em"},children:"m"})]})}),t.jsx("div",{className:"cell-message",children:t.jsxs("div",{className:"flex-row",children:[t.jsxs("div",{style:{flex:1,textAlign:"center"},children:[t.jsx("a",{href:`${q}/topic/${e}`,children:t.jsx("h1",{className:"topic-title",dangerouslySetInnerHTML:{__html:s}})}),t.jsx("div",{className:"moder-action"})]}),t.jsx("div",{style:{flex:"0 0 20px",position:"relative"},children:t.jsx("div",{className:"div-va-middle",children:t.jsx("a",{rel:"noopener noreferrer",href:n,title:"Искать в Яндексе",target:"_blank",className:"yandex",children:"Я"})})})]})})]})},Pn=()=>{const e=Y(),{hash:s}=Ie(),[n]=H(),r=A(n.get("id"),-1),{data:o,error:i,isPending:a}=G({topicId:r}),{info:c,item0:u,list:d=[]}=o??{},v=T(y=>y.login),w=_e(n.get("page")),m=je(c?.count),x=w==="last20"||w===m,{enableUpdater:p,refreshInterval:g}=Cn({isLastPage:x}),{refetch:l}=Ye({topicId:r},{refetchInterval:g,enabled:p}),k=()=>{l(),e(be.changeText(""))};return h.useEffect(()=>{c?.title&&(document.title=Rt(c.title))},[c?.title]),h.useEffect(()=>{if(a||!s)return;const y=document.getElementById(s.slice(1));y&&window.scrollTo(0,y.offsetTop)},[a,s]),t.jsxs("div",{children:[t.jsx(Tn,{topicId:r}),i&&t.jsx(he,{text:i.message}),t.jsxs("div",{className:"topic-table",children:[t.jsx($n,{topicId:r}),t.jsx(Se,{item:u,topicId:r}),d.map(y=>t.jsx(Se,{item:y,topicId:r},y.n)),(m>1||w==="last20")&&t.jsx("div",{className:"table-footer",children:t.jsx(qe,{maxPage:m,last20:!0})})]}),t.jsx(yn,{topicId:r,isLastPage:x}),v.logged&&t.jsx(Sn,{topicId:r,onSubmitSuccess:k})]})},Xe=({id:e,defaultValue:s,selected:n,style:r,size:o,onChange:i})=>{const{data:a}=Be(),c=u=>{if(!i)return;const d=u.currentTarget.value,v=a.items.find(w=>w.code===d);i(u,v)};return t.jsxs(R.Select,{"aria-label":"Секция",onChange:c,value:n,style:r,className:"input",size:o,id:e,children:[t.jsx("option",{value:"",children:s}),Object.keys(a.tree).map(u=>t.jsx("optgroup",{label:u,children:a.tree[u].map(d=>t.jsx("option",{value:d.code,children:d.name},d.id))},u))]})},In=()=>{const[e,s]=H(),n=(r,o)=>{s(i=>{const a=new URLSearchParams(i);return o?a.set("section",o.code):a.delete("section"),a})};return t.jsxs("div",{className:"flex gap-2 w-full items-center justify-between",children:[t.jsx(Je,{}),t.jsx("div",{className:"grow-0 shrink-1 max-md:w-50",children:t.jsx(Xe,{id:"sect",defaultValue:"--Все секции--",selected:e.get("section")??"",onChange:n,size:"sm"})})]})},Ln=({onSubmitSuccess:e})=>{const{data:s}=Be(),n=T(j=>j.newTopic),[r,o]=h.useState(null),[i,a]=h.useState(Array(10).fill("")),c=h.useRef(null),u=Y(),d=K(Ve),v=ie((j,S)=>{o(S),d.changeSection(S)}),w=j=>S=>{let f=i.slice();f[j]=S.target.value,a(f)},m=ie(j=>{if(j.preventDefault(),!r){d.setError("Не выбрана секция");return}let S=n.subject;if(!S){d.setError("Не указана тема");return}if(!n.text){d.setError("Не указано сообщение");return}let f={subject:S,text:n.text,section:r.id,forum:r.forum,isVoting:n.isVoting,votingItems:[],onSuccess:l};if(n.isVoting){f.votingItems=[];for(let U=1;U<=10;U++){let D=i[U-1];D&&f.votingItems.push(D)}}u(us(f))}),x=h.useCallback(j=>{d.changeSubject(j.target.value)},[d]),p=h.useCallback(j=>{d.changeText(j)},[d]),g=h.useCallback(j=>{d.showVoting(j)},[d]),l=()=>{d.clear(),e&&e()};let k=[];for(let j in s.tree)k.push(t.jsx("option",{value:j.toLowerCase(),children:j},j));let y=[];if(n.isVoting){y.push(t.jsx("div",{children:"Варианты:"},"p"));for(let j=1;j<=10;j++)y.push(t.jsxs(ae,{size:"sm",style:{marginBottom:"3px",width:"100%"},children:[t.jsx(ae.Text,{style:{width:"40px"},className:"input",children:`${j}.`}),t.jsx(R.Control,{type:"text","aria-label":`Вариант ${j}`,maxLength:50,className:"input",value:i[j-1],onChange:w(j-1)})]},j))}return t.jsxs("form",{className:"new-topic-container",onSubmit:m,ref:c,children:[t.jsxs("div",{id:"newtopic_form",className:"new-topic-text",children:[t.jsx("div",{children:t.jsx("b",{children:"Новая тема:"})}),n.error&&t.jsx(he,{text:n.error}),t.jsxs("div",{className:"flex-row",style:{marginBottom:"3px"},children:[t.jsx(R.Select,{disabled:!0,size:"sm",value:n.forum,style:{flex:"0 1 90px"},className:"input",children:k}),t.jsx(Xe,{id:"target_section",defaultValue:"Секция",selected:n.section?.code,size:"sm",style:{flex:"1 1 auto"},onChange:v})]}),t.jsx(R.Control,{type:"text","aria-label":"Тема",placeholder:"Тема",size:"sm",value:n.subject,onChange:x,style:{marginBottom:"3px"},className:"input",maxLength:90}),t.jsx(Ge,{placeholder:"Сообщение",showVoting:!0,isVoting:n.isVoting,text:n.text,isFetching:n.status==="loading",onChange:p,onShowVotingChange:g,formRef:c})]}),t.jsx(Me,{className:"new-topic-voting",children:y})]})},Mn=({topicId:e,onFirst:s,onPrev:n,onNext:r,onLast:o,close:i})=>t.jsxs("div",{className:"topic-preview-rewind",children:[t.jsx("div",{className:"topic-preview-button flex-small",onClick:s,title:"К первому",children:t.jsx("i",{className:"fa fa-angle-double-left","aria-hidden":"true"})}),t.jsx("div",{className:"topic-preview-button flex-large",onClick:n,title:"К предыдущему",children:t.jsx("i",{className:"fa fa-angle-left","aria-hidden":"true"})}),t.jsx("div",{className:"topic-preview-button flex-large",onClick:r,title:"К следующему",children:t.jsx("i",{className:"fa fa-angle-right","aria-hidden":"true"})}),t.jsx("div",{className:"topic-preview-button flex-small",onClick:o,title:"К последнему",children:t.jsx("i",{className:"fa fa-angle-double-right","aria-hidden":"true"})}),t.jsxs("div",{className:"topic-preview-button close-preview",onClick:i,children:[t.jsx("i",{className:"fa fa-angle-right","aria-hidden":"true"}),t.jsx("i",{className:"fa fa-angle-left","aria-hidden":"true",style:{marginLeft:"-2px"}})]}),t.jsx("div",{className:"topic-preview-button edit-preview",children:t.jsx(L,{to:`/topic.php?id=${e}&page=last20#F`,children:t.jsx("i",{className:"fa fa-pencil","aria-hidden":"true",style:{color:"var(--font-color)"}})})})]}),$e=({topicId:e,n:s,author:n,loggedUserId:r,onDataLoaded:o})=>{const[i,a]=h.useState(null),[c,u]=h.useState(null);return h.useEffect(()=>{(async()=>{try{const v=await ue(e,s);v?(a(v),u(null),o&&o()):(a(null),u(`Не найдено сообщение ${s}`))}catch(v){a(null),u(v.message)}})()},[e,s,o]),!i&&!c?null:t.jsxs(t.Fragment,{children:[i&&t.jsxs("div",{className:"preview-content",children:[t.jsx("div",{className:"topic-preview-userinfo",children:t.jsx(ke,{data:i,isAuthor:i.user===n,isYou:i.userId===r,isTooltip:!0})}),t.jsx(Ne,{topicId:e,topicDate:i.time,n:s,html:i.text,vote:i.vote,style:{overflowY:"auto",overflowWrap:"break-word"}})]}),c&&t.jsx("span",{children:c})]})},_n=({topicId:e,initialMsgNumber:s,author:n,close:r})=>{const o=T(f=>f.login.userId),[i,a]=h.useState(0),[c,u]=h.useState("none"),[d,v]=h.useState({msgNumber:s,key:0}),w=()=>{v({msgNumber:0,key:d.key})},m=()=>{v({msgNumber:d.msgNumber+1,key:d.key})},x=()=>{d.msgNumber>0&&v({msgNumber:d.msgNumber-1,key:d.key})},p=async()=>{const f=await de(e);v({msgNumber:f.count,key:d.key})},k=Nt({onSwiping:f=>{Math.abs(f.deltaX)<35?a(0):a(f.deltaX)},onSwiped:f=>{Math.abs(f.deltaX)>150&&(f.dir==="Left"?v({msgNumber:d.msgNumber+1,key:d.key+1}):f.dir==="Right"&&d.msgNumber>0&&v({msgNumber:d.msgNumber-1,key:d.key+1})),a(0)},delta:15}),y=h.useCallback(()=>{u("block")},[]);let j=[d.msgNumber];i<0?j.push(d.msgNumber+1):i>0&&d.msgNumber>0&&j.push(d.msgNumber-1);const S={transform:`translate3d(${i}px, 0px, 0px)`,flexDirection:i>0?"row-reverse":"row"};return t.jsx("div",{className:"preview-container",style:{display:c},children:t.jsxs("div",{className:"topic-preview",children:[t.jsx(Mn,{topicId:e,onFirst:w,onLast:p,onNext:m,onPrev:x,close:r}),t.jsxs("div",{className:"preview-carousel",...k,style:S,children:[t.jsx("div",{className:"preview-carousel-item",style:{order:0},children:t.jsx($e,{topicId:e,n:j[0],loggedUserId:o,author:n,onDataLoaded:y})},d.key),j.length>1&&t.jsx("div",{className:"preview-carousel-item",style:{order:1},children:t.jsx($e,{topicId:e,n:j[1],loggedUserId:o,author:n})},d.key+1)]})]})})},En=({item:e})=>t.jsx("div",{className:"cell-author",children:t.jsxs("div",{className:"cell-author--inner",children:[t.jsx("i",{"aria-hidden":"true",className:"fa fa-user-circle",style:{marginRight:"3px"}}),e.author]})}),Rn=({item:e,onClick:s})=>t.jsx("div",{className:"cell-answ",onClick:s,children:t.jsxs("div",{className:"cell-answ--inner",children:[t.jsx("i",{className:"fa fa-comments-o","aria-hidden":"true",style:{marginRight:"3px"}}),t.jsx("span",{children:e.count})]})}),Dn=({item:e})=>t.jsx("div",{className:"cell-forum",children:t.jsx("div",{className:"cell-forum--inner",children:e.forum})}),On=({item:e})=>{const[s,n]=h.useState(e.updated);return h.useEffect(()=>{if(!e.pinned)return;(async()=>{const o=await ue(e.id,e.count);n(o.time)})()},[e.pinned,e.id,e.count]),h.useEffect(()=>{n(e.updated)},[e.updated]),t.jsx("div",{className:"cell-lastuser",children:t.jsxs("div",{className:"cell-author--inner",children:[t.jsx("span",{className:"cell-lastuser-time",children:Ot(s)}),t.jsx("span",{className:"cell-lastuser-user",children:e.lastUser})]})})},Fn=({item:e})=>t.jsx("div",{className:"cell-last20",children:t.jsx(L,{to:`/topic.php?id=${e.id}&page=last20#F`,style:{color:"inherit",display:"block",width:"100%",textAlign:"center"},children:t.jsx("i",{className:"fa fa-angle-right","aria-hidden":"true"})})}),An=({expanded:e,onClick:s})=>t.jsx("div",{className:"cell-preview-link",onClick:s,children:t.jsx("span",{children:e?t.jsx("i",{className:"fa fa-minus-square-o agh","aria-hidden":"true"}):t.jsx("i",{className:"fa fa-plus-square-o agh","aria-hidden":"true"})})}),Vn=({count:e,topicId:s})=>{let n=[];if(e>100){let r=je(e);for(let o=1;o<=r;o++)n.push(t.jsx(L,{className:"agh",style:{margin:"3px"},to:`/topic.php?id=${s}&page=${o}`,children:o>3&&o<r?"•":String(o)},o))}return e>20&&n.push(t.jsx(L,{className:"agh",style:{margin:"3px"},to:`/topic.php?id=${s}&page=last20#F`,children:"»"},"last20")),t.jsx("span",{className:"topic-pages",children:n})},Hn=(e,s,n)=>s==="life"&&!e.startsWith("OFF")?"OFF: "+e:n==="job"&&!e.startsWith("JOB")?"JOB: "+e:n==="v7"&&!e.startsWith("v7")?"v7: "+e:e,Un=({data:e})=>{const s=T(r=>r.login.userName);let n=Hn(e.text,e.forum,e.sectionCode);return t.jsx("div",{className:"cell-title",children:t.jsxs("div",{className:"my-auto",children:[e.pinned&&t.jsx("i",{className:"fa fa-thumb-tack agh","aria-hidden":"true",style:{marginRight:"5px"}}),t.jsx(L,{to:`/topic.php?id=${e.id}`,className:kt("agb","mr5",{bold:e.count>=100,mytopics:e.author===s,pinned:e.pinned}),dangerouslySetInnerHTML:{__html:n},style:{overflowWrap:"anywhere"}}),e.isVoting&&t.jsx("span",{className:"agh mx-1",children:"[±]"}),t.jsx(Vn,{count:e.count,topicId:e.id}),e.closed&&t.jsx("span",{className:"agh",children:"Ø"}),e.down&&t.jsx("span",{className:"agh",children:"↓"}),e.section&&t.jsxs("span",{className:"topic-section",children:[t.jsx("span",{className:"agh",style:{margin:"0px 5px"},children:"/"}),t.jsx(L,{rel:"nofollow",className:"agh",to:`/index.php?section=${e.sectionCode}`,children:e.section},"1")]})]})})},Bn=({item:e,isFetching:s})=>{const[n,r]=h.useState();h.useEffect(()=>{s&&r(void 0)},[s]);const o=()=>{r(n===void 0?0:void 0)},i=()=>{n===void 0||n!==e.count?r(e.count):r(void 0)};return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"topics-list-row",children:[t.jsx(Dn,{item:e}),t.jsx("div",{className:"cell-section",children:e.section}),t.jsx(Rn,{item:e,onClick:i}),t.jsx(An,{expanded:n!==void 0,onClick:o}),t.jsx(Un,{data:e}),t.jsx(En,{item:e}),t.jsx(On,{item:e}),t.jsx(Fn,{item:e})]}),n!==void 0&&t.jsx(_n,{topicId:e.id,initialMsgNumber:n,author:e.author,close:()=>r(void 0)})]})},zn=()=>t.jsxs("div",{className:"topics-list-row text-gray-300",children:[t.jsx("div",{className:"cell-forum",children:t.jsx(W,{as:"div",className:"my-auto w-full min-h-[16px]"})}),t.jsx("div",{className:"cell-section",children:t.jsx("div",{className:"opacity-0",children:"1"})}),t.jsx("div",{className:"cell-answ",children:t.jsx("div",{className:"cell-answ--inner w-full px-[6px]",children:t.jsx(W,{as:"div",className:"my-auto w-full min-h-[16px] max-md:opacity-0!"})})}),t.jsx("div",{className:"cell-preview-link",children:t.jsx("span",{children:t.jsx("i",{className:"fa fa-plus-square-o agh","aria-hidden":"true"})})}),t.jsx("div",{className:"cell-title h-[36px]",children:t.jsx(W,{as:"div",className:"my-auto w-full h-[16px]"})}),t.jsx("div",{className:"cell-author",children:t.jsx("div",{className:"cell-author--inner w-full",children:t.jsx(W,{as:"div",className:"my-auto w-full min-h-[16px] max-md:opacity-0!"})})}),t.jsx("div",{className:"cell-lastuser",children:t.jsx("div",{className:"cell-author--inner w-full",children:t.jsx(W,{as:"div",className:"my-auto w-full min-h-[16px] max-md:opacity-0!"})})}),t.jsx("div",{className:"cell-last20 h-[36px] px-1",children:t.jsx(W,{as:"div",className:"my-auto w-full min-h-[16px]"})})]}),Yn=({isLoading:e,onUpdateClick:s})=>t.jsxs("div",{className:"table-header",children:[t.jsx("div",{style:{letterSpacing:"-1px"},children:"Раздел"}),t.jsx("div",{}),t.jsx("div",{children:"Тема"}),t.jsx("div",{children:"Re"}),t.jsx("div",{children:"Автор"}),t.jsx("div",{children:t.jsx("span",{style:{cursor:"pointer"},title:"Обновить список",onClick:s,children:e?"Обновляется":"Обновлено"})})]}),Pe=()=>{const[e]=H(),{isFetching:s,data:n,error:r,refetch:o}=ze({searchParams:e});return h.useEffect(()=>{document.title="React.Mista"},[]),h.useEffect(()=>{window.scrollTo(0,0)},[e]),t.jsxs("div",{children:[t.jsx(In,{}),r&&t.jsx(he,{text:r.message}),t.jsxs("div",{className:"topic-list-table",children:[t.jsx(Yn,{onUpdateClick:o,isLoading:s}),n.length>0?n.map(i=>t.jsx(Bn,{item:i,isFetching:s},i.id)):Array.from({length:10}).map((i,a)=>t.jsx(zn,{},a)),t.jsx("div",{className:"flex justify-center p-2 border-outer bg-bgHeader",children:t.jsx(qe,{maxPage:10})})]}),t.jsx("div",{id:"F",className:"newtopic",style:{marginBottom:"10px",marginTop:"5px",position:"relative"},children:t.jsx(Ln,{onSubmitSuccess:o})})]})},Kn=()=>t.jsx(Tt,{children:t.jsxs(Ct,{children:[t.jsx(ne,{path:"/",element:t.jsx(Pe,{})}),t.jsx(ne,{path:"/index.php",element:t.jsx(Pe,{})}),t.jsx(ne,{path:"/topic.php",element:t.jsx(Pn,{})}),t.jsx(ne,{path:"/options.php",element:t.jsx(vn,{})})]})}),Wn=()=>{const e=T(s=>s.options.items.theme);return h.useLayoutEffect(()=>{document.body.setAttribute("data-theme",e)},[e]),t.jsxs(St,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:[t.jsx(Ls,{}),t.jsx(Kn,{}),t.jsx(Ms,{}),t.jsx(mn,{})]})},qn=new $t({defaultOptions:{queries:{retry:!1,retryOnMount:!1,refetchOnWindowFocus:!1,throwOnError:e=>(e.name!=="AbortError"&&console.log(e.message),!1)}}}),Jn=({store:e})=>t.jsx(It,{client:qn,children:t.jsx(Lt,{store:e,children:t.jsx(Mt,{loading:null,persistor:$s,children:t.jsx(Wn,{})})})}),Gn=document.getElementById("root"),Xn=Pt.createRoot(Gn);Xn.render(t.jsx(Jn,{store:Ue}));
