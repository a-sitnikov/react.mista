import{d as W,e as Ge,f as Xe,o as Qe,i as O,s as F,c as G,a as X,b as Ze,p as et,g as tt,h as st,j as nt,F as rt,R as ot,P as it,k as at,l as ct,m as lt,u as dt,n as ut,r as h,q as ht,t as re,v as t,I as oe,D as pt,w as M,x as ge,y as Q,z as H,A as $e,N as ee,L,B as J,C as R,U as Ne,E as mt,H as Pe,$ as gt,G as Ie,J as ft,K as xt,M as jt,O as z,Q as ue,S as vt,T as bt,V as Le,W as yt,X as wt,Y as Nt,Z as te,_ as Tt,a0 as kt,a1 as Ct,a2 as St,a3 as $t,a4 as Pt}from"./vendor-DUy1N4g3.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const A=(e,s=0)=>{if(!e)return s;if(typeof e=="number")return e;const n=parseInt(e,10);return isNaN(n)?s:n},It=(e,s)=>e.reduce((n,r)=>{const o=s(r);return n[o]||(n[o]=[]),n[o].push(r),n},{}),Lt=e=>{try{return JSON.parse(e)}catch{}try{return e=e.replace(/\\</g,"<").replace(/\\>/g,">").replace(/\\&/g,"&").replace(/\\'/g,"'").replace(/\\"/g,"").replace(/ "/g,' \\"').replace(/""/g,'\\""').replace(/\t/g,"\\t").replace(/"(\.| |\?)/g,'\\"$1'),JSON.parse(e)}catch(s){return console.error(s.message),console.log(e),{}}},Me=e=>e?e==="last20"?"last20":A(e,1):1,fe=e=>e===-1||e===void 0?-1:Math.min(Math.ceil(e/100),10)||1,ie=e=>e?e.map(s=>typeof s=="string"?s:s.type==="br"?"<br>":s.type.displayName==="Connect(LinkToPost)"||s.type.displayName==="Connect(t)"?s.props.number:(console.log(s),s)):[""],Mt=e=>new DOMParser().parseFromString(e,"text/html").firstChild.innerText;function _t(e){return W(e).isSame(new Date,"day")}const Et=e=>e===2147483648e3?"":_t(e)?W(e).format("HH:mm"):W(e).format("DD.MM.YY"),Rt=Ge({extend:{theme:{color:["bgHeader","borderOuter","bordeInner","bgColor","bgHover","link","linkHover"]}}}),Z=(e,s)=>{if(!s)return"";let n=new URLSearchParams;for(let o in s){const i=s[o];i!==void 0&&n.append(o,i)}let r=n.toString();return r.length>0?e+r:""},_e=async(e,s,n)=>{let r=`${k}/${e}${Z("?",s)}`,i=await(await Xe(r)).json(),a;if(typeof i=="string")try{a=JSON.parse(i)}catch(c){console.log(c),a=Lt(i)}else a=i;return a},ae=async(e,s,n)=>{let r=`${k}/${e}${Z("?",s)}`;return n||(n={mode:"cors",credentials:"same-origin"}),await(await fetch(r,n)).json()};function Dt(e){const{session:s}=e;return{userId:Number(s?.user_id),userName:s?.user_name,userHash:s?.user_hash,lastError:s?.last_error}}async function Ee(){const e=await _e(Gt);return Dt(e)}const Ot=async e=>{await fetch(`${k}/${qt}`,{method:"POST",body:Z("",{user_name:e.username,user_password:e.password}),mode:"no-cors",credentials:"include",headers:{Accept:"text/html,application/xhtml+xml,application/xml","Content-Type":"application/x-www-form-urlencoded"},redirect:"follow"})},Ft=async()=>{const e=`${k}/${Jt}`;await fetch(e,{mode:"no-cors",credentials:"include"})},At=async e=>{const s=Qt.replace(":id",e.topic_id),n={method:"POST",body:Z("",e),mode:"no-cors",credentials:"include",headers:{Accept:"text/html,application/xhtml+xml,application/xml","Content-Type":"application/x-www-form-urlencoded"},redirect:"follow"};return await fetch(`${k}/${s}`,n)},Vt=async e=>{await fetch(`${k}/${Zt}`,{method:"POST",body:Z("",e),mode:"no-cors",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"}})};function Ht(e){return{id:e.id,forum:e.forum,code:e.shortn,name:e.fulln}}const Ut=async()=>{const s=(await _e(Xt)).map(Ht);return{items:s,tree:It(s,n=>n.forum)}};function Bt(e){let s=[];return e.voting&&(s=e.voting.map(n=>({text:n.select,count:n.result}))),{id:parseInt(e.id),title:e.text,forum:e.forum,sectionId:e.section,created:parseInt(e.created)*1e3,authorId:e.user_id,author:e.user_name,updated:parseInt(e.updated)*1e3,lastUser:e.updated_name,count:parseInt(e.answers_count),down:e.down,closed:e.closed,deleted:e.deleted,isVoting:e.is_voting===1,voting:s}}async function ce(e){const s=await ae(Oe,{id:e});return Bt(s)}function Re(e){return{id:parseInt(e.id),n:parseInt(e.n),user:e.user,userId:parseInt(e.userId),text:e.text,time:parseInt(e.utime)*1e3,vote:e.vote}}async function De(e){return(await ae(xe,e)).map(Re)}async function le(e,s){const n=s===0?s+1:s;return(await ae(xe,{id:e,from:s,to:n})).map(Re).find(o=>o.n===s)}const zt=Qe({id:O(),forum:F(),sect1:F(),sect2:F(),v8:F().nullable().optional(),closed:O(),down:O(),paid:O(),text:F(),message:F(),created:O(),utime:O(),user:F().nullable().optional(),user0:F(),is_voting:O(),answ:O()}).transform(e=>({id:e.id,forum:e.forum,section:e.sect1,sectionCode:e.sect2,author:e.user0,lastUser:e.user,created:e.created*1e3,updated:e.utime*1e3,count:e.answ,text:e.text,closed:e.closed===1,down:e.down===1,pinned:e.utime===2147483648,isVoting:e.is_voting===1})).array();function Yt(e){const s=A(e.page,1),n=A(e.itemsPerPage,20)*s;return{topics:String(n),section_short_name:e.section,forum:e.forum,user_id:e.userId,mytopics:e.myTopics}}async function Kt(e){const s=Yt(e),n=A(e?.itemsPerPage,20),r=await ae(Wt,s);try{return zt.parse(r).slice(-n)}catch(o){throw console.log(r),console.log(o),new Error("Ошибка при преобразовании json")}}const k=localStorage.getItem("domain")||"https://dev.mista.ru",Wt=localStorage.getItem("urlTopicsList")||"api/topic.php",Oe=localStorage.getItem("urlTopicInfo")||"ajax_gettopic.php",xe=localStorage.getItem("urlTopicMessages")||"api/message.php",qt=localStorage.getItem("urlLogin")||"users.php?action=do_enter",Jt=localStorage.getItem("urlLogout")||"users.php?action=exit",Gt=localStorage.getItem("urlCookies")||"ajax_cookie.php",Xt=localStorage.getItem("urlSections")||"ajax_getsectionslist.php",Qt=localStorage.getItem("urlNewMessage")||"topic.php?id=:id&page=1",Zt=localStorage.getItem("urlNewTopic")||"index.php";localStorage.getItem("urlAddBookmark");localStorage.getItem("urlSearch");const es={status:"init",logged:!1},ts=G("login/check",async()=>await Ee()),he=G("login/login",async(e,{})=>(await Ot(e),Ee())),pe=G("login/logout",async()=>await Ft()),ss=({login:e})=>e?e.status!=="loading":!0,ns=()=>(e,s)=>{if(ss(s()))return e(ts())},rs=X({name:"login",initialState:es,reducers:{},extraReducers:e=>{e.addCase(he.pending,s=>{s.status="loading",delete s.error}).addCase(he.fulfilled,(s,{payload:n})=>{s.status="success",s.userId=n.userId,s.userName=n.userName,s.userHash=n.userHash,s.logged=!0,delete s.error}).addCase(he.rejected,(s,{error:n})=>{s.status="error",s.error=n?.message}).addCase(pe.pending,s=>{s.status="loading",delete s.error}).addCase(pe.fulfilled,s=>{s.status="success",s.logged=!1,delete s.userId,delete s.userName,delete s.userHash,delete s.error}).addCase(pe.rejected,(s,{error:n})=>{s.status="error",s.error=n?.message})}}),{actions:os,reducer:is}=rs,as={status:"init",section:null,text:"",subject:"",forum:"1C",isVoting:!1},se=G("newTopic/post",async e=>{let s={message_text:e.text,topic_text:e.subject,target_section:String(e.section),target_forum:e.forum.toLowerCase(),action:"new",rnd:Math.round(Math.random()*1e10),voting:e.isVoting?1:0};if(e.votingItems)for(let n=0;n<e.votingItems.length;n++)s[`section${n+1}`]=e.votingItems[n];await Vt(s)}),cs=({newTopic:e})=>!(!e||e.status==="loading"),ls=e=>(s,n)=>{const r=n();if(cs(r))return s(se(e))},Te=e=>{e.status="init",e.text="",e.subject="",e.forum="",e.isVoting=!1},ds=X({name:"newTopic",initialState:as,reducers:{clear:Te,changeSubject:(e,{payload:s})=>{e.subject=s},changeText:(e,{payload:s})=>{e.text=s},changeSection:(e,{payload:s})=>{e.section=s,e.forum=s?.forum.toLowerCase()},showVoting:(e,{payload:s})=>{e.isVoting=s},setError:(e,{payload:s})=>{e.error=s}},extraReducers:e=>{e.addCase(se.pending,s=>{s.status="loading",delete s.error}).addCase(se.fulfilled,s=>{Te(s),delete s.error}).addCase(se.rejected,(s,{error:n})=>{s.status="error",s.error=n?.message})}}),{actions:Fe,reducer:us}=ds,Ae={voteColors:["#FF1616","#1A861A","#0023FF","#FF6B18","#9B3A6E","#567655","#233345","#CC0000","#00CCCC","#0000CC"],items:{theme:"lightgray",topicsPerPage:"20",autoRefreshTopicsList:"false",autoRefreshTopicsListInterval:"60",autoRefreshTopic:"true",autoRefreshTopicInterval:"60",showTooltips:"true",tooltipDelay:"500",showTooltipOnPostLink:"true",showYoutubeVideoTitle:"true",replaceCatalogMista:"true",fixBrokenLinks:"true"}},hs=X({name:"options",initialState:Ae,reducers:{save:(e,{payload:s})=>{for(let n in s){const r=String(s[n]);e.items[n]=r}}}}),{actions:ps,reducer:ms}=hs,gs={items:[]},fs=(e,{payload:s})=>{const n=JSON.stringify(s.keys),r=e.items.findIndex(i=>i.hash===n);let o=0;e.items.length&&(o=e.items[e.items.length-1].zIndex+1),r===-1?e.items.push({keys:s.keys,coords:s.coords,hash:n,zIndex:o}):e.items[e.items.length-1].zIndex=o},xs=X({name:"tooltips",initialState:gs,reducers:{show:fs,close:(e,{payload:s})=>{const n=JSON.stringify(s);e.items=e.items.filter(r=>r.hash!==n)},closeAll:e=>{e.items=[]}}}),{actions:je,reducer:js}=xs,vs=(e,s)=>{if(s==="last20")return e===-1?[0,1010]:[Math.max(0,e-19),e];const n=A(s,1)-1;return[n*100,n*100+99]},bs=async({topicId:e,page:s,item0:n})=>{let r;try{r=await ce(e)}catch(u){console.error(u),r={id:e,title:"",count:-1}}let[o,i]=vs(r.count,s);o===0&&n&&(o=1);let a=await De({id:e,from:o,to:i}),c=n;return o===0?c=a.shift():c=await le(e,0),r.count===0&&a.length>0&&(r.count=a[a.length-1].n),s==="last20"&&a.length>20&&(a=a.slice(-20)),{info:r,item0:c,list:a}},ys={status:"init",text:""},ne=G("newMessage/post",async e=>{let s={message_text:e.text,action:"new",topic_id:e.topicId,rnd:Math.round(Math.random()*1e10)};e.voting_select&&(s.voting_select=e.voting_select),await At(s)}),ws=X({name:"newMessage",initialState:ys,reducers:{changeText:(e,{payload:s})=>{e.text=s}},extraReducers:e=>{e.addCase(ne.pending,s=>{s.status="loading",delete s.error}).addCase(ne.fulfilled,s=>{s.text="",delete s.error}).addCase(ne.rejected,(s,{error:n})=>{s.status="error",s.error=n?.message})}}),{actions:ve,reducer:Ns}=ws,Ts={key:"options",storage:nt},ks=tt({options:st(Ts,ms),login:is,tooltips:js,newTopic:us,newMessage:Ns}),Ve=Ze({reducer:ks,middleware:e=>e({serializableCheck:{ignoredActions:[rt,ot,it,at,ct,lt]}}),devTools:!1}),Cs=et(Ve),Y=()=>ut(),C=dt,K=e=>{const s=Y();return h.useMemo(()=>ht(e,s),[e,s])},Ss=()=>{const[e,s]=h.useState("Яндекс"),[n,r]=h.useState(""),o=h.useCallback(c=>{r(c.target.value)},[]),i=re(c=>{c.key==="Enter"&&a()}),a=re(()=>{let c;switch(e){case"Яндекс":c=`https://www.yandex.ru/search/?text=${n}&site=forum.mista.ru`;break;case"Google":c=`https://www.google.ru/search?q=${n}+site:forum.mista.ru`;break}window.open(c),r("")});return t.jsxs(oe,{size:"sm",children:[t.jsxs(pt,{id:"search-engine",title:"",size:"sm",variant:"light",onSelect:s,children:[t.jsx(M.Item,{eventKey:"Яндекс",children:"Яндекс"}),t.jsx(M.Item,{eventKey:"Google",children:"Google"})]}),t.jsx(ge,{type:"text",placeholder:`${e}: поиск`,className:"search-input input",onKeyDown:i,onChange:o,value:n}),t.jsx(oe.Text,{className:"search-button",onClick:a,children:t.jsx("i",{className:"fa fa-search input",style:{zIndex:1e3}})})]})};var V=(e=>(e.Sections="sections",e.TopicsList="topics-list",e.TopicMessages="topic-messages",e.TopicMessageData="topic-message-data",e.UpdateTopicMessages="update-topic-messages",e))(V||{});const He=e=>Q({queryKey:[V.Sections],queryFn:Ut,placeholderData:{items:[],tree:{}},...e}),Ue=({searchParams:e},s)=>{const n=C(r=>r.options.items.topicsPerPage);return Q({queryKey:[V.TopicsList,Object.fromEntries(e)],queryFn:async({queryKey:r})=>{const o=r[1];return Kt({itemsPerPage:n,...o})},placeholderData:r=>r??[],...s})},q=({topicId:e},s)=>{const[n]=H(),r=n.get("page");return Q({queryKey:[V.TopicMessages,e,r],queryFn:({client:o})=>{const i=be(o,e);return bs({topicId:e,page:r,item0:i?.item0})},placeholderData:o=>o,...s})},Be=({topicId:e},s)=>{const[n]=H(),r=n.get("page");return Q({queryKey:[V.UpdateTopicMessages,e],queryFn:async({client:o})=>{const i=be(o,e);if(!i)return!0;const a=await De({id:e,from:i.info.count+1,to:1050});return a.length===0||o.setQueryData([V.TopicMessages,e,r],c=>({info:{...c.info,count:a.at(-1).n},item0:c.item0,list:[...c.list,...a]})),!0},initialData:!0,refetchOnMount:!1,...s})},be=(e,s)=>{const n=e.getQueriesData({queryKey:[V.TopicMessages,s]});if(n.length!==0)return n[0][1]},$s=({topicId:e,number:s})=>Q({queryKey:[V.TopicMessageData,e,s],queryFn:async({client:n})=>{const r=be(n,e);if(r){if(s===0)return r.item0;{const i=r.list.find(a=>a.n===s);if(i)return i}}const o=await le(e,s);if(o===void 0)throw new Error(`Сообщение ${s} не найдено`);return o}}),Ps=()=>{const e=$e(),[s]=H(),n=s.get("forum"),{refetch:r}=Ue({searchParams:s},{enabled:!1}),o=c=>{e.pathname==="/"&&s.size===0&&(c.preventDefault(),r())},i=[{name:"1C",link:"/index.php?forum=1C"},{name:"IT",link:"/index.php?forum=IT"},{name:"JOB",link:"/index.php?forum=JOB"},{name:"LIFE",link:"/index.php?forum=LIFE"},{name:"Настройки",link:"/options.php"}],a=[{name:"Wiki",link:"https://wiki.mista.ru"},{name:"Книга знаний",link:"https://kb.mista.ru"}];return t.jsxs(ee,{bg:"dark",variant:"dark",expand:"md",fixed:"top",children:[t.jsx(ee.Brand,{as:L,to:"/",onClick:o,children:"React.Mista"}),t.jsx(ee.Toggle,{"aria-controls":"basic-navbar-nav"}),t.jsxs(ee.Collapse,{children:[t.jsxs(J,{className:"me-auto",children:[i.map((c,u)=>t.jsx(J.Item,{children:t.jsx(J.Link,{to:c.link,active:c.name===n,as:L,children:c.name})},"i"+u)),a.map((c,u)=>t.jsx(J.Item,{children:t.jsx(J.Link,{href:c.link,children:c.name})},"e"+u))]}),t.jsx(R,{className:"d-flex",children:t.jsx(Ss,{})})]})]})},I=()=>t.jsx("span",{className:"mx-1 select-none",children:"|"}),Is=()=>t.jsxs("footer",{className:"flex navbar-footer",children:[t.jsx("a",{href:`${k}/rules.php`,children:"Правила"}),t.jsx(I,{}),t.jsx("a",{href:`${k}/about.php`,children:"Описание"}),t.jsx(I,{}),t.jsx("a",{href:`${k}/find.php`,children:"Поиск"}),t.jsx(I,{}),t.jsx("a",{rel:"nofollow",href:`${k}/sections_list.php`,children:"Секции"}),t.jsx(I,{}),t.jsx("a",{rel:"nofollow",href:`${k}/rating.php`,children:"Рейтинг"}),t.jsx(I,{}),t.jsx("a",{href:"http://kb.mista.ru",children:"Книга знаний"}),t.jsx(I,{}),t.jsx("a",{href:"http://wiki.mista.ru",children:"Вики-миста (КЗ2)"}),t.jsx(I,{}),t.jsx("a",{href:`${k}/archive.php`,children:"Архив"}),t.jsx(I,{}),t.jsx("a",{href:`${k}/moders.php`,children:"Модераторы"}),t.jsx(I,{}),t.jsx("a",{href:`${k}/users_gallery.php`,children:"Галерея"}),t.jsx(I,{}),t.jsx("a",{href:`${k}/ban_list.php`,children:"Баны"}),t.jsx(I,{}),t.jsx("span",{children:"18+"})]});function Ls(e){const s=new Set("if|если|then|тогда|elsif|иначеесли|else|иначе|endif|конецесли|do|цикл|for|для|to|по|each|каждого|in|из|while|пока|enddo|конеццикла|procedure|процедура|endprocedure|конецпроцедуры|function|функция|endfunction|конецфункции|var|перем|export|экспорт|goto|перейти|and|и|or|или|not|не|val|знач|break|прервать|continue|продолжить|return|возврат|try|попытка|except|исключение|endtry|конецпопытки|raise|вызватьисключение|false|ложь|true|истина|undefined|неопределено|null|new|новый|execute|выполнить|асинх|async|ждать|wait".split("|")),n=new Set("():;.,=+-*<>?[]%/".split("")),r="<span class=",o="</span>",i="bg>",a="num>",c="str>",u="com>",d="sp>",v="pr>",w="key>";let p,g,m,f=!1,l="";function T(y){return y.trim()===""}function b(y,P,B){return y.substring(P-1,P-1+B)}function j(y,P){return y.substring(y.length-P)}function S(y){return s.has(y.toLowerCase().trim())}function x(y,P){y===" "||m===P?p=p+y:(g&&(p=p+o,g=!1),p=p+r+P+y,g=!0,m=P)}function U(y){let P=!1,B=!1,_=1,E=!0,$=1;for($=1;$<=y.length;$++){let N=y.charAt($-1);if(f)N==='"'?(x(b(y,_,$-_+1),c),f=!1,l="",E=!0):l=l+N;else if(P)N==="'"?(x(b(y,_,$-_+1),c),P=!1,l="",E=!0):l=l+N;else if(N===" ")T(l)?p=p+" ":(B?(x(l+" ",c),B=!1):S(l.trim())?x(l+" ",w):isNaN(parseInt(l,10))?x(l+" ",i):x(l+" ",a),l=""),E=!0;else if(n.has(N)){if(T(l)||(B?(x(l,c),B=!1,E=N!=="."):E&&S(l)?(x(l,w),E=N!=="."):(isNaN(parseInt(l,10))?x(l,i):x(l,a),E=N!=="."),l=""),N==="."&&m===a){x(N,a);continue}else if(N==="="&&b(y,$-1,1)==="<")m=void 0;else if(N==="/"&&b(y,$+1,1)==="/"){x(j(y,y.length-$+1),u);return}x(N,d)}else if(N==='"'||N==="|")T(l)?(_=$,f=!0):(x(l+N,c),l=""),E=!0;else if(N==="'")T(l)?(_=$,P=!0):(x(l+N,c),l=""),E=!0;else if(N==="#"||N==="&"&&T(p)){x(j(y,y.length-$+1),v),$=y.length;break}else N==="~"?(l=l+N,B=!0):l=l+N}f||P?x(b(y,_,$-_+1),c):T(l)||(S(l)?x(l,w):isNaN(parseInt(l,10))?x(l,i):x(l,a))}f=!1,l="",g=!1,m=void 0,p="";let D=[];for(let y of e.split(`
`)){if(T(y)){D.push("");continue}p="",U(y),g&&!f?(p+="</span>",g=!1,m="",l=""):f||(m="",l=""),D.push(p)}return D.join(`
`)}const Ms=e=>{let s=0,n=e.length;for(;s<n&&(e[s]===`
`||e[s]==="\r");)s++;for(;n>s&&(e[n-1]===`
`||e[n-1]==="\r");)n--;return e.substring(s,n)},_s=e=>{let s=e.replace(/\n<br>/g,`
`).replace(/<br>\n/g,`
`).replace(/\r<br>/g,`
`).replace(/<br>\r/g,`
`).replace(/<br>/g,`
`).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt");return s=Ms(s),Ls(s)},Es=({children:e})=>{const[s,n]=h.useState(!0),[r,o]=h.useMemo(()=>{if(!e)return["",0];let c=ie(e).join("");return c=_s(c),[c,c.split(`
`).length]},[e]),i=()=>{n(c=>!c)};let a={};return s&&o>7?(a.overflow="hidden",a.height="135px"):(a.overflow="auto",a.height="auto"),t.jsxs("div",{style:{marginTop:"5px"},children:[t.jsx("pre",{className:"code-pre",style:a,dangerouslySetInnerHTML:{__html:r}}),o>7&&t.jsx("div",{className:"expand-button-div",children:t.jsx("span",{className:"expand-button-span",onClick:i,children:s?`Показать: ${o} строк`:"Скрыть"})})]})},me=({topicId:e,number:s,children:n,className:r})=>{const o=K(je),[i]=H(),a=A(i.get("id"),-1);let c="";n?c=ie(n).join(""):c=String(s);const[u,d]=h.useState(c);h.useEffect(()=>{let p=!0;if(!c.startsWith("http")){d(c);return}return(async()=>{const{title:m}=await ce(e);p&&d(m)})(),()=>{p=!1}},[c,e]);const v=p=>{p.stopPropagation(),w(p)},w=p=>{const g={x:p.pageX,y:p.pageY-50},m={topicId:+e,number:+s};o.show({keys:m,coords:g})};if(e===a||!isNaN(+u))return t.jsx("span",{onClick:v,className:Rt(r,"link"),role:"button",children:u});{const p=fe(s);let g="";return p>1&&(g=`&page=${p}`),t.jsxs("span",{children:[t.jsx(L,{to:`/topic.php?id=${e}${g}#${s}`,className:r,children:u})," ","(",t.jsx("span",{onClick:v,className:"link",role:"button",children:s}),")"]})}},Rs=({href:e,children:s})=>t.jsx("a",{href:e,className:"registered-user",children:s}),Ds=e=>{let s=e;e.search(/http/)===-1&&(s="http://"+s);try{var n=new URL(s)}catch{return null}return n.hostname.search(/youtube/)!==-1?n.searchParams.get("v"):n.hostname.search(/youtu\.be/)!==-1?n.pathname.substring(1):null},Os=async(e,s)=>{let r=`https://www.googleapis.com/youtube/v3/videos?key=${localStorage.getItem("youtubeApiKey")||"AIzaSyCztN2QW4Fxw_1YuAHBTOZdYLbzigPz25g"}&fields=items(snippet(title))&part=snippet&id=${e}`;const i=await(await fetch(r,{signal:s})).json();if(i.items.length===0)return{hrefName:"",title:"",notFound:!0};const a=i.items[0].snippet.title;let c=a,u=50;return a.length>u+5&&(c=c.substring(0,u)+"..."),{hrefName:c,title:a,notFound:!1}},Fs=({href:e})=>{let[s,n]=h.useState(e),[r,o]=h.useState("");return h.useEffect(()=>{const a=new AbortController;return(async()=>{const u=Ds(e);if(u)try{const d=await Os(u,a.signal);d.notFound?n(e+" (видео не найдено)"):(n(d.hrefName),o(d.title))}catch(d){console.error("youtube",u,d.message)}})(),()=>a.abort()},[e]),t.jsx("a",{href:e,title:r,children:`youtube: ${s}`})},As=(e,s)=>{let n=e.replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\./g,"\\.").replace(/\./g,".").replace(/\*/g,"\\*").replace(/\+/g,"\\+").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/\?/g,"\\?").replace(/\//g,"\\/");try{let r=new RegExp(n+"<\\/a>(\\)|[а-яёА-ЯЁ0-9#\\-\\+\\_\\%\\?=]*)"),o=s.match(r);if(o&&o.length>1)return o[1]===")"&&e.search("\\(")===-1||(e=e+o[1]),e}catch(r){console.error(r)}return e},Vs=e=>e.search(/youtube/)!==-1||e.search(/youtu\.be/)!==-1,Hs=e=>e.search(/catalog\.mista/)!==-1,Us=({href:e,children:s,parentText:n,...r})=>{const o=C(d=>d.options.items.showYoutubeVideoTitle==="true"),i=C(d=>d.options.items.replaceCatalogMista==="true"),a=C(d=>d.options.items.fixBrokenLinks==="true");try{var c=new Ne(e,!0)}catch(d){return console.error(d.message,e),t.jsx("a",{href:e,children:e})}let u=e;if(u.startsWith("/")&&(c.set("protocol","https"),c.set("hostname","forum.mista.ru"),u=c.href),c.hostname.search(/forum\.mista.ru/)!==-1){if(c.pathname==="/topic.php")return t.jsx(me,{topicId:c.query.id,number:c.hash.replace("#","")||"0",children:ie(s)});if(c.pathname==="/users.php")return t.jsx(Rs,{href:c.href,children:s})}return c.hostname==="a-sitnikov.github.io"&&c.pathname==="/react.mista/"&&Object.keys(c.query).length===0&&(c=new Ne(e.replace(/#\//,""),!0),c.pathname==="/react.mista/topic.php")?t.jsx(me,{topicId:c.query.id,number:c.hash.replace("#","")||"0",children:ie(s)}):o&&Vs(c.hostname)?t.jsx(Fs,{href:e}):i&&Hs(c.hostname)?(c.set("hostname","infostart.ru"),t.jsxs("a",{target:r?.target,className:r?.class,rel:r?.rel,href:c.href,children:[c.href," "]})):(a&&n&&(u=As(u,n)),t.jsx("a",{target:r?.target,className:r?.class,rel:r?.rel,href:u,children:s}))},Bs=({idx:e,topicId:s,topicDate:n,messageNumber:r})=>{const i=`https://forum.mista.ru/topics/files/${W(n).format("YYYY/MM/DD")}/${s}/${r}`,a=`${i}/${e}_preview.png`,c=`${i}/${e}.png`;return t.jsx(mt,{src:c,children:t.jsx("img",{src:a,alt:"",style:{maxWidth:"100%",cursor:"pointer"}})})},zs=h.memo(Bs),Ys=(e,s)=>{const n=/(\()(\d+)(\))(?![^<>]*<\/)/gi;return e.replace(n,(r,...o)=>{const i=o[1];return`(<link data-topicid='${s}' data-number='${i}'></link>)`})},Ks=e=>e.replace(/\[1[CС]\]/gi,"<code>").replace(/<1[CС]>/gi,"<code>").replace(/\[\/1[CС]\]/gi,"</code>").replace(/<\/1[CС]>/gi,"</code>"),Ws=(e,s,n,r)=>{const o=/\[IMG_(\d*)\]/gi;return e.replace(o,(i,...a)=>`<int_img idx='${a[0]}'></int_img>`)},qs=(e,s,n,r)=>{if(!e)return e;let o=Ks(e);return o=Ys(o,s),o=Ws(o),o},Js=Pe.Parser(),Gs=Pe.ProcessNodeDefinitions(),Xs=()=>!0,Qs={shouldProcessNode:e=>e?.name==="link",processNode:(e,s,n)=>{const r=e.attribs["data-topicid"],o=e.attribs["data-number"];return t.jsx(me,{topicId:r,number:o},n)}},Zs={shouldProcessNode:e=>e?.name==="code"||e?.name==="pre",processNode:(e,s,n)=>t.jsx(Es,{children:s},n)},en=e=>({shouldProcessNode:s=>s?.name==="a",processNode:function(s,n,r){const o=s.attribs.href;return t.jsx(Us,{href:o,parentText:e,children:n},r)}}),tn=(e,s,n)=>({shouldProcessNode:r=>r?.name==="int_img",processNode:function(r,o,i){const a=r.attribs.idx;return t.jsx(zs,{topicId:e,topicDate:s,messageNumber:n,idx:a},i)}}),sn=({html:e,topicId:s,topicDate:n,messageNumber:r})=>{const o=qs(e,s),i=[Qs,Zs,en(o),tn(s,n,r),{shouldProcessNode:()=>!0,processNode:Gs.processDefaultNode}],a=Js.parseWithInstructions(o,Xs,i);return t.jsx(t.Fragment,{children:a})},nn=h.memo(sn),rn=h.memo(({colors:e,n:s,text:n})=>t.jsx("div",{style:{marginTop:"5px"},children:t.jsx("b",{children:t.jsx("span",{style:{color:e[s-1]},children:`${s}. ${n}`})})})),on=({topicId:e,data:s,total:n,n:r,colors:o})=>{const i=`${k}/css/voting${r}.png`,a=n?Math.round(100*s.count/n):0,c={maxWidth:"500px",width:"100%",height:"15px"};return t.jsxs("li",{className:"voting-item",children:[t.jsx("div",{className:"voting-title",children:t.jsx("a",{rel:"nofollow",style:{textDecoration:"none"},href:`#/topic.php?id=${e}&sel=${r}`,children:t.jsx("b",{children:t.jsx("span",{style:{color:o[r-1]},children:`${r}. ${s.text}`})})})}),t.jsx("div",{className:"voting-percentage",children:t.jsx("b",{children:t.jsx("span",{style:{color:o[r-1]},children:`${a}% (${s.count})`})})}),t.jsx("div",{className:"voting-bar",children:t.jsx("div",{style:{width:`${a}%`},children:t.jsx("a",{href:i,children:t.jsx("img",{src:i,style:c,alt:`вариант ${r}`})})})})]})},an=({items:e,topicId:s,colors:n})=>{let r=Math.max(...e.map(o=>o.count));return t.jsx("ul",{style:{paddingLeft:0},children:e.filter(o=>o.text).map((o,i)=>t.jsx(on,{data:o,total:r,n:i+1,topicId:s,colors:n},i))})},ye=({topicId:e,topicDate:s,n,html:r,vote:o,style:i})=>{const{data:a}=q({topicId:e},{enabled:!1,select:g=>g?.info}),c=C(g=>g.options.voteColors);let u=null;o&&a.voting&&e===a.id&&(u=a.voting[o-1].text);const[d,v]=h.useState(u);h.useEffect(()=>{o&&!u&&(async()=>{try{const m=await ce(e);v(m.voting[o-1].text)}catch(m){console.error(m.message)}})()},[o,u,e]);const w=n===0&&a?.isVoting&&a?.voting,p=o!==0&&d!==null;return t.jsxs("div",{className:"message",style:i,children:[w&&t.jsx(an,{items:a.voting,topicId:e,colors:c}),t.jsx("div",{children:t.jsx(gt,{children:t.jsx(nn,{html:r,topicId:e,topicDate:s,messageNumber:n})})}),p&&t.jsx(rn,{text:d,n:o,colors:c})]})},cn=({data:e})=>{const[s,n]=h.useState("none"),r=()=>{n("inline")},o=()=>{n("none")};return h.useEffect(()=>{n("none")},[e.n]),window.innerWidth<=768?null:t.jsx("img",{src:`${k}/css/user_icons/${e.userId}_16x16.png`,alt:"user ico",onLoad:r,onError:o,style:{display:s,marginBottom:"4px",marginRight:"1px"}})},we=({data:e,isAuthor:s,isYou:n,isTooltip:r})=>{const o=K(ve),i=()=>{o.changeText(`(${e.n})`);let u=document.getElementById("message_text");u&&window.scrollTo(0,u.offsetTop)};let a=h.useMemo(()=>{if(e)return e.n===0?W(e.time).format("DD.MM.YY - HH:mm"):t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"message-number",children:e.n})," - "+W(e.time).format("DD.MM.YY - HH:mm")]})},[e]);const c=Ie("registered-user",{"is-author":s,"is-you":n});return t.jsxs("div",{className:"user-info",children:[t.jsx(cn,{data:e}),t.jsx("a",{className:c,href:`${k}/users.php?id=${e.userId}`,children:e.user}),r?t.jsx("div",{className:"ah",style:{display:"inline-block",marginLeft:"5px"},children:a}):t.jsxs("div",{className:"message-time",children:[t.jsx("span",{className:"ah",children:a}),t.jsx("button",{className:"button ah",onClick:i,children:a})]})]})},ze=({children:e,onScroll:s})=>{let n=0;const r=i=>{n=i.nativeEvent.changedTouches[0].clientX},o=i=>{if(!s)return;let a=i.nativeEvent.changedTouches[0].clientX;Math.abs(a-n)>100&&s(-a+n)};return t.jsx("div",{className:"tooltip-text",onTouchStart:r,onTouchEnd:o,children:e})},Ye=({children:e,closeWindow:s})=>t.jsxs("div",{className:"tooltip-header",children:[e,t.jsxs("div",{className:"relative size-[25px] cursor-pointer font-bold ml-auto hover:bg-bgHover rounded-sm flex justify-center items-center",onClick:s,onTouchEnd:s,children:[t.jsx("i",{className:"fa fa-angle-right","aria-hidden":"true"}),t.jsx("i",{className:"fa fa-angle-left","aria-hidden":"true",style:{marginLeft:"-2px"}})]})]}),ln=({tooltip:e,zIndex:s,children:n})=>{const r=K(je),o=()=>{r.close(e.keys)},{coords:i}=e;let a,c;window.innerWidth<=768?(a="y",c={top:i.y,left:5}):(a="both",c={top:i.y,left:Math.min(i.x,window.innerWidth-670)});let[u,d]=h.Children.toArray(n);return t.jsx(ft,{axis:a,handle:".tooltip-header",defaultClassNameDragging:"cursor-grabbing",children:t.jsxs("div",{className:"absolute z-10 border-outer shadow-sm w-[650px] max-w-[97%] bg-bgColor",style:{...c},children:[t.jsx(Ye,{closeWindow:o,children:u.props.children}),t.jsx(ze,{children:d.props.children})]})},s)},dn=({tooltip:e})=>{const{keys:s}=e,{data:n,isPending:r,isError:o,error:i}=$s({topicId:s.topicId,number:s.number});return r?null:t.jsxs(ln,{tooltip:e,children:[t.jsx(Ye,{children:o?t.jsx("b",{children:"Ошибка"}):t.jsx(we,{data:n,isAuthor:!1,isYou:!1,isTooltip:!0})}),t.jsx(ze,{children:t.jsx(ye,{n:n?.n,vote:n?.vote,html:o?i.message:n.text,topicId:s.topicId,topicDate:n?.time,style:{maxHeight:"min(550px, 80vh)",overflowY:"auto"}})})]})},un=()=>{const e=C(o=>o.tooltips.items),s=K(je),n=h.useRef(null);return xt(n,()=>{s.closeAll()}),t.jsx("div",{ref:n,children:e.map(o=>t.jsx(dn,{tooltip:o},o.hash))})},hn=[{tabName:"Общие",rows:[["theme"],["topicsPerPage"],["autoRefreshTopicsList","autoRefreshTopicsListInterval"],["autoRefreshTopic","autoRefreshTopicInterval"]]},{tabName:"Тултипы",rows:[["showTooltips","tooltipDelay"],["showTooltipOnPostLink"]]},{tabName:"Ссылки",rows:[["showYoutubeVideoTitle"],["replaceCatalogMista"],["fixBrokenLinks"]]}],pn={theme:{type:"radio",label:"Цветовая палитра:",oneLine:!0,values:[{name:"yellow",descr:"Золотая"},{name:"lightgray",descr:"Серая"},{name:"dark",descr:"Темная"}]},topicsPerPage:{type:"number",label:"Тем на странице (max 99):",min:1,max:99},autoRefreshTopicsList:{type:"checkbox",label:"Автообновление списка тем"},autoRefreshTopicsListInterval:{type:"number",label:"",min:60,max:1e6,postfix:"сек"},autoRefreshTopic:{type:"checkbox",label:"Автообновление темы"},autoRefreshTopicInterval:{type:"number",label:"",min:60,max:1e6,postfix:"сек"},showTooltips:{type:"checkbox",label:"Показывать тултипы, задержка",disabled:!0},tooltipDelay:{type:"number",max:1e6,label:"",postfix:"мс",disabled:!0},showTooltipOnPostLink:{type:"checkbox",label:"Показывать тултип ссыки на другую ветку",disabled:!0},showYoutubeVideoTitle:{type:"checkbox",label:"Показывать наименования роликов youtube"},replaceCatalogMista:{type:"checkbox",label:"Обратно заменять catalog.mista.ru на infostart.ru"},fixBrokenLinks:{type:"checkbox",label:"Чинить поломанные ссылки (с русскими символами)"}},mn=({name:e,label:s,value:n,values:r,oneLine:o,onChange:i})=>{const a=c=>{i(c,e,c.target.value)};return t.jsxs("span",{children:[t.jsxs("span",{style:{marginRight:"5px"},children:[" ",s," "]}),o&&t.jsx("br",{}),r.map((c,u)=>t.jsx(R.Check,{type:"radio",id:c.name,label:c.descr,name:s,checked:c.name===n,value:c.name,inline:o,onChange:a},u))]})},gn=({name:e,value:s,label:n,postfix:r,onChange:o})=>{const i=a=>{o(a,e,a.target.value)};return t.jsxs("label",{htmlFor:e,style:{marginRight:"5px"},children:[t.jsx("span",{style:{marginRight:"5px"},children:n}),t.jsx("input",{type:"string",name:e,value:s,onChange:i,className:"input"}),r!==void 0?t.jsx("span",{style:{marginLeft:"5px"},children:r}):null]})},fn=({name:e,children:s})=>t.jsxs("div",{children:[t.jsx("div",{className:"tab-header",children:e}),t.jsx("div",{className:"tab-content",children:s})]}),xn=()=>{const e=Y(),s=jt(),n=C(v=>v.options),[r,o]=h.useState({items:n.items}),i=()=>{s("/#")},a=()=>{o({...r,items:Object.assign({},Ae.items)})},c=()=>{e(ps.save(r.items)),i()},u=(v,w,p)=>{let g=Object.assign({},r.items);g[w]=p,o({...r,items:g})};let d=[];for(let v of hn){let w=[];for(let p in v.rows){const g=v.rows[p];let m=[];for(let f of g){const l=pn[f];if(!l)continue;const T=r.items[f];l.type==="radio"?m.push(t.jsx(mn,{name:f,label:l.label,values:l.values,value:T,oneLine:l.oneLine,onChange:u},f)):l.type==="number"?(l.label&&m.push(t.jsx("label",{htmlFor:f,style:{fontWeight:"inherit"},children:l.label},f+"_label")),m.push(t.jsxs("div",{className:"options-number",children:[t.jsx(ge,{type:"number",min:l.min,max:l.max,value:T,disabled:l.disabled,onChange:b=>u(b,f,b.target.value),className:"input",size:"sm"}),l.postfix&&t.jsx("span",{style:{marginLeft:"5px",flex:"0 0 auto"},children:l.postfix},f+"_postfix")]},f))):l.type==="string"?m.push(t.jsx(gn,{name:f,label:l.label,postfix:l.postfix,value:T,onChange:u},f)):l.type==="checkbox"&&m.push(t.jsx(R.Check,{id:f,type:"checkbox",label:l.label,name:f,checked:String(T)==="true",disabled:l.disabled,onChange:b=>u(b,f,String(b.target.checked)),style:{flex:"0 0 auto",margin:"0px",maxWidth:"100%"}},f))}w.push(t.jsx("div",{className:"options-row",children:m},p))}d.push(t.jsx(fn,{name:v.tabName,children:w},v.tabName))}return t.jsxs("div",{className:"options-form",children:[t.jsx("div",{className:"options-header",style:{cursor:"default"},children:t.jsx("b",{children:"Настройки"})}),d,t.jsxs("div",{className:"button-row",children:[t.jsx(z,{id:"applyOptions",size:"sm",variant:"light",style:{margin:"5px"},className:"button",onClick:c,children:"OK"}),t.jsx(z,{id:"cancelOptions",size:"sm",variant:"light",style:{margin:"5px",float:"left"},className:"button",onClick:i,children:"Отмена"}),t.jsx(z,{id:"defaultOptions",size:"sm",variant:"light",style:{margin:"5px",float:"right"},className:"button",onClick:a,children:"Сбросить настройки"})]})]})},de=({text:e})=>e?t.jsx("div",{className:"error",dangerouslySetInnerHTML:{__html:e}}):null,Ke=({maxPage:e,last20:s})=>{const[n]=H(),r=Me(n.get("page"));let o=[];const i=new URLSearchParams(n);for(let a=1;a<=e;a++)a===1?i.delete("page"):i.set("page",String(a)),o.push(t.jsx(ue.Item,{active:r===a,as:L,to:"?"+i.toString(),children:a},a));return s===!0&&(i.set("page","last20"),o.push(t.jsx(ue.Item,{active:r==="last20",as:L,to:"?"+i.toString(),children:"»"},"last20"))),t.jsx(ue,{style:{margin:"0px"},children:o})},ke=({item:e,topicId:s})=>{const n=C(i=>i.login),{data:r}=q({topicId:s},{enabled:!1}),o=r?.item0?.user||"";return e?t.jsxs("div",{className:"topic-row",id:String(e.n),children:[t.jsx("div",{className:"cell-userinfo",children:t.jsx(we,{data:e,isAuthor:e.user===o,isYou:e.user===n.userName})}),t.jsx("div",{className:"cell-message",children:t.jsx(ye,{html:e.text,topicId:s,topicDate:e.time,n:e.n,vote:e.vote})})]}):null},jn=({topicId:e,isLastPage:s})=>{const{isFetching:n,refetch:r}=Be({topicId:e},{enabled:!1}),o=()=>{};return t.jsxs("div",{className:"flex w-full justify-between",id:"F",children:[t.jsx(z,{onClick:o,disabled:!1,size:"sm",className:"button",variant:"light",children:"Закладка"}),s&&t.jsx(z,{onClick:()=>r(),disabled:n,size:"sm",className:"button",variant:"light",children:n?"Обновляется":"Обновить ветку"})]})},vn=vt.forwardRef(({children:e,onClick:s},n)=>t.jsx("span",{ref:n,style:{cursor:"pointer"},className:"link",onClick:r=>{r.preventDefault(),s(r)},children:e})),bn=({userId:e,userName:s})=>{const n=K(os),r=i=>{i.preventDefault(),n.doLogout()},o=(i,a)=>{i==="exit"&&r(a)};return t.jsx("div",{style:{float:"left"},children:t.jsxs(M,{id:"dropdown-custom-menu",onSelect:o,children:[t.jsx("span",{children:"Привет, "}),t.jsxs(M.Toggle,{as:vn,children:[s," ▼"]}),t.jsxs(M.Menu,{children:[t.jsx(M.Item,{eventKey:"profile",href:`${k}/users.php?id=${e}`,children:"Профиль"}),t.jsx(M.Item,{eventKey:"myTopics",href:`#/index.php?user_id=${e}`,children:"Мои темы"}),t.jsx(M.Divider,{}),t.jsx(M.Item,{eventKey:"options",href:"#/options.php",children:"Настройки"}),t.jsx(M.Divider,{}),t.jsx(M.Item,{eventKey:"exit",children:"Выход"})]})]})})},yn=()=>{Y();const[e,s]=h.useState(""),[n,r]=h.useState("");return t.jsxs("div",{className:"flex",children:[t.jsx("div",{className:"text-link cursor-pointer",children:"Вход"}),t.jsx(I,{}),t.jsx("a",{rel:"nofollow",href:"https://forum.mista.ru/user/registration",target:"_blank",children:"Регистрация"})]})},We=()=>{const e=Y(),s=C(i=>i.login.logged),n=C(i=>i.login.userId),r=C(i=>i.login.userName),o=C(i=>i.login.error);return h.useEffect(()=>{e(ns())},[e]),t.jsxs(t.Fragment,{children:[s?t.jsx(bn,{userId:n,userName:r}):t.jsx(yn,{}),o&&t.jsx(de,{text:o})]})},wn={"1c":"1С:Предприятие",life:"О жизни",it:"Информационные технологии",job:"Работа"},Nn=({topicId:e})=>{const{data:s}=q({topicId:e},{enabled:!1,select:n=>n?.info.forum});return t.jsxs("div",{className:"flex justify-between gap-2",children:[t.jsx(We,{}),t.jsx(L,{to:`/index.php?forum=${s}`,style:{textDecoration:"none"},className:"text-lg font-semibold shrink-1 text-end max-md:hidden",children:wn[s]})]})},Tn=({isLastPage:e})=>{const[s,n]=C(i=>[i.options.items.autoRefreshTopic,A(i.options.items.autoRefreshTopicInterval,60)*1e3]),[r,o]=h.useState(!1);return h.useEffect(()=>{s==="true"&&e&&setTimeout(()=>o(!0),n)},[s,n,e]),{enableUpdater:r,refreshInterval:n}},qe=({placeholder:e,showVoting:s,isVoting:n,isFetching:r,text:o,formRef:i,onChange:a,onShowVotingChange:c})=>{const u=h.useRef(),d=g=>{g.preventDefault();const m=`[1C]
`,f=`
[/1C]`,l=u.current,T=l.selectionStart,b=l.selectionEnd,j=l.value,S=j.length,x=j.substring(T,b),U=m+x+f;let D=j.substring(0,T)+U+j.substring(b,S);a&&a(D)},v=h.useCallback(g=>{c&&c(g.currentTarget.checked)},[c]),w=h.useCallback(g=>{a&&a(g.currentTarget.value)},[a]),p=g=>{i&&i.current&&g.key==="Enter"&&g.ctrlKey&&i.current.dispatchEvent(new Event("submit",{cancelable:!0,bubbles:!0}))};return t.jsxs("div",{children:[t.jsx(ge,{as:"textarea","aria-label":"Сообщение",placeholder:e,cols:70,rows:3,value:o,onChange:w,onKeyUp:p,ref:u,className:"text-editor input","data-lpignore":!0}),t.jsxs("div",{className:"flex-row",children:[t.jsxs(bt,{children:[t.jsx(z,{size:"sm",variant:"light",onClick:d,style:{marginRight:"5px"},className:"button",children:"Код 1С"}),t.jsx(z,{size:"sm",variant:"light",disabled:r,type:"submit",className:"button",children:r?"Отправляется":"Отправить"})]}),s&&t.jsx(R.Check,{id:"show_voting",type:"checkbox",checked:n,onChange:v,label:"Голосование",style:{margin:"auto 0px auto auto"}})]})]})},kn=({topicId:e,onSubmitSuccess:s})=>{const[n,r]=h.useState(),o=Y(),i=K(ve),{data:{info:a}}=q({topicId:e}),c=C(m=>m.newMessage),u=m=>{m.preventDefault(),m.stopPropagation();let f={text:c.text,topicId:String(a?.id),onSuccess:d,voting_select:void 0};n&&(f.voting_select=n),o(ne(f))},d=()=>{i.changeText(""),r(void 0),s&&s()},v=m=>{m.preventDefault(),r(void 0)},w=m=>{r(m)},p=h.useCallback(m=>{o(Fe.changeText(m))},[o]);let g;if(a?.isVoting&&a?.voting){let m=[];for(let f=1;f<=a.voting.length;f++){const l=a.voting[f-1];l.text&&m.push(t.jsx(R.Check,{type:"radio",name:"voting",checked:n===f,onChange:()=>w(f),label:`${f}. ${l.text}`},f))}g=t.jsxs(Le,{children:[t.jsx("legend",{children:t.jsxs("small",{children:["Ваш выбор:",t.jsx("span",{id:"voting_clear",style:{marginLeft:"5px",cursor:"pointer"},onClick:v,children:"очистить"})]})}),m,"Обоснуйте свой выбор!"]})}return t.jsxs("form",{style:{marginTop:"5px"},onSubmit:u,children:[t.jsx("div",{className:"bold",children:"Добавить сообщение в тему:"}),t.jsxs("div",{className:"new-message-container",children:[t.jsx("div",{className:"new-message-text",children:t.jsx(qe,{isFetching:c.status==="loading",text:c.text,placeholder:"Сообщение",onChange:p})}),t.jsx("div",{className:"new-message-voting",children:g})]})]})},Cn=({topicId:e})=>{const{data:s}=q({topicId:e},{select:r=>r?.info.title});let n="https://www.yandex.ru/search/?text="+encodeURIComponent(s);return t.jsxs("div",{className:"topic-row",children:[t.jsx("div",{className:"cell-userinfo",children:t.jsxs("div",{className:"topic-tools",children:[t.jsx("a",{title:"API.info",href:`${k}/${Oe}?id=${e}`,className:"agh",style:{display:"block",lineHeight:"1em"},children:"i"}),t.jsx("a",{title:"API.messages",href:`${k}/${xe}?id=${e}&from=0&to=20`,className:"agh",style:{display:"block",lineHeight:"1em"},children:"m"})]})}),t.jsx("div",{className:"cell-message",children:t.jsxs("div",{className:"flex-row",children:[t.jsxs("div",{style:{flex:1,textAlign:"center"},children:[t.jsx("a",{href:`https://forum.mista.ru/topic/${e}`,children:t.jsx("h1",{className:"topic-title",dangerouslySetInnerHTML:{__html:s}})}),t.jsx("div",{className:"moder-action"})]}),t.jsx("div",{style:{flex:"0 0 20px",position:"relative"},children:t.jsx("div",{className:"div-va-middle",children:t.jsx("a",{rel:"noopener noreferrer",href:n,title:"Искать в Яндексе",target:"_blank",className:"yandex",children:"Я"})})})]})})]})},Sn=()=>{const e=Y(),{hash:s}=$e(),[n]=H(),r=A(n.get("id"),-1),{data:o,error:i,isPending:a}=q({topicId:r}),{info:c,item0:u,list:d=[]}=o??{},v=C(b=>b.login),w=Me(n.get("page")),p=fe(c?.count),g=w==="last20"||w===p,{enableUpdater:m,refreshInterval:f}=Tn({isLastPage:g}),{refetch:l}=Be({topicId:r},{refetchInterval:f,enabled:m}),T=()=>{l(),e(ve.changeText(""))};return h.useEffect(()=>{c?.title&&(document.title=Mt(c.title))},[c?.title]),h.useEffect(()=>{if(a||!s)return;const b=document.getElementById(s.slice(1));b&&window.scrollTo(0,b.offsetTop)},[a,s]),t.jsxs("div",{children:[t.jsx(Nn,{topicId:r}),i&&t.jsx(de,{text:i.message}),t.jsxs("div",{className:"topic-table",children:[t.jsx(Cn,{topicId:r}),t.jsx(ke,{item:u,topicId:r}),d.map(b=>t.jsx(ke,{item:b,topicId:r},b.n)),(p>1||w==="last20")&&t.jsx("div",{className:"table-footer",children:t.jsx(Ke,{maxPage:p,last20:!0})})]}),t.jsx(jn,{topicId:r,isLastPage:g}),v.logged&&t.jsx(kn,{topicId:r,onSubmitSuccess:T})]})},Je=({id:e,defaultValue:s,selected:n,style:r,size:o,onChange:i})=>{const{data:a}=He(),c=u=>{if(!i)return;const d=u.currentTarget.value,v=a.items.find(w=>w.code===d);i(u,v)};return t.jsxs(R.Select,{"aria-label":"Секция",onChange:c,value:n,style:r,className:"input",size:o,id:e,children:[t.jsx("option",{value:"",children:s}),Object.keys(a.tree).map(u=>t.jsx("optgroup",{label:u,children:a.tree[u].map(d=>t.jsx("option",{value:d.code,children:d.name},d.id))},u))]})},$n=()=>{const[e,s]=H(),n=(r,o)=>{s(i=>{const a=new URLSearchParams(i);return o?a.set("section",o.code):a.delete("section"),a})};return t.jsxs("div",{className:"flex gap-2 w-full items-center justify-between",children:[t.jsx(We,{}),t.jsx("div",{className:"grow-0 shrink-1 max-md:w-50",children:t.jsx(Je,{id:"sect",defaultValue:"--Все секции--",selected:e.get("section")??"",onChange:n,size:"sm"})})]})},Pn=({onSubmitSuccess:e})=>{const{data:s}=He(),n=C(j=>j.newTopic),[r,o]=h.useState(null),[i,a]=h.useState(Array(10).fill("")),c=h.useRef(null),u=Y(),d=K(Fe),v=re((j,S)=>{o(S),d.changeSection(S)}),w=j=>S=>{let x=i.slice();x[j]=S.target.value,a(x)},p=re(j=>{if(j.preventDefault(),!r){d.setError("Не выбрана секция");return}let S=n.subject;if(!S){d.setError("Не указана тема");return}if(!n.text){d.setError("Не указано сообщение");return}let x={subject:S,text:n.text,section:r.id,forum:r.forum,isVoting:n.isVoting,votingItems:[],onSuccess:l};if(n.isVoting){x.votingItems=[];for(let U=1;U<=10;U++){let D=i[U-1];D&&x.votingItems.push(D)}}u(ls(x))}),g=h.useCallback(j=>{d.changeSubject(j.target.value)},[d]),m=h.useCallback(j=>{d.changeText(j)},[d]),f=h.useCallback(j=>{d.showVoting(j)},[d]),l=()=>{d.clear(),e&&e()};let T=[];for(let j in s.tree)T.push(t.jsx("option",{value:j.toLowerCase(),children:j},j));let b=[];if(n.isVoting){b.push(t.jsx("div",{children:"Варианты:"},"p"));for(let j=1;j<=10;j++)b.push(t.jsxs(oe,{size:"sm",style:{marginBottom:"3px",width:"100%"},children:[t.jsx(oe.Text,{style:{width:"40px"},className:"input",children:`${j}.`}),t.jsx(R.Control,{type:"text","aria-label":`Вариант ${j}`,maxLength:50,className:"input",value:i[j-1],onChange:w(j-1)})]},j))}return t.jsxs("form",{className:"new-topic-container",onSubmit:p,ref:c,children:[t.jsxs("div",{id:"newtopic_form",className:"new-topic-text",children:[t.jsx("div",{children:t.jsx("b",{children:"Новая тема:"})}),n.error&&t.jsx(de,{text:n.error}),t.jsxs("div",{className:"flex-row",style:{marginBottom:"3px"},children:[t.jsx(R.Select,{disabled:!0,size:"sm",value:n.forum,style:{flex:"0 1 90px"},className:"input",children:T}),t.jsx(Je,{id:"target_section",defaultValue:"Секция",selected:n.section?.code,size:"sm",style:{flex:"1 1 auto"},onChange:v})]}),t.jsx(R.Control,{type:"text","aria-label":"Тема",placeholder:"Тема",size:"sm",value:n.subject,onChange:g,style:{marginBottom:"3px"},className:"input",maxLength:90}),t.jsx(qe,{placeholder:"Сообщение",showVoting:!0,isVoting:n.isVoting,text:n.text,isFetching:n.status==="loading",onChange:m,onShowVotingChange:f,formRef:c})]}),t.jsx(Le,{className:"new-topic-voting",children:b})]})},In=({topicId:e,onFirst:s,onPrev:n,onNext:r,onLast:o,close:i})=>t.jsxs("div",{className:"topic-preview-rewind",children:[t.jsx("div",{className:"topic-preview-button flex-small",onClick:s,title:"К первому",children:t.jsx("i",{className:"fa fa-angle-double-left","aria-hidden":"true"})}),t.jsx("div",{className:"topic-preview-button flex-large",onClick:n,title:"К предыдущему",children:t.jsx("i",{className:"fa fa-angle-left","aria-hidden":"true"})}),t.jsx("div",{className:"topic-preview-button flex-large",onClick:r,title:"К следующему",children:t.jsx("i",{className:"fa fa-angle-right","aria-hidden":"true"})}),t.jsx("div",{className:"topic-preview-button flex-small",onClick:o,title:"К последнему",children:t.jsx("i",{className:"fa fa-angle-double-right","aria-hidden":"true"})}),t.jsxs("div",{className:"topic-preview-button close-preview",onClick:i,children:[t.jsx("i",{className:"fa fa-angle-right","aria-hidden":"true"}),t.jsx("i",{className:"fa fa-angle-left","aria-hidden":"true",style:{marginLeft:"-2px"}})]}),t.jsx("div",{className:"topic-preview-button edit-preview",children:t.jsx(L,{to:`/topic.php?id=${e}&page=last20#F`,children:t.jsx("i",{className:"fa fa-pencil","aria-hidden":"true",style:{color:"var(--font-color)"}})})})]}),Ce=({topicId:e,n:s,author:n,loggedUserId:r,onDataLoaded:o})=>{const[i,a]=h.useState(null),[c,u]=h.useState(null);return h.useEffect(()=>{(async()=>{try{const v=await le(e,s);v?(a(v),u(null),o&&o()):(a(null),u(`Не найдено сообщение ${s}`))}catch(v){a(null),u(v.message)}})()},[e,s,o]),!i&&!c?null:t.jsxs(t.Fragment,{children:[i&&t.jsxs("div",{className:"preview-content",children:[t.jsx("div",{className:"topic-preview-userinfo",children:t.jsx(we,{data:i,isAuthor:i.user===n,isYou:i.userId===r,isTooltip:!0})}),t.jsx(ye,{topicId:e,topicDate:i.time,n:s,html:i.text,vote:i.vote,style:{overflowY:"auto",overflowWrap:"break-word"}})]}),c&&t.jsx("span",{children:c})]})},Ln=({topicId:e,initialMsgNumber:s,author:n,close:r})=>{const o=C(x=>x.login.userId),[i,a]=h.useState(0),[c,u]=h.useState("none"),[d,v]=h.useState({msgNumber:s,key:0}),w=()=>{v({msgNumber:0,key:d.key})},p=()=>{v({msgNumber:d.msgNumber+1,key:d.key})},g=()=>{d.msgNumber>0&&v({msgNumber:d.msgNumber-1,key:d.key})},m=async()=>{const x=await ce(e);v({msgNumber:x.count,key:d.key})},T=yt({onSwiping:x=>{Math.abs(x.deltaX)<35?a(0):a(x.deltaX)},onSwiped:x=>{Math.abs(x.deltaX)>150&&(x.dir==="Left"?v({msgNumber:d.msgNumber+1,key:d.key+1}):x.dir==="Right"&&d.msgNumber>0&&v({msgNumber:d.msgNumber-1,key:d.key+1})),a(0)},delta:15}),b=h.useCallback(()=>{u("block")},[]);let j=[d.msgNumber];i<0?j.push(d.msgNumber+1):i>0&&d.msgNumber>0&&j.push(d.msgNumber-1);const S={transform:`translate3d(${i}px, 0px, 0px)`,flexDirection:i>0?"row-reverse":"row"};return t.jsx("div",{className:"preview-container",style:{display:c},children:t.jsxs("div",{className:"topic-preview",children:[t.jsx(In,{topicId:e,onFirst:w,onLast:m,onNext:p,onPrev:g,close:r}),t.jsxs("div",{className:"preview-carousel",...T,style:S,children:[t.jsx("div",{className:"preview-carousel-item",style:{order:0},children:t.jsx(Ce,{topicId:e,n:j[0],loggedUserId:o,author:n,onDataLoaded:b})},d.key),j.length>1&&t.jsx("div",{className:"preview-carousel-item",style:{order:1},children:t.jsx(Ce,{topicId:e,n:j[1],loggedUserId:o,author:n})},d.key+1)]})]})})},Mn=({item:e})=>t.jsx("div",{className:"cell-author",children:t.jsxs("div",{className:"cell-author--inner",children:[t.jsx("i",{"aria-hidden":"true",className:"fa fa-user-circle",style:{marginRight:"3px"}}),e.author]})}),_n=({item:e,onClick:s})=>t.jsx("div",{className:"cell-answ",onClick:s,children:t.jsxs("div",{className:"cell-answ--inner",children:[t.jsx("i",{className:"fa fa-comments-o","aria-hidden":"true",style:{marginRight:"3px"}}),t.jsx("span",{children:e.count})]})}),En=({item:e})=>t.jsx("div",{className:"cell-forum",children:t.jsx("div",{className:"cell-forum--inner",children:e.forum})}),Rn=({item:e})=>{const[s,n]=h.useState(e.updated);return h.useEffect(()=>{if(!e.pinned)return;(async()=>{const o=await le(e.id,e.count);n(o.time)})()},[e.pinned,e.id,e.count]),h.useEffect(()=>{n(e.updated)},[e.updated]),t.jsx("div",{className:"cell-lastuser",children:t.jsxs("div",{className:"cell-author--inner",children:[t.jsx("span",{className:"cell-lastuser-time",children:Et(s)}),t.jsx("span",{className:"cell-lastuser-user",children:e.lastUser})]})})},Dn=({item:e})=>t.jsx("div",{className:"cell-last20",children:t.jsx(L,{to:`/topic.php?id=${e.id}&page=last20#F`,style:{color:"inherit",display:"block",width:"100%",textAlign:"center"},children:t.jsx("i",{className:"fa fa-angle-right","aria-hidden":"true"})})}),On=({expanded:e,onClick:s})=>t.jsx("div",{className:"cell-preview-link",onClick:s,children:t.jsx("span",{children:e?t.jsx("i",{className:"fa fa-minus-square-o agh","aria-hidden":"true"}):t.jsx("i",{className:"fa fa-plus-square-o agh","aria-hidden":"true"})})}),Fn=({count:e,topicId:s})=>{let n=[];if(e>100){let r=fe(e);for(let o=1;o<=r;o++)n.push(t.jsx(L,{className:"agh",style:{margin:"3px"},to:`/topic.php?id=${s}&page=${o}`,children:o>3&&o<r?"•":String(o)},o))}return e>20&&n.push(t.jsx(L,{className:"agh",style:{margin:"3px"},to:`/topic.php?id=${s}&page=last20#F`,children:"»"},"last20")),t.jsx("span",{className:"topic-pages",children:n})},An=(e,s,n)=>s==="life"&&!e.startsWith("OFF")?"OFF: "+e:n==="job"&&!e.startsWith("JOB")?"JOB: "+e:n==="v7"&&!e.startsWith("v7")?"v7: "+e:e,Vn=({data:e})=>{const s=C(r=>r.login.userName);let n=An(e.text,e.forum,e.sectionCode);return t.jsx("div",{className:"cell-title",children:t.jsxs("div",{className:"my-auto",children:[e.pinned&&t.jsx("i",{className:"fa fa-thumb-tack agh","aria-hidden":"true",style:{marginRight:"5px"}}),t.jsx(L,{to:`/topic.php?id=${e.id}`,className:Ie("agb","mr5",{bold:e.count>=100,mytopics:e.author===s,pinned:e.pinned}),dangerouslySetInnerHTML:{__html:n},style:{overflowWrap:"anywhere"}}),e.isVoting&&t.jsx("span",{className:"agh mx-1",children:"[±]"}),t.jsx(Fn,{count:e.count,topicId:e.id}),e.closed&&t.jsx("span",{className:"agh",children:"Ø"}),e.down&&t.jsx("span",{className:"agh",children:"↓"}),e.section&&t.jsxs("span",{className:"topic-section",children:[t.jsx("span",{className:"agh",style:{margin:"0px 5px"},children:"/"}),t.jsx(L,{rel:"nofollow",className:"agh",to:`/index.php?section=${e.sectionCode}`,children:e.section},"1")]})]})})},Hn=({item:e,isFetching:s})=>{const[n,r]=h.useState();h.useEffect(()=>{s&&r(void 0)},[s]);const o=()=>{r(n===void 0?0:void 0)},i=()=>{n===void 0||n!==e.count?r(e.count):r(void 0)};return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"topics-list-row",children:[t.jsx(En,{item:e}),t.jsx("div",{className:"cell-section",children:e.section}),t.jsx(_n,{item:e,onClick:i}),t.jsx(On,{expanded:n!==void 0,onClick:o}),t.jsx(Vn,{data:e}),t.jsx(Mn,{item:e}),t.jsx(Rn,{item:e}),t.jsx(Dn,{item:e})]}),n!==void 0&&t.jsx(Ln,{topicId:e.id,initialMsgNumber:n,author:e.author,close:()=>r(void 0)})]})},Un=({isLoading:e,onUpdateClick:s})=>t.jsxs("div",{className:"table-header",children:[t.jsx("div",{style:{letterSpacing:"-1px"},children:"Раздел"}),t.jsx("div",{}),t.jsx("div",{children:"Тема"}),t.jsx("div",{children:"Re"}),t.jsx("div",{children:"Автор"}),t.jsx("div",{children:t.jsx("span",{style:{cursor:"pointer"},title:"Обновить список",onClick:s,children:e?"Обновляется":"Обновлено"})})]}),Se=()=>{const[e]=H(),{isFetching:s,data:n,error:r,refetch:o}=Ue({searchParams:e});return h.useEffect(()=>{document.title="React.Mista"},[]),h.useEffect(()=>{window.scrollTo(0,0)},[e]),t.jsxs("div",{children:[t.jsx($n,{}),r&&t.jsx(de,{text:r.message}),t.jsxs("div",{className:"topic-list-table",children:[t.jsx(Un,{onUpdateClick:o,isLoading:s}),(n??[]).map(i=>t.jsx(Hn,{item:i,isFetching:s},i.id)),t.jsx("div",{className:"flex justify-center p-2 border-outer bg-bgHeader",children:t.jsx(Ke,{maxPage:10})})]}),t.jsx("div",{id:"F",className:"newtopic",style:{marginBottom:"10px",marginTop:"5px",position:"relative"},children:t.jsx(Pn,{onSubmitSuccess:o})})]})},Bn=()=>t.jsx(wt,{children:t.jsxs(Nt,{children:[t.jsx(te,{path:"/",element:t.jsx(Se,{})}),t.jsx(te,{path:"/index.php",element:t.jsx(Se,{})}),t.jsx(te,{path:"/topic.php",element:t.jsx(Sn,{})}),t.jsx(te,{path:"/options.php",element:t.jsx(xn,{})})]})}),zn=()=>{const e=C(s=>s.options.items.theme);return h.useLayoutEffect(()=>{document.body.setAttribute("data-theme",e)},[e]),t.jsxs(Tt,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:[t.jsx(Ps,{}),t.jsx(Bn,{}),t.jsx(Is,{}),t.jsx(un,{})]})},Yn=new kt({defaultOptions:{queries:{retry:!1,retryOnMount:!1,refetchOnWindowFocus:!1,throwOnError:e=>(e.name!=="AbortError"&&console.log(e.message),!1)}}}),Kn=({store:e})=>t.jsx(St,{client:Yn,children:t.jsx($t,{store:e,children:t.jsx(Pt,{loading:null,persistor:Cs,children:t.jsx(zn,{})})})}),Wn=document.getElementById("root"),qn=Ct.createRoot(Wn);qn.render(t.jsx(Kn,{store:Ve}));
