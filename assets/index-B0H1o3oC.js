import{d as W,f as Ge,o as Xe,i as D,s as O,c as G,a as X,b as Qe,p as Ze,e as et,g as tt,h as st,F as nt,R as rt,P as ot,j as it,k as at,l as ct,u as lt,m as dt,r as h,n as ut,q as oe,t,I as ie,D as ht,v as P,w as J,x as Q,y as B,z as Se,N as ee,L as I,A as q,B as R,U as be,C as pt,H as $e,$ as mt,E as Le,G as gt,J as ft,K as xt,M as F,O as he,Q as jt,S as vt,T as Pe,V as yt,W as wt,X as bt,Y as te,Z as Nt,_ as Tt,a0 as kt,a1 as Ct,a2 as St,a3 as $t}from"./vendor-Dt_fI-DR.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const A=(e,s=0)=>{if(!e)return s;if(typeof e=="number")return e;const n=parseInt(e,10);return isNaN(n)?s:n},Lt=(e,s)=>e.reduce((n,r)=>{const o=s(r);return n[o]||(n[o]=[]),n[o].push(r),n},{}),Pt=e=>{try{return JSON.parse(e)}catch{}try{return e=e.replace(/\\</g,"<").replace(/\\>/g,">").replace(/\\&/g,"&").replace(/\\'/g,"'").replace(/\\"/g,"").replace(/ "/g,' \\"').replace(/""/g,'\\""').replace(/\t/g,"\\t").replace(/"(\.| |\?)/g,'\\"$1'),JSON.parse(e)}catch(s){return console.error(s.message),console.log(e),{}}},Ie=e=>e?e==="last20"?"last20":A(e,1):1,ge=e=>e===-1||e===void 0?-1:Math.min(Math.ceil(e/100),10)||1,ae=e=>e?e.map(s=>typeof s=="string"?s:s.type==="br"?"<br>":s.type.displayName==="Connect(LinkToPost)"||s.type.displayName==="Connect(t)"?s.props.number:(console.log(s),s)):[""],It=e=>new DOMParser().parseFromString(e,"text/html").firstChild.innerText;function Mt(e){return W(e).isSame(new Date,"day")}const _t=e=>e===2147483648e3?"":Mt(e)?W(e).format("HH:mm"):W(e).format("DD.MM.YY"),Z=(e,s)=>{if(!s)return"";let n=new URLSearchParams;for(let o in s){const i=s[o];i!==void 0&&n.append(o,i)}let r=n.toString();return r.length>0?e+r:""},Me=async(e,s,n)=>{let r=`${k}/${e}${Z("?",s)}`,i=await(await Ge(r)).json(),a;if(typeof i=="string")try{a=JSON.parse(i)}catch(c){console.log(c),a=Pt(i)}else a=i;return a},ce=async(e,s,n)=>{let r=`${k}/${e}${Z("?",s)}`;return n||(n={mode:"cors",credentials:"same-origin"}),await(await fetch(r,n)).json()};function Rt(e){const{session:s}=e;return{userId:Number(s?.user_id),userName:s?.user_name,userHash:s?.user_hash,lastError:s?.last_error}}async function _e(){const e=await Me(qt);return Rt(e)}const Et=async e=>{await fetch(`${k}/${Wt}`,{method:"POST",body:Z("",{user_name:e.username,user_password:e.password}),mode:"no-cors",credentials:"include",headers:{Accept:"text/html,application/xhtml+xml,application/xml","Content-Type":"application/x-www-form-urlencoded"},redirect:"follow"})},Dt=async()=>{const e=`${k}/${Kt}`;await fetch(e,{mode:"no-cors",credentials:"include"})},Ot=async e=>{const s=Gt.replace(":id",e.topic_id),n={method:"POST",body:Z("",e),mode:"no-cors",credentials:"include",headers:{Accept:"text/html,application/xhtml+xml,application/xml","Content-Type":"application/x-www-form-urlencoded"},redirect:"follow"};return await fetch(`${k}/${s}`,n)},Ft=async e=>{await fetch(`${k}/${Xt}`,{method:"POST",body:Z("",e),mode:"no-cors",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"}})};function At(e){return{id:e.id,forum:e.forum,code:e.shortn,name:e.fulln}}const Vt=async()=>{const s=(await Me(Jt)).map(At);return{items:s,tree:Lt(s,n=>n.forum)}};function Bt(e){let s=[];return e.voting&&(s=e.voting.map(n=>({text:n.select,count:n.result}))),{id:parseInt(e.id),title:e.text,forum:e.forum,sectionId:e.section,created:parseInt(e.created)*1e3,authorId:e.user_id,author:e.user_name,updated:parseInt(e.updated)*1e3,lastUser:e.updated_name,count:parseInt(e.answers_count),down:e.down,closed:e.closed,deleted:e.deleted,isVoting:e.is_voting===1,voting:s}}async function le(e){const s=await ce(De,{id:e});return Bt(s)}function Re(e){return{id:parseInt(e.id),n:parseInt(e.n),user:e.user,userId:parseInt(e.userId),text:e.text,time:parseInt(e.utime)*1e3,vote:e.vote}}async function Ee(e){return(await ce(fe,e)).map(Re)}async function de(e,s){const n=s===0?s+1:s;return(await ce(fe,{id:e,from:s,to:n})).map(Re).find(o=>o.n===s)}const Ut=Xe({id:D(),forum:O(),sect1:O(),sect2:O(),v8:O().nullable().optional(),closed:D(),down:D(),paid:D(),text:O(),message:O(),created:D(),utime:D(),user:O().nullable().optional(),user0:O(),is_voting:D(),answ:D()}).transform(e=>({id:e.id,forum:e.forum,section:e.sect1,sectionCode:e.sect2,author:e.user0,lastUser:e.user,created:e.created*1e3,updated:e.utime*1e3,count:e.answ,text:e.text,closed:e.closed===1,down:e.down===1,pinned:e.utime===2147483648,isVoting:e.is_voting===1})).array();function Ht(e){const s=A(e.page,1),n=A(e.itemsPerPage,20)*s;return{topics:String(n),section_short_name:e.section,forum:e.forum,user_id:e.userId,mytopics:e.myTopics}}async function zt(e){const s=Ht(e),n=A(e?.itemsPerPage,20),r=await ce(Yt,s);try{return Ut.parse(r).slice(-n)}catch(o){throw console.log(r),console.log(o),new Error("Ошибка при преобразовании json")}}const k=localStorage.getItem("domain")||"https://dev.mista.ru",Yt=localStorage.getItem("urlTopicsList")||"api/topic.php",De=localStorage.getItem("urlTopicInfo")||"ajax_gettopic.php",fe=localStorage.getItem("urlTopicMessages")||"api/message.php",Wt=localStorage.getItem("urlLogin")||"users.php?action=do_enter",Kt=localStorage.getItem("urlLogout")||"users.php?action=exit",qt=localStorage.getItem("urlCookies")||"ajax_cookie.php",Jt=localStorage.getItem("urlSections")||"ajax_getsectionslist.php",Gt=localStorage.getItem("urlNewMessage")||"topic.php?id=:id&page=1",Xt=localStorage.getItem("urlNewTopic")||"index.php";localStorage.getItem("urlAddBookmark");localStorage.getItem("urlSearch");const Qt={status:"init",logged:!1},Zt=G("login/check",async()=>await _e()),se=G("login/login",async(e,{})=>(await Et(e),_e())),pe=G("login/logout",async()=>await Dt()),Oe=({login:e})=>e?e.status!=="loading":!0,es=(e,s)=>(n,r)=>{if(Oe(r()))return n(se({username:e,password:s}))},ts=()=>(e,s)=>{if(Oe(s()))return e(Zt())},ss=X({name:"login",initialState:Qt,reducers:{},extraReducers:e=>{e.addCase(se.pending,s=>{s.status="loading",delete s.error}).addCase(se.fulfilled,(s,{payload:n})=>{s.status="success",s.userId=n.userId,s.userName=n.userName,s.userHash=n.userHash,s.logged=!0,delete s.error}).addCase(se.rejected,(s,{error:n})=>{s.status="error",s.error=n?.message}).addCase(pe.pending,s=>{s.status="loading",delete s.error}).addCase(pe.fulfilled,s=>{s.status="success",s.logged=!1,delete s.userId,delete s.userName,delete s.userHash,delete s.error}).addCase(pe.rejected,(s,{error:n})=>{s.status="error",s.error=n?.message})}}),{actions:ns,reducer:rs}=ss,os={status:"init",section:null,text:"",subject:"",forum:"1C",isVoting:!1},ne=G("newTopic/post",async e=>{let s={message_text:e.text,topic_text:e.subject,target_section:String(e.section),target_forum:e.forum.toLowerCase(),action:"new",rnd:Math.round(Math.random()*1e10),voting:e.isVoting?1:0};if(e.votingItems)for(let n=0;n<e.votingItems.length;n++)s[`section${n+1}`]=e.votingItems[n];await Ft(s)}),is=({newTopic:e})=>!(!e||e.status==="loading"),as=e=>(s,n)=>{const r=n();if(is(r))return s(ne(e))},Ne=e=>{e.status="init",e.text="",e.subject="",e.forum="",e.isVoting=!1},cs=X({name:"newTopic",initialState:os,reducers:{clear:Ne,changeSubject:(e,{payload:s})=>{e.subject=s},changeText:(e,{payload:s})=>{e.text=s},changeSection:(e,{payload:s})=>{e.section=s,e.forum=s?.forum.toLowerCase()},showVoting:(e,{payload:s})=>{e.isVoting=s},setError:(e,{payload:s})=>{e.error=s}},extraReducers:e=>{e.addCase(ne.pending,s=>{s.status="loading",delete s.error}).addCase(ne.fulfilled,s=>{Ne(s),delete s.error}).addCase(ne.rejected,(s,{error:n})=>{s.status="error",s.error=n?.message})}}),{actions:Fe,reducer:ls}=cs,Ae={voteColors:["#FF1616","#1A861A","#0023FF","#FF6B18","#9B3A6E","#567655","#233345","#CC0000","#00CCCC","#0000CC"],items:{theme:"lightgray",topicsPerPage:"20",autoRefreshTopicsList:"false",autoRefreshTopicsListInterval:"60",autoRefreshTopic:"true",autoRefreshTopicInterval:"60",showTooltips:"true",tooltipDelay:"500",showTooltipOnPostLink:"true",showYoutubeVideoTitle:"true",replaceCatalogMista:"true",fixBrokenLinks:"true"}},ds=X({name:"options",initialState:Ae,reducers:{save:(e,{payload:s})=>{for(let n in s){const r=String(s[n]);e.items[n]=r}}}}),{actions:us,reducer:hs}=ds,ps={items:[]},ms=(e,{payload:s})=>{const n=JSON.stringify(s.keys),r=e.items.findIndex(i=>i.hash===n);let o=0;e.items.length&&(o=e.items[e.items.length-1].zIndex+1),r===-1?e.items.push({keys:s.keys,coords:s.coords,hash:n,zIndex:o}):e.items[e.items.length-1].zIndex=o},gs=X({name:"tooltips",initialState:ps,reducers:{show:ms,close:(e,{payload:s})=>{const n=JSON.stringify(s);e.items=e.items.filter(r=>r.hash!==n)},closeAll:e=>{e.items=[]}}}),{actions:xe,reducer:fs}=gs,xs=(e,s)=>{if(s==="last20")return e===-1?[0,1010]:[Math.max(0,e-19),e];const n=A(s,1)-1;return[n*100,n*100+99]},js=async({topicId:e,page:s,item0:n})=>{let r;try{r=await le(e)}catch(u){console.error(u),r={id:e,title:"",count:-1}}let[o,i]=xs(r.count,s);o===0&&n&&(o=1);let a=await Ee({id:e,from:o,to:i}),c=n;return o===0?c=a.shift():c=await de(e,0),r.count===0&&a.length>0&&(r.count=a[a.length-1].n),s==="last20"&&a.length>20&&(a=a.slice(-20)),{info:r,item0:c,list:a}},vs={status:"init",text:""},re=G("newMessage/post",async e=>{let s={message_text:e.text,action:"new",topic_id:e.topicId,rnd:Math.round(Math.random()*1e10)};e.voting_select&&(s.voting_select=e.voting_select),await Ot(s)}),ys=X({name:"newMessage",initialState:vs,reducers:{changeText:(e,{payload:s})=>{e.text=s}},extraReducers:e=>{e.addCase(re.pending,s=>{s.status="loading",delete s.error}).addCase(re.fulfilled,s=>{s.text="",delete s.error}).addCase(re.rejected,(s,{error:n})=>{s.status="error",s.error=n?.message})}}),{actions:je,reducer:ws}=ys,bs={key:"options",storage:st},Ns=et({options:tt(bs,hs),login:rs,tooltips:fs,newTopic:ls,newMessage:ws}),Ve=Qe({reducer:Ns,middleware:e=>e({serializableCheck:{ignoredActions:[nt,rt,ot,it,at,ct]}}),devTools:!1}),Ts=Ze(Ve),z=()=>dt(),C=lt,Y=e=>{const s=z();return h.useMemo(()=>ut(e,s),[e,s])},ks=()=>{const[e,s]=h.useState("Яндекс"),[n,r]=h.useState(""),o=h.useCallback(c=>{r(c.target.value)},[]),i=oe(c=>{c.key==="Enter"&&a()}),a=oe(()=>{let c;switch(e){case"Яндекс":c=`https://www.yandex.ru/search/?text=${n}&site=forum.mista.ru`;break;case"Google":c=`https://www.google.ru/search?q=${n}+site:forum.mista.ru`;break}window.open(c),r("")});return t.jsxs(ie,{size:"sm",children:[t.jsxs(ht,{id:"search-engine",title:"",size:"sm",variant:"light",onSelect:s,children:[t.jsx(P.Item,{eventKey:"Яндекс",children:"Яндекс"}),t.jsx(P.Item,{eventKey:"Google",children:"Google"})]}),t.jsx(J,{type:"text",placeholder:`${e}: поиск`,className:"search-input input",onKeyDown:i,onChange:o,value:n}),t.jsx(ie.Text,{className:"search-button",onClick:a,children:t.jsx("i",{className:"fa fa-search input",style:{zIndex:1e3}})})]})};var V=(e=>(e.Sections="sections",e.TopicsList="topics-list",e.TopicMessages="topic-messages",e.TopicMessageData="topic-message-data",e.UpdateTopicMessages="update-topic-messages",e))(V||{});const Be=e=>Q({queryKey:[V.Sections],queryFn:Vt,placeholderData:{items:[],tree:{}},...e}),Ue=({searchParams:e},s)=>{const n=C(r=>r.options.items.topicsPerPage);return Q({queryKey:[V.TopicsList,Object.fromEntries(e)],queryFn:async({queryKey:r})=>{const o=r[1];return zt({itemsPerPage:n,...o})},placeholderData:r=>r??[],...s})},K=({topicId:e},s)=>{const[n]=B(),r=n.get("page");return Q({queryKey:[V.TopicMessages,e,r],queryFn:({client:o})=>{const i=ve(o,e);return js({topicId:e,page:r,item0:i?.item0})},placeholderData:o=>o,...s})},He=({topicId:e},s)=>{const[n]=B(),r=n.get("page");return Q({queryKey:[V.UpdateTopicMessages,e],queryFn:async({client:o})=>{const i=ve(o,e);if(!i)return!0;const a=await Ee({id:e,from:i.info.count+1,to:1050});return a.length===0||o.setQueryData([V.TopicMessages,e,r],c=>({info:{...c.info,count:a.at(-1).n},item0:c.item0,list:[...c.list,...a]})),!0},initialData:!0,refetchOnMount:!1,...s})},ve=(e,s)=>{const n=e.getQueriesData({queryKey:[V.TopicMessages,s]});if(n.length!==0)return n[0][1]},Cs=({topicId:e,number:s})=>Q({queryKey:[V.TopicMessageData,e,s],queryFn:async({client:n})=>{const r=ve(n,e);if(r){if(s===0)return r.item0;{const i=r.list.find(a=>a.n===s);if(i)return i}}const o=await de(e,s);if(o===void 0)throw new Error(`Сообщение ${s} не найдено`);return o}}),Ss=()=>{const e=Se(),[s]=B(),n=s.get("forum"),{refetch:r}=Ue({searchParams:s},{enabled:!1}),o=c=>{e.pathname==="/"&&s.size===0&&(c.preventDefault(),r())},i=[{name:"1C",link:"/index.php?forum=1C"},{name:"IT",link:"/index.php?forum=IT"},{name:"JOB",link:"/index.php?forum=JOB"},{name:"LIFE",link:"/index.php?forum=LIFE"},{name:"Настройки",link:"/options.php"}],a=[{name:"Wiki",link:"https://wiki.mista.ru"},{name:"Книга знаний",link:"https://kb.mista.ru"}];return t.jsxs(ee,{bg:"dark",variant:"dark",expand:"md",fixed:"top",children:[t.jsx(ee.Brand,{as:I,to:"/",onClick:o,children:"React.Mista"}),t.jsx(ee.Toggle,{"aria-controls":"basic-navbar-nav"}),t.jsxs(ee.Collapse,{children:[t.jsxs(q,{className:"me-auto",children:[i.map((c,u)=>t.jsx(q.Item,{children:t.jsx(q.Link,{to:c.link,active:c.name===n,as:I,children:c.name})},"i"+u)),a.map((c,u)=>t.jsx(q.Item,{children:t.jsx(q.Link,{href:c.link,children:c.name})},"e"+u))]}),t.jsx(R,{className:"d-flex",children:t.jsx(ks,{})})]})]})},$s=()=>t.jsxs("footer",{className:"flex-row navbar-footer",children:[t.jsx("a",{href:`${k}/rules.php`,children:"Правила"}),t.jsx("span",{className:"separator",children:"|"}),t.jsx("a",{href:`${k}/about.php`,children:"Описание"}),t.jsx("span",{className:"separator",children:"|"}),t.jsxs("b",{children:[t.jsx("a",{href:`${k}/ad.php`,children:"Реклама на сайте"})," "]}),t.jsx("span",{className:"separator",children:"|"}),t.jsx("a",{href:`${k}/find.php`,children:"Поиск"}),t.jsx("span",{className:"separator",children:"|"}),t.jsx("a",{rel:"nofollow",href:`${k}/sections_list.php`,children:"Секции"}),t.jsx("span",{className:"separator",children:"|"}),t.jsx("a",{rel:"nofollow",href:`${k}/rating.php`,children:"Рейтинг"}),t.jsx("span",{className:"separator",children:"|"}),t.jsx("a",{href:"http://kb.mista.ru",children:"Книга знаний"}),t.jsx("span",{className:"separator",children:"|"}),t.jsx("a",{href:"http://wiki.mista.ru",children:"Вики-миста (КЗ2)"}),t.jsx("span",{className:"separator",children:"|"}),t.jsx("a",{rel:"nofollow",href:"http://m.mista.ru/",children:"Мобильная"}),t.jsx("span",{className:"separator",children:"|"}),t.jsx("a",{href:`${k}/archive.php`,children:"Архив"}),t.jsx("span",{className:"separator",children:"|"}),t.jsx("a",{href:`${k}/moders.php`,children:"Модераторы"}),t.jsx("span",{className:"separator",children:"|"}),t.jsx("a",{href:`${k}/users_gallery.php`,children:"Галерея"}),t.jsx("span",{className:"separator",children:"|"}),t.jsx("a",{href:`${k}/ban_list.php`,children:"Баны"}),t.jsx("span",{className:"separator",children:"|"}),t.jsx("span",{children:"18+"})]});function Ls(e){const s=new Set("if|если|then|тогда|elsif|иначеесли|else|иначе|endif|конецесли|do|цикл|for|для|to|по|each|каждого|in|из|while|пока|enddo|конеццикла|procedure|процедура|endprocedure|конецпроцедуры|function|функция|endfunction|конецфункции|var|перем|export|экспорт|goto|перейти|and|и|or|или|not|не|val|знач|break|прервать|continue|продолжить|return|возврат|try|попытка|except|исключение|endtry|конецпопытки|raise|вызватьисключение|false|ложь|true|истина|undefined|неопределено|null|new|новый|execute|выполнить|асинх|async|ждать|wait".split("|")),n=new Set("():;.,=+-*<>?[]%/".split("")),r="<span class=",o="</span>",i="bg>",a="num>",c="str>",u="com>",d="sp>",j="pr>",N="key>";let v,f,m,p=!1,l="";function b(w){return w.trim()===""}function y(w,L,H){return w.substring(L-1,L-1+H)}function x(w,L){return w.substring(w.length-L)}function S(w){return s.has(w.toLowerCase().trim())}function g(w,L){w===" "||m===L?v=v+w:(f&&(v=v+o,f=!1),v=v+r+L+w,f=!0,m=L)}function U(w){let L=!1,H=!1,M=1,_=!0,$=1;for($=1;$<=w.length;$++){let T=w.charAt($-1);if(p)T==='"'?(g(y(w,M,$-M+1),c),p=!1,l="",_=!0):l=l+T;else if(L)T==="'"?(g(y(w,M,$-M+1),c),L=!1,l="",_=!0):l=l+T;else if(T===" ")b(l)?v=v+" ":(H?(g(l+" ",c),H=!1):S(l.trim())?g(l+" ",N):isNaN(parseInt(l,10))?g(l+" ",i):g(l+" ",a),l=""),_=!0;else if(n.has(T)){if(b(l)||(H?(g(l,c),H=!1,_=T!=="."):_&&S(l)?(g(l,N),_=T!=="."):(isNaN(parseInt(l,10))?g(l,i):g(l,a),_=T!=="."),l=""),T==="."&&m===a){g(T,a);continue}else if(T==="="&&y(w,$-1,1)==="<")m=void 0;else if(T==="/"&&y(w,$+1,1)==="/"){g(x(w,w.length-$+1),u);return}g(T,d)}else if(T==='"'||T==="|")b(l)?(M=$,p=!0):(g(l+T,c),l=""),_=!0;else if(T==="'")b(l)?(M=$,L=!0):(g(l+T,c),l=""),_=!0;else if(T==="#"||T==="&"&&b(v)){g(x(w,w.length-$+1),j),$=w.length;break}else T==="~"?(l=l+T,H=!0):l=l+T}p||L?g(y(w,M,$-M+1),c):b(l)||(S(l)?g(l,N):isNaN(parseInt(l,10))?g(l,i):g(l,a))}p=!1,l="",f=!1,m=void 0,v="";let E=[];for(let w of e.split(`
`)){if(b(w)){E.push("");continue}v="",U(w),f&&!p?(v+="</span>",f=!1,m="",l=""):p||(m="",l=""),E.push(v)}return E.join(`
`)}const Ps=e=>{let s=0,n=e.length;for(;s<n&&(e[s]===`
`||e[s]==="\r");)s++;for(;n>s&&(e[n-1]===`
`||e[n-1]==="\r");)n--;return e.substring(s,n)},Is=e=>{let s=e.replace(/\n<br>/g,`
`).replace(/<br>\n/g,`
`).replace(/\r<br>/g,`
`).replace(/<br>\r/g,`
`).replace(/<br>/g,`
`).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt");return s=Ps(s),Ls(s)},Ms=({children:e})=>{const[s,n]=h.useState(!0),[r,o]=h.useMemo(()=>{if(!e)return["",0];let c=ae(e).join("");return c=Is(c),[c,c.split(`
`).length]},[e]),i=()=>{n(c=>!c)};let a={};return s&&o>7?(a.overflow="hidden",a.height="135px"):(a.overflow="auto",a.height="auto"),t.jsxs("div",{style:{marginTop:"5px"},children:[t.jsx("pre",{className:"code-pre",style:a,dangerouslySetInnerHTML:{__html:r}}),o>7&&t.jsx("div",{className:"expand-button-div",children:t.jsx("span",{className:"expand-button-span",onClick:i,children:s?`Показать: ${o} строк`:"Скрыть"})})]})},me=({topicId:e,number:s,children:n,style:r})=>{const o=h.useRef(null),i=Y(xe),[a]=B(),c=A(a.get("id"),-1),u=C(l=>+l.options.items.tooltipDelay);let d="";n?d=ae(n).join(""):d=String(s);const[j,N]=h.useState(d);h.useEffect(()=>{let l=!0;if(!d.startsWith("http")){N(d);return}return(async()=>{const{title:y}=await le(e);l&&N(y)})(),()=>{l=!1}},[d,e]);const v=l=>{l.persist(),o.current=setTimeout(()=>p(l),u)},f=()=>{o.current&&clearTimeout(o.current)},m=l=>{l.stopPropagation(),o.current&&clearTimeout(o.current),p(l)},p=l=>{const b={x:l.pageX,y:l.pageY-50},y={topicId:+e,number:+s};i.show({keys:y,coords:b})};if(e===c||!isNaN(+j))return t.jsx("span",{onMouseOver:v,onMouseOut:f,onClick:m,className:"link",style:{...r},role:"button",children:j});{const l=ge(s);let b="";return l>1&&(b=`&page=${l}`),t.jsxs("span",{children:[t.jsx("a",{href:`#/topic.php?id=${e}${b}#${s}`,style:{...r},children:j})," ","(",t.jsx("span",{onMouseOver:v,onMouseOut:f,onClick:m,className:"link",role:"button",children:s}),")"]})}},_s=({href:e,children:s})=>t.jsx("a",{href:e,className:"registered-user",children:s}),Rs=e=>{let s=e;e.search(/http/)===-1&&(s="http://"+s);try{var n=new URL(s)}catch{return null}return n.hostname.search(/youtube/)!==-1?n.searchParams.get("v"):n.hostname.search(/youtu\.be/)!==-1?n.pathname.substring(1):null},Es=async(e,s)=>{let r=`https://www.googleapis.com/youtube/v3/videos?key=${localStorage.getItem("youtubeApiKey")||"AIzaSyCztN2QW4Fxw_1YuAHBTOZdYLbzigPz25g"}&fields=items(snippet(title))&part=snippet&id=${e}`;const i=await(await fetch(r,{signal:s})).json();if(i.items.length===0)return{hrefName:"",title:"",notFound:!0};const a=i.items[0].snippet.title;let c=a,u=50;return a.length>u+5&&(c=c.substring(0,u)+"..."),{hrefName:c,title:a,notFound:!1}},Ds=({href:e})=>{let[s,n]=h.useState(e),[r,o]=h.useState("");return h.useEffect(()=>{const a=new AbortController;return(async()=>{const u=Rs(e);if(u)try{const d=await Es(u,a.signal);d.notFound?n(e+" (видео не найдено)"):(n(d.hrefName),o(d.title))}catch(d){console.error("youtube",u,d.message)}})(),()=>a.abort()},[e]),t.jsx("a",{href:e,title:r,children:`youtube: ${s}`})},Os=(e,s)=>{let n=e.replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\./g,"\\.").replace(/\./g,".").replace(/\*/g,"\\*").replace(/\+/g,"\\+").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/\?/g,"\\?").replace(/\//g,"\\/");try{let r=new RegExp(n+"<\\/a>(\\)|[а-яёА-ЯЁ0-9#\\-\\+\\_\\%\\?=]*)"),o=s.match(r);if(o&&o.length>1)return o[1]===")"&&e.search("\\(")===-1||(e=e+o[1]),e}catch(r){console.error(r)}return e},Fs=e=>e.search(/youtube/)!==-1||e.search(/youtu\.be/)!==-1,As=e=>e.search(/catalog\.mista/)!==-1,Vs=({href:e,children:s,parentText:n,...r})=>{const o=C(d=>d.options.items.showYoutubeVideoTitle==="true"),i=C(d=>d.options.items.replaceCatalogMista==="true"),a=C(d=>d.options.items.fixBrokenLinks==="true");try{var c=new be(e,!0)}catch(d){return console.error(d.message,e),t.jsx("a",{href:e,children:e})}let u=e;if(u.startsWith("/")&&(c.set("protocol","https"),c.set("hostname","forum.mista.ru"),u=c.href),c.hostname.search(/forum\.mista.ru/)!==-1){if(c.pathname==="/topic.php")return t.jsx(me,{topicId:c.query.id,number:c.hash.replace("#","")||"0",children:ae(s)});if(c.pathname==="/users.php")return t.jsx(_s,{href:c.href,children:s})}return c.hostname==="a-sitnikov.github.io"&&c.pathname==="/react.mista/"&&Object.keys(c.query).length===0&&(c=new be(e.replace(/#\//,""),!0),c.pathname==="/react.mista/topic.php")?t.jsx(me,{topicId:c.query.id,number:c.hash.replace("#","")||"0",children:ae(s)}):o&&Fs(c.hostname)?t.jsx(Ds,{href:e}):i&&As(c.hostname)?(c.set("hostname","infostart.ru"),t.jsxs("a",{target:r?.target,className:r?.class,rel:r?.rel,href:c.href,children:[c.href," "]})):(a&&n&&(u=Os(u,n)),t.jsx("a",{target:r?.target,className:r?.class,rel:r?.rel,href:u,children:s}))},Bs=({idx:e,topicId:s,topicDate:n,messageNumber:r})=>{const i=`https://forum.mista.ru/topics/files/${W(n).format("YYYY/MM/DD")}/${s}/${r}`,a=`${i}/${e}_preview.png`,c=`${i}/${e}.png`;return t.jsx(pt,{src:c,children:t.jsx("img",{src:a,alt:"",style:{maxWidth:"100%",cursor:"pointer"}})})},Us=h.memo(Bs),Hs=(e,s)=>{const n=/(\()(\d+)(\))(?![^<>]*<\/)/gi;return e.replace(n,(r,...o)=>{const i=o[1];return`(<link data-topicid='${s}' data-number='${i}'></link>)`})},zs=e=>e.replace(/\[1[CС]\]/gi,"<code>").replace(/<1[CС]>/gi,"<code>").replace(/\[\/1[CС]\]/gi,"</code>").replace(/<\/1[CС]>/gi,"</code>"),Ys=(e,s,n,r)=>{const o=/\[IMG_(\d*)\]/gi;return e.replace(o,(i,...a)=>`<int_img idx='${a[0]}'></int_img>`)},Ws=(e,s,n,r)=>{if(!e)return e;let o=zs(e);return o=Hs(o,s),o=Ys(o),o},Ks=$e.Parser(),qs=$e.ProcessNodeDefinitions(),Js=()=>!0,Gs={shouldProcessNode:e=>e?.name==="link",processNode:(e,s,n)=>{const r=e.attribs["data-topicid"],o=e.attribs["data-number"];return t.jsx(me,{topicId:r,number:o},n)}},Xs={shouldProcessNode:e=>e?.name==="code"||e?.name==="pre",processNode:(e,s,n)=>t.jsx(Ms,{children:s},n)},Qs=e=>({shouldProcessNode:s=>s?.name==="a",processNode:function(s,n,r){const o=s.attribs.href;return t.jsx(Vs,{href:o,parentText:e,children:n},r)}}),Zs=(e,s,n)=>({shouldProcessNode:r=>r?.name==="int_img",processNode:function(r,o,i){const a=r.attribs.idx;return t.jsx(Us,{topicId:e,topicDate:s,messageNumber:n,idx:a},i)}}),en=({html:e,topicId:s,topicDate:n,messageNumber:r})=>{const o=Ws(e,s),i=[Gs,Xs,Qs(o),Zs(s,n,r),{shouldProcessNode:()=>!0,processNode:qs.processDefaultNode}],a=Ks.parseWithInstructions(o,Js,i);return t.jsx(t.Fragment,{children:a})},tn=h.memo(en),sn=h.memo(({colors:e,n:s,text:n})=>t.jsx("div",{style:{marginTop:"5px"},children:t.jsx("b",{children:t.jsx("span",{style:{color:e[s-1]},children:`${s}. ${n}`})})})),nn=({topicId:e,data:s,total:n,n:r,colors:o})=>{const i=`${k}/css/voting${r}.png`,a=n?Math.round(100*s.count/n):0,c={maxWidth:"500px",width:"100%",height:"15px"};return t.jsxs("li",{className:"voting-item",children:[t.jsx("div",{className:"voting-title",children:t.jsx("a",{rel:"nofollow",style:{textDecoration:"none"},href:`#/topic.php?id=${e}&sel=${r}`,children:t.jsx("b",{children:t.jsx("span",{style:{color:o[r-1]},children:`${r}. ${s.text}`})})})}),t.jsx("div",{className:"voting-percentage",children:t.jsx("b",{children:t.jsx("span",{style:{color:o[r-1]},children:`${a}% (${s.count})`})})}),t.jsx("div",{className:"voting-bar",children:t.jsx("div",{style:{width:`${a}%`},children:t.jsx("a",{href:i,children:t.jsx("img",{src:i,style:c,alt:`вариант ${r}`})})})})]})},rn=({items:e,topicId:s,colors:n})=>{let r=Math.max(...e.map(o=>o.count));return t.jsx("ul",{style:{paddingLeft:0},children:e.filter(o=>o.text).map((o,i)=>t.jsx(nn,{data:o,total:r,n:i+1,topicId:s,colors:n},i))})},ye=({topicId:e,topicDate:s,n,html:r,vote:o,style:i})=>{const{data:a}=K({topicId:e},{enabled:!1,select:f=>f?.info}),c=C(f=>f.options.voteColors);let u=null;o&&a.voting&&e===a.id&&(u=a.voting[o-1].text);const[d,j]=h.useState(u);h.useEffect(()=>{o&&!u&&(async()=>{try{const m=await le(e);j(m.voting[o-1].text)}catch(m){console.error(m.message)}})()},[o,u,e]);const N=n===0&&a?.isVoting&&a?.voting,v=o!==0&&d!==null;return t.jsxs("div",{className:"message",style:i,children:[N&&t.jsx(rn,{items:a.voting,topicId:e,colors:c}),t.jsx("div",{children:t.jsx(mt,{children:t.jsx(tn,{html:r,topicId:e,topicDate:s,messageNumber:n})})}),v&&t.jsx(sn,{text:d,n:o,colors:c})]})},on=({data:e})=>{const[s,n]=h.useState("none"),r=()=>{n("inline")},o=()=>{n("none")};return h.useEffect(()=>{n("none")},[e.n]),window.innerWidth<=768?null:t.jsx("img",{src:`${k}/css/user_icons/${e.userId}_16x16.png`,alt:"user ico",onLoad:r,onError:o,style:{display:s,marginBottom:"4px",marginRight:"1px"}})},we=({data:e,isAuthor:s,isYou:n,isTooltip:r})=>{const o=Y(je),i=()=>{o.changeText(`(${e.n})`);let u=document.getElementById("message_text");u&&window.scrollTo(0,u.offsetTop)};let a=h.useMemo(()=>{if(e)return e.n===0?W(e.time).format("DD.MM.YY - HH:mm"):t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"message-number",children:e.n})," - "+W(e.time).format("DD.MM.YY - HH:mm")]})},[e]);const c=Le("registered-user",{"is-author":s,"is-you":n});return t.jsxs("div",{className:"user-info",children:[t.jsx(on,{data:e}),t.jsx("a",{className:c,href:`${k}/users.php?id=${e.userId}`,children:e.user}),r?t.jsx("div",{className:"ah",style:{display:"inline-block",marginLeft:"5px"},children:a}):t.jsxs("div",{className:"message-time",children:[t.jsx("span",{className:"ah",children:a}),t.jsx("button",{className:"button ah",onClick:i,children:a})]})]})},ze=({children:e,closeWindow:s})=>t.jsxs("div",{className:"tooltip-header",children:[e,t.jsxs("div",{className:"tooltip-close",onClick:s,onTouchEnd:s,children:[t.jsx("i",{className:"fa fa-angle-right","aria-hidden":"true"}),t.jsx("i",{className:"fa fa-angle-left","aria-hidden":"true",style:{marginLeft:"-2px"}})]})]}),Ye=({children:e,onScroll:s})=>{let n=0;const r=i=>{n=i.nativeEvent.changedTouches[0].clientX},o=i=>{if(!s)return;let a=i.nativeEvent.changedTouches[0].clientX;Math.abs(a-n)>100&&s(-a+n)};return t.jsx("div",{className:"tooltip-text",onTouchStart:r,onTouchEnd:o,children:e})},an=({tooltip:e,zIndex:s,children:n})=>{const r=Y(xe),o=()=>{r.close(e.keys)},{coords:i}=e;let a,c;window.innerWidth<=768?(a="y",c={top:i.y,left:5}):(a="both",c={top:i.y,left:Math.min(i.x,window.innerWidth-670)});let[u,d]=h.Children.toArray(n);return t.jsx(gt,{axis:a,handle:".tooltip-header",defaultClassNameDragging:"dragging",children:t.jsxs("div",{className:"tooltip-window",style:{...c},children:[t.jsx(ze,{closeWindow:o,children:u.props.children}),t.jsx(Ye,{children:d.props.children})]})},s)},cn=({tooltip:e})=>{const{keys:s}=e,{data:n,isPending:r,isError:o,error:i}=Cs({topicId:s.topicId,number:s.number});return r?null:t.jsxs(an,{tooltip:e,children:[t.jsx(ze,{children:o?t.jsx("b",{children:"Ошибка"}):t.jsx(we,{data:n,isAuthor:!1,isYou:!1,isTooltip:!0})}),t.jsx(Ye,{children:t.jsx(ye,{n:n?.n,vote:n?.vote,html:o?i.message:n.text,topicId:s.topicId,topicDate:n?.time,style:{maxHeight:"min(550px, 80vh)",overflowY:"auto"}})})]})},ln=()=>{const e=C(o=>o.tooltips.items),s=Y(xe),n=h.useRef(null);return ft(n,()=>{s.closeAll()}),t.jsx("div",{ref:n,children:e.map(o=>t.jsx(cn,{tooltip:o},o.hash))})},dn=[{tabName:"Общие",rows:[["theme"],["topicsPerPage"],["autoRefreshTopicsList","autoRefreshTopicsListInterval"],["autoRefreshTopic","autoRefreshTopicInterval"]]},{tabName:"Тултипы",rows:[["showTooltips","tooltipDelay"],["showTooltipOnPostLink"]]},{tabName:"Ссылки",rows:[["showYoutubeVideoTitle"],["replaceCatalogMista"],["fixBrokenLinks"]]}],un={theme:{type:"radio",label:"Цветовая палитра:",oneLine:!0,values:[{name:"yellow",descr:"Золотая"},{name:"lightgray",descr:"Серая"},{name:"dark",descr:"Темная"}]},topicsPerPage:{type:"number",label:"Тем на странице (max 99):",min:1,max:99},autoRefreshTopicsList:{type:"checkbox",label:"Автообновление списка тем"},autoRefreshTopicsListInterval:{type:"number",label:"",min:60,max:1e6,postfix:"сек"},autoRefreshTopic:{type:"checkbox",label:"Автообновление темы"},autoRefreshTopicInterval:{type:"number",label:"",min:60,max:1e6,postfix:"сек"},showTooltips:{type:"checkbox",label:"Показывать тултипы, задержка",disabled:!0},tooltipDelay:{type:"number",max:1e6,label:"",postfix:"мс",disabled:!0},showTooltipOnPostLink:{type:"checkbox",label:"Показывать тултип ссыки на другую ветку",disabled:!0},showYoutubeVideoTitle:{type:"checkbox",label:"Показывать наименования роликов youtube"},replaceCatalogMista:{type:"checkbox",label:"Обратно заменять catalog.mista.ru на infostart.ru"},fixBrokenLinks:{type:"checkbox",label:"Чинить поломанные ссылки (с русскими символами)"}},hn=({name:e,label:s,value:n,values:r,oneLine:o,onChange:i})=>{const a=c=>{i(c,e,c.target.value)};return t.jsxs("span",{children:[t.jsxs("span",{style:{marginRight:"5px"},children:[" ",s," "]}),o&&t.jsx("br",{}),r.map((c,u)=>t.jsx(R.Check,{type:"radio",id:c.name,label:c.descr,name:s,checked:c.name===n,value:c.name,inline:o,onChange:a},u))]})},pn=({name:e,value:s,label:n,postfix:r,onChange:o})=>{const i=a=>{o(a,e,a.target.value)};return t.jsxs("label",{htmlFor:e,style:{marginRight:"5px"},children:[t.jsx("span",{style:{marginRight:"5px"},children:n}),t.jsx("input",{type:"string",name:e,value:s,onChange:i,className:"input"}),r!==void 0?t.jsx("span",{style:{marginLeft:"5px"},children:r}):null]})},mn=({name:e,children:s})=>t.jsxs("div",{children:[t.jsx("div",{className:"tab-header",children:e}),t.jsx("div",{className:"tab-content",children:s})]}),gn=()=>{const e=z(),s=xt(),n=C(j=>j.options),[r,o]=h.useState({items:n.items}),i=()=>{s("/#")},a=()=>{o({...r,items:Object.assign({},Ae.items)})},c=()=>{e(us.save(r.items)),i()},u=(j,N,v)=>{let f=Object.assign({},r.items);f[N]=v,o({...r,items:f})};let d=[];for(let j of dn){let N=[];for(let v in j.rows){const f=j.rows[v];let m=[];for(let p of f){const l=un[p];if(!l)continue;const b=r.items[p];l.type==="radio"?m.push(t.jsx(hn,{name:p,label:l.label,values:l.values,value:b,oneLine:l.oneLine,onChange:u},p)):l.type==="number"?(l.label&&m.push(t.jsx("label",{htmlFor:p,style:{fontWeight:"inherit"},children:l.label},p+"_label")),m.push(t.jsxs("div",{className:"options-number",children:[t.jsx(J,{type:"number",min:l.min,max:l.max,value:b,disabled:l.disabled,onChange:y=>u(y,p,y.target.value),className:"input",size:"sm"}),l.postfix&&t.jsx("span",{style:{marginLeft:"5px",flex:"0 0 auto"},children:l.postfix},p+"_postfix")]},p))):l.type==="string"?m.push(t.jsx(pn,{name:p,label:l.label,postfix:l.postfix,value:b,onChange:u},p)):l.type==="checkbox"&&m.push(t.jsx(R.Check,{id:p,type:"checkbox",label:l.label,name:p,checked:String(b)==="true",disabled:l.disabled,onChange:y=>u(y,p,String(y.target.checked)),style:{flex:"0 0 auto",margin:"0px",maxWidth:"100%"}},p))}N.push(t.jsx("div",{className:"options-row",children:m},v))}d.push(t.jsx(mn,{name:j.tabName,children:N},j.tabName))}return t.jsxs("div",{className:"options-form",children:[t.jsx("div",{className:"options-header",style:{cursor:"default"},children:t.jsx("b",{children:"Настройки"})}),d,t.jsxs("div",{className:"button-row",children:[t.jsx(F,{id:"applyOptions",size:"sm",variant:"light",style:{margin:"5px"},className:"button",onClick:c,children:"OK"}),t.jsx(F,{id:"cancelOptions",size:"sm",variant:"light",style:{margin:"5px",float:"left"},className:"button",onClick:i,children:"Отмена"}),t.jsx(F,{id:"defaultOptions",size:"sm",variant:"light",style:{margin:"5px",float:"right"},className:"button",onClick:a,children:"Сбросить настройки"})]})]})},ue=({text:e})=>e?t.jsx("div",{className:"error",dangerouslySetInnerHTML:{__html:e}}):null,We=({maxPage:e,last20:s})=>{const[n]=B(),r=Ie(n.get("page"));let o=[];const i=new URLSearchParams(n);for(let a=1;a<=e;a++)a===1?i.delete("page"):i.set("page",String(a)),o.push(t.jsx(he.Item,{active:r===a,as:I,to:"?"+i.toString(),children:a},a));return s===!0&&(i.set("page","last20"),o.push(t.jsx(he.Item,{active:r==="last20",as:I,to:"?"+i.toString(),children:"»"},"last20"))),t.jsx(he,{style:{margin:"0px"},children:o})},Te=({item:e,topicId:s})=>{const n=C(i=>i.login),{data:r}=K({topicId:s},{enabled:!1}),o=r?.item0?.user||"";return e?t.jsxs("div",{className:"topic-row",id:String(e.n),children:[t.jsx("div",{className:"cell-userinfo",children:t.jsx(we,{data:e,isAuthor:e.user===o,isYou:e.user===n.userName})}),t.jsx("div",{className:"cell-message",children:t.jsx(ye,{html:e.text,topicId:s,topicDate:e.time,n:e.n,vote:e.vote})})]}):null},fn=({topicId:e,isLastPage:s})=>{const{isFetching:n,refetch:r}=He({topicId:e},{enabled:!1}),o=()=>{};return t.jsxs("div",{className:"flex-row",id:"F",children:[t.jsx("div",{className:"ta-left va-top",style:{width:"50%"},children:t.jsx(F,{onClick:o,disabled:!1,size:"sm",className:"button",variant:"light",children:"Закладка"})}),t.jsx("div",{className:"ta-right va-middle",style:{marginLeft:"auto"},children:s&&t.jsx(F,{onClick:()=>r(),disabled:n,size:"sm",className:"button",variant:"light",children:n?"Обновляется":"Обновить ветку"})})]})},xn=jt.forwardRef(({children:e,onClick:s},n)=>t.jsx("span",{ref:n,style:{cursor:"pointer"},className:"link",onClick:r=>{r.preventDefault(),s(r)},children:e})),jn=({userId:e,userName:s})=>{const n=Y(ns),r=i=>{i.preventDefault(),n.doLogout()},o=(i,a)=>{i==="exit"&&r(a)};return t.jsx("div",{style:{float:"left"},children:t.jsxs(P,{id:"dropdown-custom-menu",onSelect:o,children:[t.jsx("span",{children:"Привет, "}),t.jsxs(P.Toggle,{as:xn,children:[s," ▼"]}),t.jsxs(P.Menu,{children:[t.jsx(P.Item,{eventKey:"profile",href:`${k}/users.php?id=${e}`,children:"Профиль"}),t.jsx(P.Item,{eventKey:"myTopics",href:`#/index.php?user_id=${e}`,children:"Мои темы"}),t.jsx(P.Divider,{}),t.jsx(P.Item,{eventKey:"options",href:"#/options.php",children:"Настройки"}),t.jsx(P.Divider,{}),t.jsx(P.Item,{eventKey:"exit",children:"Выход"})]})]})})},vn=()=>{const e=z(),[s,n]=h.useState(""),[r,o]=h.useState(""),i=a=>{a.preventDefault(),e(es(s,r))};return t.jsxs("div",{children:[t.jsxs("form",{name:"enterform",className:"flex-row",style:{flexWrap:"wrap"},children:[t.jsx(J,{id:"username",type:"text",placeholder:"Имя",value:s,onChange:a=>n(a.target.value),size:"sm",className:"input",style:{marginRight:"5px",flex:"0 1 300px"}}),t.jsx(J,{id:"password",type:"password",placeholder:"Пароль",maxLength:20,autoComplete:"off",value:r,onChange:a=>o(a.target.value),size:"sm",className:"input",style:{marginRight:"5px",flex:"0 1 300px"}}),t.jsx(F,{size:"sm",variant:"light",className:"button",onClick:i,children:"Войти"})]}),t.jsxs("p",{style:{margin:"0px"},children:["Войти можно на сайте"," ",t.jsx("a",{href:"https://forum.mista.ru/",children:"forum.mista.ru"})]}),t.jsx("a",{rel:"nofollow",href:"https://forum.mista.ru/user_registration.php",children:"Регистрация"}),t.jsx("span",{style:{margin:"5px"},children:"|"}),t.jsx("a",{rel:"nofollow",href:"https://forum.mista.ru/remember_password.php",children:"Забыли пароль?"})]})},Ke=()=>{const e=z(),s=C(i=>i.login.logged),n=C(i=>i.login.userId),r=C(i=>i.login.userName),o=C(i=>i.login.error);return h.useEffect(()=>{e(ts())},[e]),t.jsxs(t.Fragment,{children:[s?t.jsx(jn,{userId:n,userName:r}):t.jsx(vn,{}),o&&t.jsx(ue,{text:o})]})},yn={"1c":"1С:Предприятие",life:"О жизни",it:"Информационные технологии",job:"Работа"},wn=({topicId:e})=>{const{data:s}=K({topicId:e},{enabled:!1,select:n=>n?.info.forum});return t.jsxs("div",{className:"flex-row",children:[t.jsx("div",{className:"header-left",children:t.jsx(Ke,{})}),t.jsx("div",{className:"header-right",children:t.jsx("span",{id:"forum_string",className:"bold120",children:t.jsx(I,{to:`/index.php?forum=${s}`,style:{textDecoration:"none"},children:yn[s]})})})]})},bn=({isLastPage:e})=>{const[s,n]=C(i=>[i.options.items.autoRefreshTopic,A(i.options.items.autoRefreshTopicInterval,60)*1e3]),[r,o]=h.useState(!1);return h.useEffect(()=>{s==="true"&&e&&setTimeout(()=>o(!0),n)},[s,n,e]),{enableUpdater:r,refreshInterval:n}},qe=({placeholder:e,showVoting:s,isVoting:n,isFetching:r,text:o,formRef:i,onChange:a,onShowVotingChange:c})=>{const u=h.useRef(),d=f=>{f.preventDefault();const m=`[1C]
`,p=`
[/1C]`,l=u.current,b=l.selectionStart,y=l.selectionEnd,x=l.value,S=x.length,g=x.substring(b,y),U=m+g+p;let E=x.substring(0,b)+U+x.substring(y,S);a&&a(E)},j=h.useCallback(f=>{c&&c(f.currentTarget.checked)},[c]),N=h.useCallback(f=>{a&&a(f.currentTarget.value)},[a]),v=f=>{i&&i.current&&f.key==="Enter"&&f.ctrlKey&&i.current.dispatchEvent(new Event("submit",{cancelable:!0,bubbles:!0}))};return t.jsxs("div",{children:[t.jsx(J,{as:"textarea","aria-label":"Сообщение",placeholder:e,cols:70,rows:3,value:o,onChange:N,onKeyUp:v,ref:u,className:"text-editor input","data-lpignore":!0}),t.jsxs("div",{className:"flex-row",children:[t.jsxs(vt,{children:[t.jsx(F,{size:"sm",variant:"light",onClick:d,style:{marginRight:"5px"},className:"button",children:"Код 1С"}),t.jsx(F,{size:"sm",variant:"light",disabled:r,type:"submit",className:"button",children:r?"Отправляется":"Отправить"})]}),s&&t.jsx(R.Check,{id:"show_voting",type:"checkbox",checked:n,onChange:j,label:"Голосование",style:{margin:"auto 0px auto auto"}})]})]})},Nn=({topicId:e,onSubmitSuccess:s})=>{const[n,r]=h.useState(),o=z(),i=Y(je),{data:{info:a}}=K({topicId:e}),c=C(m=>m.newMessage),u=m=>{m.preventDefault(),m.stopPropagation();let p={text:c.text,topicId:String(a?.id),onSuccess:d,voting_select:void 0};n&&(p.voting_select=n),o(re(p))},d=()=>{i.changeText(""),r(void 0),s&&s()},j=m=>{m.preventDefault(),r(void 0)},N=m=>{r(m)},v=h.useCallback(m=>{o(Fe.changeText(m))},[o]);let f;if(a?.isVoting&&a?.voting){let m=[];for(let p=1;p<=a.voting.length;p++){const l=a.voting[p-1];l.text&&m.push(t.jsx(R.Check,{type:"radio",name:"voting",checked:n===p,onChange:()=>N(p),label:`${p}. ${l.text}`},p))}f=t.jsxs(Pe,{children:[t.jsx("legend",{children:t.jsxs("small",{children:["Ваш выбор:",t.jsx("span",{id:"voting_clear",style:{marginLeft:"5px",cursor:"pointer"},onClick:j,children:"очистить"})]})}),m,"Обоснуйте свой выбор!"]})}return t.jsxs("form",{style:{marginTop:"5px"},onSubmit:u,children:[t.jsx("div",{className:"bold",children:"Добавить сообщение в тему:"}),t.jsxs("div",{className:"new-message-container",children:[t.jsx("div",{className:"new-message-text",children:t.jsx(qe,{isFetching:c.status==="loading",text:c.text,placeholder:"Сообщение",onChange:v})}),t.jsx("div",{className:"new-message-voting",children:f})]})]})},Tn=({topicId:e})=>{const{data:s}=K({topicId:e},{select:r=>r?.info.title});let n="https://www.yandex.ru/search/?text="+encodeURIComponent(s);return t.jsxs("div",{className:"topic-row",children:[t.jsx("div",{className:"cell-userinfo",children:t.jsxs("div",{className:"topic-tools",children:[t.jsx("a",{title:"API.info",href:`${k}/${De}?id=${e}`,className:"agh",style:{display:"block",lineHeight:"1em"},children:"i"}),t.jsx("a",{title:"API.messages",href:`${k}/${fe}?id=${e}&from=0&to=20`,className:"agh",style:{display:"block",lineHeight:"1em"},children:"m"})]})}),t.jsx("div",{className:"cell-message",children:t.jsxs("div",{className:"flex-row",children:[t.jsxs("div",{style:{flex:1,textAlign:"center"},children:[t.jsx("a",{href:`https://forum.mista.ru/topic/${e}`,children:t.jsx("h1",{className:"topic-title",dangerouslySetInnerHTML:{__html:s}})}),t.jsx("div",{className:"moder-action"})]}),t.jsx("div",{style:{flex:"0 0 20px",position:"relative"},children:t.jsx("div",{className:"div-va-middle",children:t.jsx("a",{rel:"noopener noreferrer",href:n,title:"Искать в Яндексе",target:"_blank",className:"yandex",children:"Я"})})})]})})]})},kn=()=>{const e=z(),{hash:s}=Se(),[n]=B(),r=A(n.get("id"),-1),{data:o,error:i,isPending:a}=K({topicId:r}),{info:c,item0:u,list:d=[]}=o??{},j=C(y=>y.login),N=Ie(n.get("page")),v=ge(c?.count),f=N==="last20"||N===v,{enableUpdater:m,refreshInterval:p}=bn({isLastPage:f}),{refetch:l}=He({topicId:r},{refetchInterval:p,enabled:m}),b=()=>{l(),e(je.changeText(""))};return h.useEffect(()=>{c?.title&&(document.title=It(c.title))},[c?.title]),h.useEffect(()=>{if(a||!s)return;const y=document.getElementById(s.slice(1));y&&window.scrollTo(0,y.offsetTop)},[a,s]),t.jsxs("div",{style:{marginBottom:"5px"},children:[t.jsx(wn,{topicId:r}),i&&t.jsx(ue,{text:i.message}),t.jsxs("div",{className:"topic-table",children:[t.jsx(Tn,{topicId:r}),t.jsx(Te,{item:u,topicId:r}),d.map(y=>t.jsx(Te,{item:y,topicId:r},y.n)),(v>1||N==="last20")&&t.jsx("div",{className:"table-footer",children:t.jsx(We,{maxPage:v,last20:!0})})]}),t.jsx(fn,{topicId:r,isLastPage:f}),j.logged&&t.jsx(Nn,{topicId:r,onSubmitSuccess:b})]})},Je=({id:e,defaultValue:s,selected:n,style:r,size:o,onChange:i})=>{const{data:a}=Be(),c=u=>{if(!i)return;const d=u.currentTarget.value,j=a.items.find(N=>N.code===d);i(u,j)};return t.jsxs(R.Select,{"aria-label":"Секция",onChange:c,value:n,style:r,className:"input",size:o,id:e,children:[t.jsx("option",{value:"",children:s}),Object.keys(a.tree).map(u=>t.jsx("optgroup",{label:u,children:a.tree[u].map(d=>t.jsx("option",{value:d.code,children:d.name},d.id))},u))]})},Cn=()=>{const[e,s]=B(),n=(r,o)=>{s(i=>{const a=new URLSearchParams(i);return o?a.set("section",o.code):a.delete("section"),a})};return t.jsxs("div",{className:"flex-row",children:[t.jsx("div",{className:"header-left",children:t.jsx(Ke,{})}),t.jsx("div",{className:"header-right",children:t.jsx(Je,{id:"sect",defaultValue:"--Все секции--",selected:e.get("section")??"",onChange:n,size:"sm"})})]})},Sn=({onSubmitSuccess:e})=>{const{data:s}=Be(),n=C(x=>x.newTopic),[r,o]=h.useState(null),[i,a]=h.useState(Array(10).fill("")),c=h.useRef(null),u=z(),d=Y(Fe),j=oe((x,S)=>{o(S),d.changeSection(S)}),N=x=>S=>{let g=i.slice();g[x]=S.target.value,a(g)},v=oe(x=>{if(x.preventDefault(),!r){d.setError("Не выбрана секция");return}let S=n.subject;if(!S){d.setError("Не указана тема");return}if(!n.text){d.setError("Не указано сообщение");return}let g={subject:S,text:n.text,section:r.id,forum:r.forum,isVoting:n.isVoting,votingItems:[],onSuccess:l};if(n.isVoting){g.votingItems=[];for(let U=1;U<=10;U++){let E=i[U-1];E&&g.votingItems.push(E)}}u(as(g))}),f=h.useCallback(x=>{d.changeSubject(x.target.value)},[d]),m=h.useCallback(x=>{d.changeText(x)},[d]),p=h.useCallback(x=>{d.showVoting(x)},[d]),l=()=>{d.clear(),e&&e()};let b=[];for(let x in s.tree)b.push(t.jsx("option",{value:x.toLowerCase(),children:x},x));let y=[];if(n.isVoting){y.push(t.jsx("div",{children:"Варианты:"},"p"));for(let x=1;x<=10;x++)y.push(t.jsxs(ie,{size:"sm",style:{marginBottom:"3px",width:"100%"},children:[t.jsx(ie.Text,{style:{width:"40px"},className:"input",children:`${x}.`}),t.jsx(R.Control,{type:"text","aria-label":`Вариант ${x}`,maxLength:50,className:"input",value:i[x-1],onChange:N(x-1)})]},x))}return t.jsxs("form",{className:"new-topic-container",onSubmit:v,ref:c,children:[t.jsxs("div",{id:"newtopic_form",className:"new-topic-text",children:[t.jsx("div",{children:t.jsx("b",{children:"Новая тема:"})}),n.error&&t.jsx(ue,{text:n.error}),t.jsxs("div",{className:"flex-row",style:{marginBottom:"3px"},children:[t.jsx(R.Select,{disabled:!0,size:"sm",value:n.forum,style:{flex:"0 1 90px"},className:"input",children:b}),t.jsx(Je,{id:"target_section",defaultValue:"Секция",selected:n.section?.code,size:"sm",style:{flex:"1 1 auto"},onChange:j})]}),t.jsx(R.Control,{type:"text","aria-label":"Тема",placeholder:"Тема",size:"sm",value:n.subject,onChange:f,style:{marginBottom:"3px"},className:"input",maxLength:90}),t.jsx(qe,{placeholder:"Сообщение",showVoting:!0,isVoting:n.isVoting,text:n.text,isFetching:n.status==="loading",onChange:m,onShowVotingChange:p,formRef:c})]}),t.jsx(Pe,{className:"new-topic-voting",children:y})]})},$n=({topicId:e,onFirst:s,onPrev:n,onNext:r,onLast:o,close:i})=>t.jsxs("div",{className:"topic-preview-rewind",children:[t.jsx("div",{className:"topic-preview-button flex-small",onClick:s,title:"К первому",children:t.jsx("i",{className:"fa fa-angle-double-left","aria-hidden":"true"})}),t.jsx("div",{className:"topic-preview-button flex-large",onClick:n,title:"К предыдущему",children:t.jsx("i",{className:"fa fa-angle-left","aria-hidden":"true"})}),t.jsx("div",{className:"topic-preview-button flex-large",onClick:r,title:"К следующему",children:t.jsx("i",{className:"fa fa-angle-right","aria-hidden":"true"})}),t.jsx("div",{className:"topic-preview-button flex-small",onClick:o,title:"К последнему",children:t.jsx("i",{className:"fa fa-angle-double-right","aria-hidden":"true"})}),t.jsxs("div",{className:"topic-preview-button close-preview",onClick:i,children:[t.jsx("i",{className:"fa fa-angle-right","aria-hidden":"true"}),t.jsx("i",{className:"fa fa-angle-left","aria-hidden":"true",style:{marginLeft:"-2px"}})]}),t.jsx("div",{className:"topic-preview-button edit-preview",children:t.jsx(I,{to:`/topic.php?id=${e}&page=last20#F`,children:t.jsx("i",{className:"fa fa-pencil","aria-hidden":"true",style:{color:"var(--font-color)"}})})})]}),ke=({topicId:e,n:s,author:n,loggedUserId:r,onDataLoaded:o})=>{const[i,a]=h.useState(null),[c,u]=h.useState(null);return h.useEffect(()=>{(async()=>{try{const j=await de(e,s);j?(a(j),u(null),o&&o()):(a(null),u(`Не найдено сообщение ${s}`))}catch(j){a(null),u(j.message)}})()},[e,s,o]),!i&&!c?null:t.jsxs(t.Fragment,{children:[i&&t.jsxs("div",{className:"preview-content",children:[t.jsx("div",{className:"topic-preview-userinfo",children:t.jsx(we,{data:i,isAuthor:i.user===n,isYou:i.userId===r,isTooltip:!0})}),t.jsx(ye,{topicId:e,topicDate:i.time,n:s,html:i.text,vote:i.vote,style:{overflowY:"auto",overflowWrap:"break-word"}})]}),c&&t.jsx("span",{children:c})]})},Ln=({topicId:e,initialMsgNumber:s,author:n,close:r})=>{const o=C(g=>g.login.userId),[i,a]=h.useState(0),[c,u]=h.useState("none"),[d,j]=h.useState({msgNumber:s,key:0}),N=()=>{j({msgNumber:0,key:d.key})},v=()=>{j({msgNumber:d.msgNumber+1,key:d.key})},f=()=>{d.msgNumber>0&&j({msgNumber:d.msgNumber-1,key:d.key})},m=async()=>{const g=await le(e);j({msgNumber:g.count,key:d.key})},b=yt({onSwiping:g=>{Math.abs(g.deltaX)<35?a(0):a(g.deltaX)},onSwiped:g=>{Math.abs(g.deltaX)>150&&(g.dir==="Left"?j({msgNumber:d.msgNumber+1,key:d.key+1}):g.dir==="Right"&&d.msgNumber>0&&j({msgNumber:d.msgNumber-1,key:d.key+1})),a(0)},delta:15}),y=h.useCallback(()=>{u("block")},[]);let x=[d.msgNumber];i<0?x.push(d.msgNumber+1):i>0&&d.msgNumber>0&&x.push(d.msgNumber-1);const S={transform:`translate3d(${i}px, 0px, 0px)`,flexDirection:i>0?"row-reverse":"row"};return t.jsx("div",{className:"preview-container",style:{display:c},children:t.jsxs("div",{className:"topic-preview",children:[t.jsx($n,{topicId:e,onFirst:N,onLast:m,onNext:v,onPrev:f,close:r}),t.jsxs("div",{className:"preview-carousel",...b,style:S,children:[t.jsx("div",{className:"preview-carousel-item",style:{order:0},children:t.jsx(ke,{topicId:e,n:x[0],loggedUserId:o,author:n,onDataLoaded:y})},d.key),x.length>1&&t.jsx("div",{className:"preview-carousel-item",style:{order:1},children:t.jsx(ke,{topicId:e,n:x[1],loggedUserId:o,author:n})},d.key+1)]})]})})},Pn=({item:e})=>t.jsx("div",{className:"cell-author",children:t.jsxs("div",{className:"cell-author--inner",children:[t.jsx("i",{"aria-hidden":"true",className:"fa fa-user-circle",style:{marginRight:"3px"}}),e.author]})}),In=({item:e,onClick:s})=>t.jsx("div",{className:"cell-answ",onClick:s,children:t.jsxs("div",{className:"cell-answ--inner",children:[t.jsx("i",{className:"fa fa-comments-o","aria-hidden":"true",style:{marginRight:"3px"}}),t.jsx("span",{children:e.count})]})}),Mn=({item:e})=>t.jsx("div",{className:"cell-forum",children:t.jsx("div",{className:"cell-forum--inner",children:e.forum})}),_n=({item:e})=>{const[s,n]=h.useState(e.updated);return h.useEffect(()=>{if(!e.pinned)return;(async()=>{const o=await de(e.id,e.count);n(o.time)})()},[e.pinned,e.id,e.count]),h.useEffect(()=>{n(e.updated)},[e.updated]),t.jsx("div",{className:"cell-lastuser",children:t.jsxs("div",{className:"cell-author--inner",children:[t.jsx("span",{className:"cell-lastuser-time",children:_t(s)}),t.jsx("span",{className:"cell-lastuser-user",children:e.lastUser})]})})},Rn=({item:e})=>t.jsx("div",{className:"cell-last20",children:t.jsx(I,{to:`/topic.php?id=${e.id}&page=last20#F`,style:{color:"inherit",display:"block",width:"100%",textAlign:"center"},children:t.jsx("i",{className:"fa fa-angle-right","aria-hidden":"true"})})}),En=({expanded:e,onClick:s})=>t.jsx("div",{className:"cell-preview-link",onClick:s,children:t.jsx("span",{children:e?t.jsx("i",{className:"fa fa-minus-square-o agh","aria-hidden":"true"}):t.jsx("i",{className:"fa fa-plus-square-o agh","aria-hidden":"true"})})}),Dn=({count:e,topicId:s})=>{let n=[];if(e>100){let r=ge(e);for(let o=1;o<=r;o++)n.push(t.jsx(I,{className:"agh",style:{margin:"3px"},to:`/topic.php?id=${s}&page=${o}`,children:o>3&&o<r?"•":String(o)},o))}return e>20&&n.push(t.jsx(I,{className:"agh",style:{margin:"3px"},to:`/topic.php?id=${s}&page=last20#F`,children:"»"},"last20")),t.jsx("span",{className:"topic-pages",children:n})},On=(e,s,n)=>s==="life"&&!e.startsWith("OFF")?"OFF: "+e:n==="job"&&!e.startsWith("JOB")?"JOB: "+e:n==="v7"&&!e.startsWith("v7")?"v7: "+e:e,Fn=({data:e})=>{const s=C(r=>r.login.userName);let n=On(e.text,e.forum,e.sectionCode);return t.jsx("div",{className:"cell-title",children:t.jsxs("div",{className:"cell-title--inner",children:[e.pinned&&t.jsx("i",{className:"fa fa-thumb-tack agh","aria-hidden":"true",style:{marginRight:"5px"}}),t.jsx(I,{to:`/topic.php?id=${e.id}`,className:Le("agb","mr5",{bold:e.count>=100,mytopics:e.author===s,pinned:e.pinned}),dangerouslySetInnerHTML:{__html:n},style:{overflowWrap:"anywhere"}}),e.isVoting&&t.jsx("span",{className:"agh separator",children:"[±]"}),t.jsx(Dn,{count:e.count,topicId:e.id}),e.closed&&t.jsx("span",{className:"agh",children:"Ø"}),e.down&&t.jsx("span",{className:"agh",children:"↓"}),e.section&&t.jsxs("span",{className:"topic-section",children:[t.jsx("span",{className:"agh",style:{margin:"0px 5px"},children:"/"}),t.jsx(I,{rel:"nofollow",className:"agh",to:`/index.php?section=${e.sectionCode}`,children:e.section},"1")]})]})})},An=({item:e,isFetching:s})=>{const[n,r]=h.useState();h.useEffect(()=>{s&&r(void 0)},[s]);const o=()=>{r(n===void 0?0:void 0)},i=()=>{n===void 0||n!==e.count?r(e.count):r(void 0)};return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"topics-list-row",children:[t.jsx(Mn,{item:e}),t.jsx("div",{className:"cell-section",children:e.section}),t.jsx(In,{item:e,onClick:i}),t.jsx(En,{expanded:n!==void 0,onClick:o}),t.jsx(Fn,{data:e}),t.jsx(Pn,{item:e}),t.jsx(_n,{item:e}),t.jsx(Rn,{item:e})]}),n!==void 0&&t.jsx(Ln,{topicId:e.id,initialMsgNumber:n,author:e.author,close:()=>r(void 0)})]})},Vn=({isLoading:e,onUpdateClick:s})=>t.jsxs("div",{className:"table-header",children:[t.jsx("div",{style:{letterSpacing:"-1px"},children:"Раздел"}),t.jsx("div",{}),t.jsx("div",{children:"Тема"}),t.jsx("div",{children:"Re"}),t.jsx("div",{children:"Автор"}),t.jsx("div",{children:t.jsx("span",{style:{cursor:"pointer"},title:"Обновить список",onClick:s,children:e?"Обновляется":"Обновлено"})})]}),Ce=()=>{const[e]=B(),{isFetching:s,data:n,error:r,refetch:o}=Ue({searchParams:e});return h.useEffect(()=>{document.title="React.Mista"},[]),h.useEffect(()=>{window.scrollTo(0,0)},[e]),t.jsxs("div",{children:[t.jsx(Cn,{}),r&&t.jsx(ue,{text:r.message}),t.jsxs("div",{className:"topic-list-table",children:[t.jsx(Vn,{onUpdateClick:o,isLoading:s}),(n??[]).map(i=>t.jsx(An,{item:i,isFetching:s},i.id)),t.jsx("div",{className:"table-footer",children:t.jsx(We,{maxPage:10})})]}),t.jsx("div",{id:"F",className:"newtopic",style:{marginBottom:"10px",marginTop:"5px",position:"relative"},children:t.jsx(Sn,{onSubmitSuccess:o})})]})},Bn=()=>t.jsx(wt,{children:t.jsxs(bt,{children:[t.jsx(te,{path:"/",element:t.jsx(Ce,{})}),t.jsx(te,{path:"/index.php",element:t.jsx(Ce,{})}),t.jsx(te,{path:"/topic.php",element:t.jsx(kn,{})}),t.jsx(te,{path:"/options.php",element:t.jsx(gn,{})})]})}),Un=()=>{const e=C(s=>s.options.items.theme);return h.useLayoutEffect(()=>{document.body.setAttribute("data-theme",e)},[e]),t.jsxs(Nt,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:[t.jsx(Ss,{}),t.jsx(Bn,{}),t.jsx($s,{}),t.jsx(ln,{})]})},Hn=new Tt({defaultOptions:{queries:{retry:!1,retryOnMount:!1,refetchOnWindowFocus:!1,throwOnError:e=>(e.name!=="AbortError"&&console.log(e.message),!1)}}}),zn=({store:e})=>t.jsx(Ct,{client:Hn,children:t.jsx(St,{store:e,children:t.jsx($t,{loading:null,persistor:Ts,children:t.jsx(Un,{})})})}),Yn=document.getElementById("root"),Wn=kt.createRoot(Yn);Wn.render(t.jsx(zn,{store:Ve}));
